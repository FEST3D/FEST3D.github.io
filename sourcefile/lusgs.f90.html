<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="">
    
    <meta name="author" content="FEST-3D Team" >
    <link rel="icon" href="../favicon.png">

    <title>lusgs.f90 &ndash; FEST-3D</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140495700-1"></script>
   <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
   
     gtag('config', 'UA-140495700-1');
   </script>


  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">FEST-3D </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Documentation</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/main.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/main.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>lusgs.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="14.3% of total for source files.">2229 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/lusgs.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">lusgs.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/lusgs.html">lusgs</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/lusgs.f90.html#src">lusgs.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      <p>Matix-free time integration: LU-SGS</p>
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~lusgs.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilelusgsf90EfferentGraph" width="391pt" height="366pt"
 viewBox="0.00 0.00 391.00 366.35" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~lusgs.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 362.3528)">
<title>sourcefile~~lusgs.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-362.3528 387,-362.3528 387,4 -4,4"/>
<!-- sourcefile~lusgs.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~lusgs.f90</title>
<polygon fill="none" stroke="#000000" points="383,-192.3941 328,-192.3941 328,-168.3941 383,-168.3941 383,-192.3941"/>
<text text-anchor="middle" x="355.5" y="-177.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">lusgs.f90</text>
</g>
<!-- sourcefile~global_sa.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~global_sa.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/global_sa.f90.html" xlink:title="global_sa.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="184.5,-336.3941 108.5,-336.3941 108.5,-312.3941 184.5,-312.3941 184.5,-336.3941"/>
<text text-anchor="middle" x="146.5" y="-321.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_sa.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~global_sa.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~global_sa.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-324.3941C237.6544,-332.3315 214.7503,-333.5098 194.8251,-332.2457"/>
<polygon fill="#ff0000" stroke="#ff0000" points="194.9725,-328.7457 184.7117,-331.3849 194.3788,-335.7204 194.9725,-328.7457"/>
</g>
<!-- sourcefile~gradients.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~gradients.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/gradients.f90.html" xlink:title="gradients.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="184,-252.3941 109,-252.3941 109,-228.3941 184,-228.3941 184,-252.3941"/>
<text text-anchor="middle" x="146.5" y="-237.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">gradients.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~gradients.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~gradients.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M352.1695,-192.456C343.0516,-222.663 314.4455,-300.8245 257,-324.3941"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-324.3941C217.9703,-340.4079 220.646,-285.465 186,-261.3941 184.1344,-260.098 182.1794,-258.8238 180.1798,-257.5836"/>
<polygon fill="#ff0000" stroke="#ff0000" points="181.6708,-254.4019 171.2668,-252.4003 178.1518,-260.4531 181.6708,-254.4019"/>
</g>
<!-- sourcefile~viscosity.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~viscosity.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/viscosity.f90.html" xlink:title="viscosity.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="292,-192.3941 222,-192.3941 222,-168.3941 292,-168.3941 292,-192.3941"/>
<text text-anchor="middle" x="257" y="-177.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">viscosity.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~viscosity.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~viscosity.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M327.8001,-180.3941C319.8659,-180.3941 311.0021,-180.3941 302.3035,-180.3941"/>
<polygon fill="#ff0000" stroke="#ff0000" points="302.2337,-176.8942 292.2337,-180.3941 302.2336,-183.8942 302.2337,-176.8942"/>
</g>
<!-- sourcefile~wall_dist.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~wall_dist.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/wall_dist.f90.html" xlink:title="wall_dist.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="182,-294.3941 111,-294.3941 111,-270.3941 182,-270.3941 182,-294.3941"/>
<text text-anchor="middle" x="146.5" y="-279.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">wall_dist.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~wall_dist.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~wall_dist.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-324.3941C249.6971,-327.3905 211.2626,-311.6162 181.7526,-298.5504"/>
<polygon fill="#ff0000" stroke="#ff0000" points="183.0936,-295.3162 172.5358,-294.4307 180.2371,-301.7068 183.0936,-295.3162"/>
</g>
<!-- sourcefile~global_kkl.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~global_kkl.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/global_kkl.f90.html" xlink:title="global_kkl.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185.5,-92.3941 107.5,-92.3941 107.5,-68.3941 185.5,-68.3941 185.5,-92.3941"/>
<text text-anchor="middle" x="146.5" y="-77.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_kkl.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~global_kkl.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~global_kkl.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-38.3941C249.9542,-34.7336 211.0479,-50.8463 181.375,-64.164"/>
<polygon fill="#ff0000" stroke="#ff0000" points="179.78,-61.0442 172.1175,-68.3611 182.6705,-67.4196 179.78,-61.0442"/>
</g>
<!-- sourcefile~utils.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~utils.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/utils.f90.html" xlink:title="utils.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="62.5,-273.3941 8.5,-273.3941 8.5,-249.3941 62.5,-249.3941 62.5,-273.3941"/>
<text text-anchor="middle" x="35.5" y="-258.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">utils.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-324.3941C194.7215,-349.9468 168.1097,-373.6281 107,-345.3941 79.0846,-332.4966 58.0587,-302.7316 46.262,-282.3327"/>
<polygon fill="#ff0000" stroke="#ff0000" points="49.2565,-280.5148 41.361,-273.4499 43.1274,-283.8965 49.2565,-280.5148"/>
</g>
<!-- sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~vartypes.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/vartypes.f90.html" xlink:title="vartypes.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-172.3941 0,-172.3941 0,-148.3941 71,-148.3941 71,-172.3941"/>
<text text-anchor="middle" x="35.5" y="-157.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">vartypes.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M351.5322,-168.2657C341.3158,-139.3103 311.0476,-66.4737 257,-38.3941"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-38.3941C197.264,-7.3593 164.2631,17.9964 107,-17.3941 63.937,-44.0085 45.9424,-105.2821 39.1542,-138.3218"/>
<polygon fill="#ff0000" stroke="#ff0000" points="35.6763,-137.8778 37.2617,-148.3534 42.555,-139.1756 35.6763,-137.8778"/>
</g>
<!-- sourcefile~global_sst.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~global_sst.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/global_sst.f90.html" xlink:title="global_sst.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="186,-50.3941 107,-50.3941 107,-26.3941 186,-26.3941 186,-50.3941"/>
<text text-anchor="middle" x="146.5" y="-35.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_sst.f90</text>
</a>
</g>
</g>
<!-- sourcefile~lusgs.f90&#45;&gt;sourcefile~global_sst.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~lusgs.f90&#45;&gt;sourcefile~global_sst.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-38.3941C238.6617,-28.8668 216.1908,-27.3575 196.3124,-28.8054"/>
<polygon fill="#ff0000" stroke="#ff0000" points="195.7967,-25.3392 186.1892,-29.8052 196.4848,-32.3053 195.7967,-25.3392"/>
</g>
<!-- sourcefile~gradients.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~gradients.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#ffbf00" stroke-dasharray="5,2" d="M108.9205,-247.5038C97.1484,-249.7309 84.1713,-252.1861 72.4435,-254.4048"/>
<polygon fill="#ffbf00" stroke="#ffbf00" points="71.6956,-250.9841 62.5206,-256.2821 72.9969,-257.8621 71.6956,-250.9841"/>
</g>
<!-- sourcefile~gradients.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~gradients.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ffbf00" stroke-dasharray="5,2" d="M129.6415,-228.2439C111.1983,-214.9514 81.453,-193.5134 60.3376,-178.2951"/>
<polygon fill="#ffbf00" stroke="#ffbf00" points="62.3125,-175.4042 52.1535,-172.3966 58.2196,-181.083 62.3125,-175.4042"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sa.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sa.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M252.5783,-192.6962C243.4402,-216.6626 220.4079,-270.1656 186,-303.3941 184.9176,-304.4395 183.7727,-305.4468 182.5811,-306.416"/>
<polygon fill="#7fff00" stroke="#7fff00" points="180.4061,-303.6658 174.2042,-312.2557 184.4092,-309.4082 180.4061,-303.6658"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~gradients.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~gradients.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M234.6387,-192.536C218.3132,-201.4006 195.9641,-213.5358 177.8563,-223.3681"/>
<polygon fill="#7fff00" stroke="#7fff00" points="175.946,-220.4226 168.8281,-228.2703 179.2863,-226.5743 175.946,-220.4226"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~wall_dist.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~wall_dist.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M248.5098,-192.6149C236.2261,-209.6401 212.0932,-240.7273 186,-261.3941 184.4475,-262.6238 182.8124,-263.8168 181.1265,-264.9683"/>
<polygon fill="#7fff00" stroke="#7fff00" points="179.0818,-262.1177 172.4214,-270.3573 182.7663,-268.0695 179.0818,-262.1177"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_kkl.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_kkl.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M246.9153,-168.3156C233.7758,-152.9651 209.6746,-126.0978 186,-106.3941 182.6634,-103.6172 179.0201,-100.8782 175.339,-98.28"/>
<polygon fill="#7fff00" stroke="#7fff00" points="177.0546,-95.2153 166.808,-92.5212 173.1381,-101.0171 177.0546,-95.2153"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M221.86,-186.6629C190.8829,-192.8559 144.9097,-203.6896 107,-219.3941 91.2225,-225.9301 74.7145,-235.4271 61.5406,-243.7375"/>
<polygon fill="#7fff00" stroke="#7fff00" points="59.5053,-240.8855 53.0029,-249.2503 63.3024,-246.7661 59.5053,-240.8855"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M241.7144,-168.3652C228.0101,-158.3987 206.8982,-144.9948 186,-139.3941 150.3993,-129.8533 108.8332,-136.9802 78.4154,-145.4241"/>
<polygon fill="#7fff00" stroke="#7fff00" points="77.1632,-142.1438 68.5519,-148.316 79.1327,-148.8611 77.1632,-142.1438"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sst.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sst.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M252.5251,-168.2947C243.2939,-144.7224 220.1059,-92.0969 186,-59.3941 184.9139,-58.3527 183.7659,-57.3486 182.5716,-56.3821"/>
<polygon fill="#7fff00" stroke="#7fff00" points="184.393,-53.3858 174.1837,-50.5539 180.3987,-59.1343 184.393,-53.3858"/>
</g>
<!-- sourcefile~copy_bc.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~copy_bc.f90</title>
<g id="a_sourcefile~~lusgs.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/copy_bc.f90.html" xlink:title="copy_bc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="181.5,-172.3941 111.5,-172.3941 111.5,-148.3941 181.5,-148.3941 181.5,-172.3941"/>
<text text-anchor="middle" x="146.5" y="-157.9941" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">copy_bc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~copy_bc.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~copy_bc.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M221.7333,-174.011C212.264,-172.2971 201.8897,-170.4194 191.9522,-168.6208"/>
<polygon fill="#7fff00" stroke="#7fff00" points="192.2742,-165.1223 181.8107,-166.7852 191.0274,-172.0104 192.2742,-165.1223"/>
</g>
<!-- sourcefile~wall_dist.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~wall_dist.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#00ff3f" stroke-dasharray="5,2" d="M110.7679,-275.634C98.5877,-273.3297 84.9464,-270.7489 72.657,-268.4238"/>
<polygon fill="#00ff3f" stroke="#00ff3f" points="73.19,-264.9627 62.7136,-266.5427 71.8887,-271.8407 73.19,-264.9627"/>
</g>
<!-- sourcefile~wall_dist.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~wall_dist.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#00ff3f" stroke-dasharray="5,2" d="M119.4685,-270.217C115.0657,-267.6325 110.7313,-264.6781 107,-261.3941 80.7293,-238.2734 58.9417,-203.6829 46.5686,-181.5805"/>
<polygon fill="#00ff3f" stroke="#00ff3f" points="49.5689,-179.7718 41.71,-172.6663 43.4225,-183.1218 49.5689,-179.7718"/>
</g>
<!-- sourcefile~copy_bc.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~lusgs.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~copy_bc.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M111.3789,-160.3941C101.8567,-160.3941 91.405,-160.3941 81.3847,-160.3941"/>
<polygon fill="#ff0000" stroke="#ff0000" points="81.1556,-156.8942 71.1556,-160.3941 81.1555,-163.8942 81.1556,-156.8942"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~lusgs.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilelusgsf90AfferentGraph" width="348pt" height="32pt"
 viewBox="0.00 0.00 348.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~lusgs.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~lusgs.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 344,-28 344,4 -4,4"/>
<!-- sourcefile~lusgs.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~lusgs.f90</title>
<polygon fill="none" stroke="#000000" points="55,-24 0,-24 0,0 55,0 55,-24"/>
<text text-anchor="middle" x="27.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">lusgs.f90</text>
</g>
<!-- sourcefile~update.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~update.f90</title>
<g id="a_sourcefile~~lusgs.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/update.f90.html" xlink:title="update.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="155,-24 91,-24 91,0 155,0 155,-24"/>
<text text-anchor="middle" x="123" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">update.f90</text>
</a>
</g>
</g>
<!-- sourcefile~update.f90&#45;&gt;sourcefile~lusgs.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~update.f90&#45;&gt;sourcefile~lusgs.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M90.9342,-12C82.6902,-12 73.7444,-12 65.242,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="65.1677,-8.5001 55.1676,-12 65.1676,-15.5001 65.1677,-8.5001"/>
</g>
<!-- sourcefile~solver.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~solver.f90</title>
<g id="a_sourcefile~~lusgs.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/solver.f90.html" xlink:title="solver.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="250,-24 191,-24 191,0 250,0 250,-24"/>
<text text-anchor="middle" x="220.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">solver.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~update.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~update.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M190.9822,-12C182.8447,-12 173.8557,-12 165.1525,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="165.1352,-8.5001 155.1352,-12 165.1351,-15.5001 165.1352,-8.5001"/>
</g>
<!-- sourcefile~main.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~main.f90</title>
<g id="a_sourcefile~~lusgs.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/main.f90.html" xlink:title="main.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="340,-24 286,-24 286,0 340,0 340,-24"/>
<text text-anchor="middle" x="313" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">main.f90</text>
</a>
</g>
</g>
<!-- sourcefile~main.f90&#45;&gt;sourcefile~solver.f90 -->
<g id="sourcefile~~lusgs.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~main.f90&#45;&gt;sourcefile~solver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M285.7472,-12C277.791,-12 268.9269,-12 260.361,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="260.1413,-8.5001 250.1413,-12 260.1413,-15.5001 260.1413,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/lusgs.html">lusgs</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/lusgs.f90.html#src">lusgs.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a>  <span class="c">!&lt; Matix-free time integration: LU-SGS</span>
<a name="ln-2"></a><span class="k">module </span><span class="n">lusgs</span>
<a name="ln-3"></a>  <span class="c">!&lt; </span>
<a name="ln-4"></a>  <span class="c">!&lt; Reference: Sharov, D., Luo, H., Baum, J., and Loehner, R., </span>
<a name="ln-5"></a>  <span class="c">!&lt; “Implementation of unstructured grid GMRES+LU-SGS method on </span>
<a name="ln-6"></a>  <span class="c">!&lt; shared-memory, cache-based parallel computers,” </span>
<a name="ln-7"></a>  <span class="c">!&lt; 38th Aerospace Sciences Meeting and Exhibit, vol. 927, 2000, p. 2000.</span>
<a name="ln-8"></a>  <span class="k">use </span><span class="n">vartypes</span>
<a name="ln-9"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cphi1</span>
<a name="ln-10"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cphi2</span>
<a name="ln-11"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">fphi</span>
<a name="ln-12"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">eta</span>
<a name="ln-13"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cd1</span>
<a name="ln-14"></a>  <span class="k">use </span><span class="n">global_kkl</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cmu</span>
<a name="ln-15"></a>  <span class="k">use </span><span class="n">global_sst</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">beta1</span>
<a name="ln-16"></a>  <span class="k">use </span><span class="n">global_sst</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">beta2</span>
<a name="ln-17"></a>  <span class="k">use </span><span class="n">global_sst</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">bstar</span>
<a name="ln-18"></a>  <span class="k">use </span><span class="n">global_sst</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sst_F1</span>
<a name="ln-19"></a>  <span class="k">use </span><span class="n">global_sa</span>  <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_sa</span>
<a name="ln-20"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cb1</span>
<a name="ln-21"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cb2</span>
<a name="ln-22"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw1</span>
<a name="ln-23"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw2</span>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw3</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cv1</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_sa</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kappa_sa</span>
<a name="ln-28"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cv1_3</span>
<a name="ln-29"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw3_6</span>
<a name="ln-30"></a>
<a name="ln-31"></a>  <span class="k">use </span><span class="n">wall_dist</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">dist</span>
<a name="ln-32"></a>  <span class="k">use </span><span class="n">viscosity</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">mu</span>
<a name="ln-33"></a>  <span class="k">use </span><span class="n">viscosity</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">mu_t</span>
<a name="ln-34"></a>
<a name="ln-35"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradu_x</span>
<a name="ln-36"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradu_y</span>
<a name="ln-37"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradu_z</span>
<a name="ln-38"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradv_x</span>
<a name="ln-39"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradv_y</span>
<a name="ln-40"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradv_z</span>
<a name="ln-41"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradw_x</span>
<a name="ln-42"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradw_y</span>
<a name="ln-43"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">gradw_z</span>
<a name="ln-44"></a>
<a name="ln-45"></a>  <span class="k">use </span><span class="n">utils</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">alloc</span>
<a name="ln-46"></a>
<a name="ln-47"></a>  <span class="c">!--- sst implicit update ---!</span>
<a name="ln-48"></a>  <span class="k">use </span><span class="n">global_sst</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sst_F1</span>
<a name="ln-49"></a>  <span class="k">use </span><span class="n">global_sst</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k1</span>
<a name="ln-50"></a>  <span class="k">use </span><span class="n">global_sst</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k2</span>
<a name="ln-51"></a>  <span class="k">use </span><span class="n">global_sst</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_w1</span>
<a name="ln-52"></a>  <span class="k">use </span><span class="n">global_sst</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_w2</span>
<a name="ln-53"></a>  
<a name="ln-54"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k</span>
<a name="ln-55"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_phi</span>
<a name="ln-56"></a>
<a name="ln-57"></a>
<a name="ln-58"></a>
<a name="ln-59"></a><span class="cp">#include &quot;debug.h&quot;</span>
<a name="ln-60"></a><span class="cp">#include &quot;error.h&quot;</span>
<a name="ln-61"></a>
<a name="ln-62"></a>
<a name="ln-63"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">delQ</span>
<a name="ln-64"></a>  <span class="c">!&lt; change of state variable (solution) over one time-step</span>
<a name="ln-65"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">delQstar</span>
<a name="ln-66"></a>  <span class="c">!&lt; Intermediate change of state variable over one time-step</span>
<a name="ln-67"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">dummy</span>
<a name="ln-68"></a>  <span class="c">!&lt; dummy variable</span>
<a name="ln-69"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-70"></a>  <span class="c">!&lt; Pionter to turbulent viscosity</span>
<a name="ln-71"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-72"></a>  <span class="c">!&lt; Pointer to molecular viscosity</span>
<a name="ln-73"></a>        
<a name="ln-74"></a>
<a name="ln-75"></a>  <span class="kt">integer</span> <span class="kd">::</span> <span class="n">imx</span><span class="p">,</span> <span class="n">jmx</span><span class="p">,</span> <span class="n">kmx</span><span class="p">,</span> <span class="n">n_var</span>
<a name="ln-76"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gm</span><span class="p">,</span> <span class="n">mu_ref</span><span class="p">,</span> <span class="n">Reynolds_number</span><span class="p">,</span> <span class="n">free_stream_tu</span>
<a name="ln-77"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk_inf</span>
<a name="ln-78"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tkl_inf</span>
<a name="ln-79"></a>  <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tPr</span><span class="p">,</span> <span class="n">Pr</span><span class="p">,</span> <span class="n">R_gas</span>
<a name="ln-80"></a>
<a name="ln-81"></a>  <span class="k">public</span> <span class="kd">::</span> <span class="n">update_with_lusgs</span>
<a name="ln-82"></a>  <span class="k">public</span> <span class="kd">::</span> <span class="n">setup_lusgs</span>
<a name="ln-83"></a>
<a name="ln-84"></a>  <span class="k">contains</span>
<a name="ln-85"></a>
<a name="ln-86"></a><span class="k">    subroutine </span><span class="n">setup_lusgs</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-87"></a>      <span class="c">!&lt; allocate array memory for data communication</span>
<a name="ln-88"></a>      <span class="k">implicit none</span>
<a name="ln-89"></a><span class="k">      type</span><span class="p">(</span><span class="n">controltype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">control</span>
<a name="ln-90"></a>      <span class="c">!&lt; Control parameters</span>
<a name="ln-91"></a>      <span class="k">type</span><span class="p">(</span><span class="n">schemetype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">scheme</span>
<a name="ln-92"></a>      <span class="c">!&lt; finite-volume Schemes</span>
<a name="ln-93"></a>      <span class="k">type</span><span class="p">(</span><span class="n">flowtype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flow</span>
<a name="ln-94"></a>      <span class="c">!&lt; Information about fluid flow: freestream-speed, ref-viscosity,etc.</span>
<a name="ln-95"></a>      <span class="k">type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-96"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-97"></a>      <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">errmsg</span><span class="o">=</span><span class="s2">&quot;module: LUSGS, subrouinte setup&quot;</span>
<a name="ln-98"></a>      <span class="c">!&lt; Error message</span>
<a name="ln-99"></a>
<a name="ln-100"></a>      <span class="n">imx</span> <span class="o">=</span> <span class="n">dims</span><span class="p">%</span><span class="n">imx</span>
<a name="ln-101"></a>      <span class="n">jmx</span> <span class="o">=</span> <span class="n">dims</span><span class="p">%</span><span class="n">jmx</span>
<a name="ln-102"></a>      <span class="n">kmx</span> <span class="o">=</span> <span class="n">dims</span><span class="p">%</span><span class="n">kmx</span>
<a name="ln-103"></a>      <span class="n">n_var</span> <span class="o">=</span> <span class="n">control</span><span class="p">%</span><span class="n">n_var</span>
<a name="ln-104"></a>      <span class="n">gm</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">gm</span>
<a name="ln-105"></a>      <span class="n">mu_ref</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">mu_ref</span>
<a name="ln-106"></a>      <span class="n">Reynolds_number</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">Reynolds_number</span>
<a name="ln-107"></a>      <span class="n">free_stream_tu</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tu_inf</span>
<a name="ln-108"></a>      <span class="n">tk_inf</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tk_inf</span>
<a name="ln-109"></a>      <span class="n">tkl_inf</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tkl_inf</span>
<a name="ln-110"></a>      <span class="n">tpr</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tpr</span>
<a name="ln-111"></a>      <span class="n">pr</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">pr</span>
<a name="ln-112"></a>      <span class="n">R_gas</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">R_gas</span>
<a name="ln-113"></a>
<a name="ln-114"></a>      <span class="k">call </span><span class="n">alloc</span><span class="p">(</span><span class="n">delQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jmx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kmx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_var</span><span class="p">)</span>
<a name="ln-115"></a>      <span class="k">call </span><span class="n">alloc</span><span class="p">(</span><span class="n">delQstar</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jmx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kmx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_var</span><span class="p">)</span>
<a name="ln-116"></a>
<a name="ln-117"></a>      <span class="k">if</span><span class="p">(</span><span class="n">mu_ref</span><span class="o">==</span><span class="mf">0.0</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-118"></a><span class="k">        call </span><span class="n">alloc</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jmx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kmx</span><span class="p">)</span>
<a name="ln-119"></a>        <span class="n">dummy</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-120"></a>      <span class="k">end if</span>
<a name="ln-121"></a><span class="k">      if</span><span class="p">(</span><span class="n">mu_ref</span><span class="o">==</span><span class="mf">0.0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-122"></a><span class="k">        </span><span class="n">mmu</span> <span class="o">=&gt;</span> <span class="n">dummy</span>
<a name="ln-123"></a>      <span class="k">else</span>
<a name="ln-124"></a><span class="k">        </span><span class="n">mmu</span> <span class="o">=&gt;</span> <span class="n">mu</span>
<a name="ln-125"></a>      <span class="k">end if</span>
<a name="ln-126"></a><span class="k">      if</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;none&#39;</span><span class="p">)</span><span class="k">then</span>
<a name="ln-127"></a><span class="k">        </span><span class="n">tmu</span> <span class="o">=&gt;</span> <span class="n">dummy</span>
<a name="ln-128"></a>      <span class="k">else</span>
<a name="ln-129"></a><span class="k">        </span><span class="n">tmu</span> <span class="o">=&gt;</span> <span class="n">mu_t</span>
<a name="ln-130"></a>      <span class="k">end if</span>
<a name="ln-131"></a><span class="k">    end subroutine </span><span class="n">setup_lusgs</span>
<a name="ln-132"></a>
<a name="ln-133"></a>
<a name="ln-134"></a>    <span class="k">subroutine </span><span class="n">update_with_lusgs</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-135"></a>      <span class="c">!&lt; Time-integrate with LU_SGS method</span>
<a name="ln-136"></a>      <span class="k">implicit none</span>
<a name="ln-137"></a><span class="k">      type</span><span class="p">(</span><span class="n">schemetype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">scheme</span>
<a name="ln-138"></a>      <span class="c">!&lt; finite-volume Schemes</span>
<a name="ln-139"></a>      <span class="k">type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-140"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-141"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-142"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-143"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-144"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-145"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-146"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-147"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-148"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-149"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-150"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-151"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-152"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-153"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-154"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-155"></a>
<a name="ln-156"></a>      <span class="n">DebugCall</span><span class="p">(</span><span class="s2">&quot;Update_with_lusgs&quot;</span><span class="p">)</span>
<a name="ln-157"></a>      <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="p">))</span>
<a name="ln-158"></a>        <span class="k">case</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a name="ln-159"></a>          <span class="k">call </span><span class="n">update_laminar_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-160"></a>
<a name="ln-161"></a>        <span class="k">case</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;sst2003&#39;</span><span class="p">)</span>
<a name="ln-162"></a>          <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">transition</span><span class="p">))</span>
<a name="ln-163"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;bc&#39;</span><span class="p">)</span>
<a name="ln-164"></a>              <span class="k">call </span><span class="n">update_SST_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-165"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;lctm2015&#39;</span><span class="p">)</span>
<a name="ln-166"></a>              <span class="k">call </span><span class="n">update_lctm2015</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-167"></a>            <span class="k">case </span><span class="n">DEFAULT</span>
<a name="ln-168"></a>              <span class="n">Fatal_error</span>
<a name="ln-169"></a>          <span class="k">end select</span>
<a name="ln-170"></a>
<a name="ln-171"></a><span class="k">        case</span><span class="p">(</span><span class="s1">&#39;kkl&#39;</span><span class="p">)</span>
<a name="ln-172"></a>          <span class="k">call </span><span class="n">update_KKL_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-173"></a>
<a name="ln-174"></a>        <span class="k">case</span><span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">,</span> <span class="s1">&#39;saBC&#39;</span><span class="p">)</span>
<a name="ln-175"></a>          <span class="k">call </span><span class="n">update_SA_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-176"></a>
<a name="ln-177"></a>        <span class="k">case </span><span class="n">Default</span>
<a name="ln-178"></a>          <span class="n">Fatal_error</span>
<a name="ln-179"></a>
<a name="ln-180"></a>      <span class="k">end select</span>
<a name="ln-181"></a>
<a name="ln-182"></a>
<a name="ln-183"></a><span class="k">    end subroutine </span><span class="n">update_with_lusgs</span>
<a name="ln-184"></a>
<a name="ln-185"></a>
<a name="ln-186"></a>    <span class="k">subroutine </span><span class="n">update_laminar_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span><span class="n">residue</span><span class="p">,</span><span class="n">delta_t</span><span class="p">,</span><span class="n">cells</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
<a name="ln-187"></a>      <span class="c">!&lt; Update laminar flow with LU-SGS scheme</span>
<a name="ln-188"></a>      <span class="k">implicit none</span>
<a name="ln-189"></a><span class="k">      </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-190"></a>      <span class="k">type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-191"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-192"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-193"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-194"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-195"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-196"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-197"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-198"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-199"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-200"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-201"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-202"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-203"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-204"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-205"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-206"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">deltaU</span>
<a name="ln-207"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">D</span>
<a name="ln-208"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">conservativeQ</span>
<a name="ln-209"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldIminusFlux</span>
<a name="ln-210"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldJminusFlux</span>
<a name="ln-211"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldKminusFlux</span>
<a name="ln-212"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewIminusFlux</span>
<a name="ln-213"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewJminusFlux</span>
<a name="ln-214"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewKminusFlux</span>
<a name="ln-215"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelIminusFlux</span>
<a name="ln-216"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelJminusFlux</span>
<a name="ln-217"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelKminusFlux</span>
<a name="ln-218"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">LambdaTimesArea</span>
<a name="ln-219"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q0</span> <span class="c">! state at cell</span>
<a name="ln-220"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q1</span> <span class="c">! state at neighbours </span>
<a name="ln-221"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q2</span>
<a name="ln-222"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q3</span>
<a name="ln-223"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q4</span>
<a name="ln-224"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q5</span>
<a name="ln-225"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q6</span>
<a name="ln-226"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ0</span><span class="c">! change in state</span>
<a name="ln-227"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ1</span>
<a name="ln-228"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ2</span>
<a name="ln-229"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ3</span>
<a name="ln-230"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ4</span>
<a name="ln-231"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ5</span>
<a name="ln-232"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ6</span>
<a name="ln-233"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist1</span>
<a name="ln-234"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist2</span>
<a name="ln-235"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist3</span>
<a name="ln-236"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist4</span>
<a name="ln-237"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist5</span>
<a name="ln-238"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist6</span>
<a name="ln-239"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C0</span>
<a name="ln-240"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C1</span>
<a name="ln-241"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C2</span>
<a name="ln-242"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C3</span>
<a name="ln-243"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C4</span>
<a name="ln-244"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C5</span>
<a name="ln-245"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C6</span>
<a name="ln-246"></a>
<a name="ln-247"></a>
<a name="ln-248"></a>
<a name="ln-249"></a>        <span class="n">DebugCall</span><span class="p">(</span><span class="s2">&quot;Update_with_lusgs&quot;</span><span class="p">)</span>
<a name="ln-250"></a>        <span class="c">!intialize delQ</span>
<a name="ln-251"></a>        <span class="n">delQstar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-252"></a>
<a name="ln-253"></a>        <span class="c">!forward sweep</span>
<a name="ln-254"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-255"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-256"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-257"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-258"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-259"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-260"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-261"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-262"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-263"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-264"></a>
<a name="ln-265"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-266"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-267"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-268"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-269"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-270"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-271"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-272"></a>
<a name="ln-273"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-274"></a>              <span class="n">DQ1</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-275"></a>              <span class="n">DQ2</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-276"></a>              <span class="n">DQ3</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-277"></a>
<a name="ln-278"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-279"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-280"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-281"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-282"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-283"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-284"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-285"></a>
<a name="ln-286"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-287"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-288"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-289"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-290"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-291"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-292"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-293"></a>
<a name="ln-294"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-295"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-296"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-297"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-298"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-299"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-300"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-301"></a>
<a name="ln-302"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-303"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-304"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-305"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-306"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-307"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-308"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-309"></a>
<a name="ln-310"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-311"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-312"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-313"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-314"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-315"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-316"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-317"></a>
<a name="ln-318"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-319"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-320"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-321"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-322"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-323"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-324"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-325"></a>
<a name="ln-326"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ1</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-327"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ2</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-328"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ3</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-329"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-330"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-331"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-332"></a>
<a name="ln-333"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-334"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-335"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-336"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-337"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-338"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-339"></a>
<a name="ln-340"></a>
<a name="ln-341"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-342"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-343"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-344"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-345"></a>
<a name="ln-346"></a>
<a name="ln-347"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-348"></a>              <span class="c">!storing D in Iflux array for backward sweep</span>
<a name="ln-349"></a>              <span class="c">!F_p(i,j,k,1) = D</span>
<a name="ln-350"></a>
<a name="ln-351"></a>              <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-352"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-353"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-354"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-355"></a>
<a name="ln-356"></a>              <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-357"></a>            <span class="k">end do</span>
<a name="ln-358"></a><span class="k">          end do</span>
<a name="ln-359"></a><span class="k">        end do</span>
<a name="ln-360"></a>
<a name="ln-361"></a><span class="k">        </span><span class="n">delQ</span><span class="o">=</span><span class="mf">0.0</span>
<a name="ln-362"></a>        <span class="c">!backward sweep</span>
<a name="ln-363"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-364"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-365"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-366"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-367"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-368"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-369"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-370"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-371"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-372"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-373"></a>
<a name="ln-374"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-375"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-376"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-377"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-378"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-379"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-380"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-381"></a>
<a name="ln-382"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-383"></a>              <span class="n">DQ4</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-384"></a>              <span class="n">DQ5</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-385"></a>              <span class="n">DQ6</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-386"></a>
<a name="ln-387"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-388"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-389"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-390"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-391"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-392"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-393"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-394"></a>
<a name="ln-395"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-396"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-397"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-398"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-399"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-400"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-401"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-402"></a>
<a name="ln-403"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-404"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-405"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-406"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-407"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-408"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-409"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-410"></a>
<a name="ln-411"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-412"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-413"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-414"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-415"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-416"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-417"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-418"></a>
<a name="ln-419"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-420"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-421"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-422"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-423"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-424"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-425"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-426"></a>
<a name="ln-427"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-428"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-429"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-430"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-431"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-432"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-433"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-434"></a>
<a name="ln-435"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ4</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-436"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ5</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-437"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ6</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-438"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-439"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-440"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-441"></a>
<a name="ln-442"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-443"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-444"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-445"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-446"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-447"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-448"></a>
<a name="ln-449"></a>
<a name="ln-450"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-451"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-452"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-453"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-454"></a>
<a name="ln-455"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-456"></a>
<a name="ln-457"></a>              <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-458"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-459"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-460"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-461"></a>
<a name="ln-462"></a>            <span class="k">end do</span>
<a name="ln-463"></a><span class="k">          end do</span>
<a name="ln-464"></a><span class="k">        end do</span>
<a name="ln-465"></a><span class="k">        </span>
<a name="ln-466"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-467"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-468"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-469"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-470"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-471"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-472"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-473"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-474"></a>              
<a name="ln-475"></a>              <span class="c">! add new change into conservative solution</span>
<a name="ln-476"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-477"></a>
<a name="ln-478"></a>              <span class="c">! convert back conservative to primitive</span>
<a name="ln-479"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-480"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-481"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-482"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-483"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-484"></a>            <span class="k">end do</span>
<a name="ln-485"></a><span class="k">          end do</span>
<a name="ln-486"></a><span class="k">        end do</span>
<a name="ln-487"></a>
<a name="ln-488"></a><span class="k">    end subroutine </span><span class="n">update_laminar_variables</span>
<a name="ln-489"></a>
<a name="ln-490"></a>
<a name="ln-491"></a>    <span class="k">function </span><span class="n">Flux</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a name="ln-492"></a>      <span class="c">!&lt; calculate the total flux through face for laminar flow.</span>
<a name="ln-493"></a>      <span class="c">!---------------------------------------</span>
<a name="ln-494"></a>      <span class="k">implicit none</span>
<a name="ln-495"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span> <span class="c">!left state</span>
<a name="ln-496"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span> <span class="c">!right state</span>
<a name="ln-497"></a>      <span class="c">!conservative form of updated neighbour</span>
<a name="ln-498"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">du</span>
<a name="ln-499"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-500"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">Flux</span>
<a name="ln-501"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">U</span> <span class="c">! conservative variables</span>
<a name="ln-502"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">W</span> <span class="c">! new primitive variables</span>
<a name="ln-503"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">P</span> <span class="c">! primitive variables of right cell</span>
<a name="ln-504"></a>
<a name="ln-505"></a>      <span class="c">!for extraction of the inputs</span>
<a name="ln-506"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">area</span>
<a name="ln-507"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-508"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-509"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-510"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-511"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-512"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-513"></a>
<a name="ln-514"></a>
<a name="ln-515"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudx</span>
<a name="ln-516"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudy</span>
<a name="ln-517"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudz</span>
<a name="ln-518"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdx</span>
<a name="ln-519"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-520"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdz</span>
<a name="ln-521"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdx</span>
<a name="ln-522"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdy</span>
<a name="ln-523"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdz</span>
<a name="ln-524"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdx</span>
<a name="ln-525"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdy</span>
<a name="ln-526"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdz</span>
<a name="ln-527"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span>
<a name="ln-528"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">uface</span>
<a name="ln-529"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">vface</span>
<a name="ln-530"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">wface</span>
<a name="ln-531"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">trace</span>
<a name="ln-532"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxx</span>
<a name="ln-533"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyy</span>
<a name="ln-534"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauzz</span>
<a name="ln-535"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxy</span>
<a name="ln-536"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxz</span>
<a name="ln-537"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyz</span>
<a name="ln-538"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qx</span>
<a name="ln-539"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qy</span>
<a name="ln-540"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qz</span>
<a name="ln-541"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-542"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">RhoHt</span>
<a name="ln-543"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">K_heat</span>
<a name="ln-544"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-545"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-546"></a>
<a name="ln-547"></a>      <span class="n">area</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-548"></a>      <span class="n">nx</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-549"></a>      <span class="n">ny</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-550"></a>      <span class="n">nz</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-551"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-552"></a>      <span class="n">mmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-553"></a>      <span class="n">tmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-554"></a>
<a name="ln-555"></a>
<a name="ln-556"></a>      <span class="c">!save the old stat in P</span>
<a name="ln-557"></a>      <span class="n">P</span> <span class="o">=</span> <span class="n">qr</span>
<a name="ln-558"></a>
<a name="ln-559"></a>      <span class="c">! find conservative variable</span>
<a name="ln-560"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-561"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-562"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-563"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-564"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-565"></a>
<a name="ln-566"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">du</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-567"></a>      
<a name="ln-568"></a>
<a name="ln-569"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-570"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-571"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-572"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-573"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-574"></a>
<a name="ln-575"></a>      <span class="n">FaceNormalVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span><span class="p">)</span>
<a name="ln-576"></a>      <span class="n">uface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-577"></a>      <span class="n">vface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-578"></a>      <span class="n">wface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-579"></a>
<a name="ln-580"></a>
<a name="ln-581"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>   <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-582"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span>
<a name="ln-583"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span>
<a name="ln-584"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-585"></a>
<a name="ln-586"></a>      <span class="n">HalfRhoUsquare</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-587"></a>      <span class="n">RhoHt</span>          <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">gm</span><span class="o">/</span><span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-588"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>        <span class="o">=</span> <span class="n">RhoHt</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-589"></a>
<a name="ln-590"></a>
<a name="ln-591"></a>      <span class="c">! viscous terms</span>
<a name="ln-592"></a>      <span class="n">mu</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span>
<a name="ln-593"></a>      <span class="n">T1</span>     <span class="o">=</span>    <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-594"></a>      <span class="n">T2</span>     <span class="o">=</span>    <span class="n">P</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-595"></a>      <span class="n">dTdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-596"></a>      <span class="n">dTdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-597"></a>      <span class="n">dTdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-598"></a>      <span class="n">dudx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-599"></a>      <span class="n">dudy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-600"></a>      <span class="n">dudz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-601"></a>      <span class="n">dvdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-602"></a>      <span class="n">dvdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-603"></a>      <span class="n">dvdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-604"></a>      <span class="n">dwdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-605"></a>      <span class="n">dwdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-606"></a>      <span class="n">dwdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-607"></a>
<a name="ln-608"></a>      <span class="n">trace</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span> <span class="o">+</span> <span class="n">dwdz</span>
<a name="ln-609"></a>      <span class="n">Tauxx</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dudx</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-610"></a>      <span class="n">Tauyy</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdy</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-611"></a>      <span class="n">Tauzz</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdz</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-612"></a>      <span class="n">Tauxy</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdx</span> <span class="o">+</span> <span class="n">dudy</span><span class="p">)</span>
<a name="ln-613"></a>      <span class="n">Tauxz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdx</span> <span class="o">+</span> <span class="n">dudz</span><span class="p">)</span>
<a name="ln-614"></a>      <span class="n">Tauyz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdy</span> <span class="o">+</span> <span class="n">dvdz</span><span class="p">)</span>
<a name="ln-615"></a>
<a name="ln-616"></a>      <span class="n">K_heat</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mmu</span> <span class="o">/</span> <span class="n">Pr</span>  <span class="o">+</span> <span class="n">tmu</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">*</span> <span class="n">gm</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="o">/</span> <span class="p">(</span> <span class="n">gm</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>
<a name="ln-617"></a>      <span class="n">Qx</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdx</span>
<a name="ln-618"></a>      <span class="n">Qy</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdy</span>
<a name="ln-619"></a>      <span class="n">Qz</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdz</span>
<a name="ln-620"></a>
<a name="ln-621"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-622"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-623"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-624"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
<a name="ln-625"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qy</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
<a name="ln-626"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qz</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span>
<a name="ln-627"></a>
<a name="ln-628"></a>      <span class="n">Flux</span>    <span class="o">=</span> <span class="n">Flux</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-629"></a>
<a name="ln-630"></a>    <span class="k">end function </span><span class="n">Flux</span> 
<a name="ln-631"></a>
<a name="ln-632"></a>
<a name="ln-633"></a>    <span class="k">function </span><span class="n">SpectralRadius</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
<a name="ln-634"></a>      <span class="c">!&lt; Calculate the spectral radius </span>
<a name="ln-635"></a>      <span class="k">implicit none</span>
<a name="ln-636"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span>
<a name="ln-637"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span>
<a name="ln-638"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-639"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c1</span>
<a name="ln-640"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c2</span>
<a name="ln-641"></a>
<a name="ln-642"></a>      <span class="c">! local variables</span>
<a name="ln-643"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">SpectralRadius</span>
<a name="ln-644"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">NormalSpeed</span>
<a name="ln-645"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">SpeedOfSound</span>
<a name="ln-646"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">vis</span>
<a name="ln-647"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-648"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">rho</span>
<a name="ln-649"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                                 <span class="kd">::</span> <span class="n">distance</span>
<a name="ln-650"></a>
<a name="ln-651"></a>      <span class="c">!extract inputs</span>
<a name="ln-652"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Area</span>
<a name="ln-653"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-654"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-655"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-656"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-657"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mm</span>
<a name="ln-658"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tm</span>
<a name="ln-659"></a>
<a name="ln-660"></a>      <span class="n">Area</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-661"></a>      <span class="n">nx</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-662"></a>      <span class="n">ny</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-663"></a>      <span class="n">nz</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-664"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-665"></a>      <span class="n">mm</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-666"></a>      <span class="n">tm</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-667"></a>      <span class="c">! in state vector q (2-4) are the cell center velocity</span>
<a name="ln-668"></a>      <span class="n">NormalSpeed</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-669"></a>                          <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-670"></a>                          <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-671"></a>                          <span class="p">)</span>
<a name="ln-672"></a>      <span class="n">NormalSpeed</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">NormalSpeed</span><span class="p">)</span>
<a name="ln-673"></a>
<a name="ln-674"></a>      <span class="n">SpeedOfSound</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">gm</span><span class="o">*</span><span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">gm</span><span class="o">*</span><span class="n">qr</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="n">qr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-675"></a>
<a name="ln-676"></a>      <span class="c">! visocus part</span>
<a name="ln-677"></a>      <span class="n">mu</span>  <span class="o">=</span> <span class="n">mm</span><span class="o">/</span><span class="n">Pr</span> <span class="o">+</span> <span class="n">tm</span><span class="o">/</span><span class="n">tPr</span>
<a name="ln-678"></a>      <span class="n">rho</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-679"></a>      <span class="n">distance</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">c1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">c2</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">c1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">c2</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="p">(</span><span class="n">c1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">c2</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-680"></a>      <span class="n">vis</span> <span class="o">=</span> <span class="n">gm</span> <span class="o">*</span> <span class="p">(</span><span class="n">mm</span><span class="o">/</span><span class="n">pr</span> <span class="o">+</span> <span class="n">tm</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">distance</span> <span class="p">)</span>
<a name="ln-681"></a>      <span class="n">SpectralRadius</span> <span class="o">=</span> <span class="p">(</span> <span class="n">NormalSpeed</span> <span class="o">+</span> <span class="n">SpeedOfSound</span> <span class="o">+</span> <span class="n">vis</span><span class="p">)</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-682"></a>
<a name="ln-683"></a>    <span class="k">end function </span><span class="n">SpectralRadius</span>
<a name="ln-684"></a>
<a name="ln-685"></a>
<a name="ln-686"></a>    <span class="k">subroutine </span><span class="n">update_SST_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-687"></a>      <span class="c">!&lt; Update the RANS (SST) equation with LU-SGS</span>
<a name="ln-688"></a>      <span class="k">implicit none</span>
<a name="ln-689"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-690"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-691"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="kd">::</span> <span class="n">qp</span>
<a name="ln-692"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-693"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-694"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-695"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-696"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-697"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-698"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-699"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-700"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-701"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-702"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-703"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-704"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-705"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-706"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">deltaU</span>
<a name="ln-707"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">D</span>
<a name="ln-708"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">conservativeQ</span>
<a name="ln-709"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldIminusFlux</span>
<a name="ln-710"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldJminusFlux</span>
<a name="ln-711"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldKminusFlux</span>
<a name="ln-712"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewIminusFlux</span>
<a name="ln-713"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewJminusFlux</span>
<a name="ln-714"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewKminusFlux</span>
<a name="ln-715"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelIminusFlux</span>
<a name="ln-716"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelJminusFlux</span>
<a name="ln-717"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelKminusFlux</span>
<a name="ln-718"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">LambdaTimesArea</span>
<a name="ln-719"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q0</span> <span class="c">! state at cell</span>
<a name="ln-720"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q1</span> <span class="c">! state at neighbours </span>
<a name="ln-721"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q2</span>
<a name="ln-722"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q3</span>
<a name="ln-723"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q4</span>
<a name="ln-724"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q5</span>
<a name="ln-725"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q6</span>
<a name="ln-726"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ0</span><span class="c">! change in state</span>
<a name="ln-727"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ1</span>
<a name="ln-728"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ2</span>
<a name="ln-729"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ3</span>
<a name="ln-730"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ4</span>
<a name="ln-731"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ5</span>
<a name="ln-732"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ6</span>
<a name="ln-733"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist1</span>
<a name="ln-734"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist2</span>
<a name="ln-735"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist3</span>
<a name="ln-736"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist4</span>
<a name="ln-737"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist5</span>
<a name="ln-738"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist6</span>
<a name="ln-739"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C0</span>
<a name="ln-740"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C1</span>
<a name="ln-741"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C2</span>
<a name="ln-742"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C3</span>
<a name="ln-743"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C4</span>
<a name="ln-744"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C5</span>
<a name="ln-745"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C6</span>
<a name="ln-746"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">beta</span>
<a name="ln-747"></a>
<a name="ln-748"></a>        <span class="c">! intermittency</span>
<a name="ln-749"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">De</span><span class="p">,</span> <span class="n">Dp</span>
<a name="ln-750"></a>
<a name="ln-751"></a>        <span class="n">De</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-752"></a>        <span class="n">Dp</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-753"></a>
<a name="ln-754"></a>
<a name="ln-755"></a>        <span class="c">!intialize delQ</span>
<a name="ln-756"></a>        <span class="n">delQstar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-757"></a>
<a name="ln-758"></a>        <span class="c">!forward sweep</span>
<a name="ln-759"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-760"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-761"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-762"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-763"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-764"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-765"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-766"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-767"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-768"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-769"></a>
<a name="ln-770"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-771"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-772"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-773"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-774"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-775"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-776"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-777"></a>
<a name="ln-778"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-779"></a>              <span class="n">DQ1</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-780"></a>              <span class="n">DQ2</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-781"></a>              <span class="n">DQ3</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-782"></a>
<a name="ln-783"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-784"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-785"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-786"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-787"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-788"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-789"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-790"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-791"></a>
<a name="ln-792"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-793"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-794"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-795"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-796"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-797"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-798"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-799"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-800"></a>
<a name="ln-801"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-802"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-803"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-804"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-805"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-806"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-807"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-808"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-809"></a>
<a name="ln-810"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-811"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-812"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-813"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-814"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-815"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-816"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-817"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-818"></a>
<a name="ln-819"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-820"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-821"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-822"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-823"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-824"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-825"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-826"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-827"></a>
<a name="ln-828"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-829"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-830"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-831"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-832"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-833"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-834"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-835"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-836"></a>
<a name="ln-837"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ1</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-838"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ2</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-839"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ3</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-840"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-841"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-842"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-843"></a>
<a name="ln-844"></a>
<a name="ln-845"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-846"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-847"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-848"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-849"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-850"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-851"></a>
<a name="ln-852"></a>
<a name="ln-853"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-854"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-855"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-856"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-857"></a>
<a name="ln-858"></a>
<a name="ln-859"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-860"></a>              <span class="n">beta</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">beta1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">beta2</span>
<a name="ln-861"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bstar</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-862"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-863"></a>              <span class="c">!storing D in Iflux array for backward sweep</span>
<a name="ln-864"></a>              <span class="c">!F_p(i,j,k,1) = D</span>
<a name="ln-865"></a>              
<a name="ln-866"></a>
<a name="ln-867"></a>              <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-868"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(((</span><span class="n">DelIminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-869"></a>                     <span class="o">+</span> <span class="p">((</span><span class="n">DelJminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-870"></a>                     <span class="o">+</span> <span class="p">((</span><span class="n">DelKminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-871"></a>
<a name="ln-872"></a>              <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-873"></a>            <span class="k">end do</span>
<a name="ln-874"></a><span class="k">          end do</span>
<a name="ln-875"></a><span class="k">        end do</span>
<a name="ln-876"></a>
<a name="ln-877"></a><span class="k">        </span><span class="n">delQ</span><span class="o">=</span><span class="mf">0.0</span>
<a name="ln-878"></a>        <span class="c">!backward sweep</span>
<a name="ln-879"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-880"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-881"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-882"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-883"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-884"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-885"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-886"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-887"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-888"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-889"></a>
<a name="ln-890"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-891"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-892"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-893"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-894"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-895"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-896"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-897"></a>
<a name="ln-898"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-899"></a>              <span class="n">DQ4</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-900"></a>              <span class="n">DQ5</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-901"></a>              <span class="n">DQ6</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-902"></a>
<a name="ln-903"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-904"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-905"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-906"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-907"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-908"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-909"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-910"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-911"></a>
<a name="ln-912"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-913"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-914"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-915"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-916"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-917"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-918"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-919"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-920"></a>
<a name="ln-921"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-922"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-923"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-924"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-925"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-926"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-927"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-928"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-929"></a>
<a name="ln-930"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-931"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-932"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-933"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-934"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-935"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-936"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-937"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-938"></a>
<a name="ln-939"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-940"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-941"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-942"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-943"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-944"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-945"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-946"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-947"></a>
<a name="ln-948"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-949"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-950"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-951"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-952"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-953"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-954"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-955"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-956"></a>
<a name="ln-957"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ4</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-958"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ5</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-959"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ6</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-960"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-961"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-962"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">SSTFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-963"></a>
<a name="ln-964"></a>
<a name="ln-965"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-966"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-967"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-968"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-969"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-970"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-971"></a>
<a name="ln-972"></a>
<a name="ln-973"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-974"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-975"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-976"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-977"></a>
<a name="ln-978"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-979"></a>              <span class="n">beta</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">beta1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">beta2</span>
<a name="ln-980"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bstar</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-981"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-982"></a>
<a name="ln-983"></a>
<a name="ln-984"></a>              <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-985"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(((</span><span class="n">DelIminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-986"></a>                     <span class="o">+</span> <span class="p">((</span><span class="n">DelJminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-987"></a>                     <span class="o">+</span> <span class="p">((</span><span class="n">DelKminusFlux</span><span class="p">)</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-988"></a>
<a name="ln-989"></a>            <span class="k">end do</span>
<a name="ln-990"></a><span class="k">          end do</span>
<a name="ln-991"></a><span class="k">        end do</span>
<a name="ln-992"></a>
<a name="ln-993"></a><span class="k">        </span>
<a name="ln-994"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-995"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-996"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-997"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-998"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-999"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1000"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1001"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1002"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1003"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1004"></a>              
<a name="ln-1005"></a>              <span class="c">! add new change into conservative solution</span>
<a name="ln-1006"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1007"></a>
<a name="ln-1008"></a>              <span class="c">! convert back conservative to primitive</span>
<a name="ln-1009"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1010"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1011"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1012"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1013"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-1014"></a>              <span class="k">if</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-1015"></a><span class="k">              </span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1016"></a>              <span class="k">end if</span>
<a name="ln-1017"></a><span class="k">              if</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-1018"></a><span class="k">              </span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1019"></a>              <span class="k">end if</span>
<a name="ln-1020"></a><span class="k">            end do</span>
<a name="ln-1021"></a><span class="k">          end do</span>
<a name="ln-1022"></a><span class="k">        end do</span>
<a name="ln-1023"></a>
<a name="ln-1024"></a><span class="k">    end subroutine </span><span class="n">update_SST_variables</span>
<a name="ln-1025"></a>
<a name="ln-1026"></a>
<a name="ln-1027"></a>    <span class="k">function </span><span class="n">SSTFlux</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a name="ln-1028"></a>      <span class="c">!&lt; calculate the total flux through face for turbulent flow (SST)</span>
<a name="ln-1029"></a>      <span class="k">implicit none</span>
<a name="ln-1030"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span> <span class="c">!left state</span>
<a name="ln-1031"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span> <span class="c">!right state</span>
<a name="ln-1032"></a>      <span class="c">!conservative form of updated neighbour</span>
<a name="ln-1033"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">du</span>
<a name="ln-1034"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-1035"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">Flux</span>
<a name="ln-1036"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">SSTFlux</span>
<a name="ln-1037"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">U</span> <span class="c">! conservative variables</span>
<a name="ln-1038"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">W</span> <span class="c">! new primitive variables</span>
<a name="ln-1039"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">P</span> <span class="c">! primitive variables of right cell</span>
<a name="ln-1040"></a>
<a name="ln-1041"></a>      <span class="c">!for extraction of the inputs</span>
<a name="ln-1042"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">area</span>
<a name="ln-1043"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-1044"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-1045"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-1046"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-1047"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-1048"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-1049"></a>
<a name="ln-1050"></a>
<a name="ln-1051"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudx</span>
<a name="ln-1052"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudy</span>
<a name="ln-1053"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudz</span>
<a name="ln-1054"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdx</span>
<a name="ln-1055"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-1056"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdz</span>
<a name="ln-1057"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdx</span>
<a name="ln-1058"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdy</span>
<a name="ln-1059"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdz</span>
<a name="ln-1060"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdx</span>
<a name="ln-1061"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdy</span>
<a name="ln-1062"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdz</span>
<a name="ln-1063"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdx</span>
<a name="ln-1064"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdy</span>
<a name="ln-1065"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdz</span>
<a name="ln-1066"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdx</span>
<a name="ln-1067"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdy</span>
<a name="ln-1068"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdz</span>
<a name="ln-1069"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span>
<a name="ln-1070"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">uface</span>
<a name="ln-1071"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">vface</span>
<a name="ln-1072"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">wface</span>
<a name="ln-1073"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">trace</span>
<a name="ln-1074"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxx</span>
<a name="ln-1075"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyy</span>
<a name="ln-1076"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauzz</span>
<a name="ln-1077"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxy</span>
<a name="ln-1078"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxz</span>
<a name="ln-1079"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyz</span>
<a name="ln-1080"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qx</span>
<a name="ln-1081"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qy</span>
<a name="ln-1082"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qz</span>
<a name="ln-1083"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-1084"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">RhoHt</span>
<a name="ln-1085"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">K_heat</span>
<a name="ln-1086"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1087"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-1088"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">sigma_k</span>
<a name="ln-1089"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">sigma_w</span>
<a name="ln-1090"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">F1</span>
<a name="ln-1091"></a>
<a name="ln-1092"></a>      <span class="n">area</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1093"></a>      <span class="n">nx</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1094"></a>      <span class="n">ny</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1095"></a>      <span class="n">nz</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1096"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1097"></a>      <span class="n">mmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1098"></a>      <span class="n">tmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1099"></a>      <span class="n">F1</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1100"></a>
<a name="ln-1101"></a>
<a name="ln-1102"></a>      <span class="c">!save the old stat in P</span>
<a name="ln-1103"></a>      <span class="n">P</span> <span class="o">=</span> <span class="n">qr</span>
<a name="ln-1104"></a>
<a name="ln-1105"></a>      <span class="c">! find conservative variable</span>
<a name="ln-1106"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1107"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1108"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1109"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1110"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1111"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1112"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1113"></a>
<a name="ln-1114"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">du</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>
<a name="ln-1115"></a>      
<a name="ln-1116"></a>
<a name="ln-1117"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1118"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1119"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1120"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1121"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-1122"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1123"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1124"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-1125"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">-</span><span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-1126"></a>
<a name="ln-1127"></a>      <span class="n">FaceNormalVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span><span class="p">)</span>
<a name="ln-1128"></a>      <span class="n">uface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1129"></a>      <span class="n">vface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1130"></a>      <span class="n">wface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1131"></a>
<a name="ln-1132"></a>
<a name="ln-1133"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>   <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1134"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span>
<a name="ln-1135"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span>
<a name="ln-1136"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1137"></a>
<a name="ln-1138"></a>      <span class="n">HalfRhoUsquare</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1139"></a>      <span class="n">RhoHt</span>          <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">gm</span><span class="o">/</span><span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-1140"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>        <span class="o">=</span> <span class="n">RhoHt</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1141"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-1142"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-1143"></a>
<a name="ln-1144"></a>
<a name="ln-1145"></a>      <span class="c">! viscous terms</span>
<a name="ln-1146"></a>      <span class="n">mu</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span>
<a name="ln-1147"></a>      <span class="n">T1</span>     <span class="o">=</span>    <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-1148"></a>      <span class="n">T2</span>     <span class="o">=</span>    <span class="n">P</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-1149"></a>      <span class="n">dTdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1150"></a>      <span class="n">dTdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1151"></a>      <span class="n">dTdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1152"></a>      <span class="n">dudx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1153"></a>      <span class="n">dudy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1154"></a>      <span class="n">dudz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1155"></a>      <span class="n">dvdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1156"></a>      <span class="n">dvdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1157"></a>      <span class="n">dvdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1158"></a>      <span class="n">dwdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1159"></a>      <span class="n">dwdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1160"></a>      <span class="n">dwdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1161"></a>      <span class="n">dtkdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1162"></a>      <span class="n">dtkdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1163"></a>      <span class="n">dtkdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1164"></a>      <span class="n">dtwdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1165"></a>      <span class="n">dtwdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1166"></a>      <span class="n">dtwdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1167"></a>
<a name="ln-1168"></a>      <span class="n">trace</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span> <span class="o">+</span> <span class="n">dwdz</span>
<a name="ln-1169"></a>      <span class="n">Tauxx</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dudx</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1170"></a>      <span class="n">Tauyy</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdy</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1171"></a>      <span class="n">Tauzz</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdz</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1172"></a>      <span class="n">Tauxy</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdx</span> <span class="o">+</span> <span class="n">dudy</span><span class="p">)</span>
<a name="ln-1173"></a>      <span class="n">Tauxz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdx</span> <span class="o">+</span> <span class="n">dudz</span><span class="p">)</span>
<a name="ln-1174"></a>      <span class="n">Tauyz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdy</span> <span class="o">+</span> <span class="n">dvdz</span><span class="p">)</span>
<a name="ln-1175"></a>
<a name="ln-1176"></a>      <span class="n">K_heat</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mmu</span> <span class="o">/</span> <span class="n">Pr</span>  <span class="o">+</span> <span class="n">tmu</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">*</span> <span class="n">gm</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="o">/</span> <span class="p">(</span> <span class="n">gm</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>
<a name="ln-1177"></a>      <span class="n">Qx</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdx</span>
<a name="ln-1178"></a>      <span class="n">Qy</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdy</span>
<a name="ln-1179"></a>      <span class="n">Qz</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdz</span>
<a name="ln-1180"></a>
<a name="ln-1181"></a>      <span class="n">sigma_k</span> <span class="o">=</span> <span class="n">sigma_k1</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">sigma_k2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-1182"></a>      <span class="n">sigma_w</span> <span class="o">=</span> <span class="n">sigma_w1</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">sigma_w2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-1183"></a>
<a name="ln-1184"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1185"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1186"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1187"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
<a name="ln-1188"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qy</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
<a name="ln-1189"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qz</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span>
<a name="ln-1190"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_k</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtkdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtkdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtkdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-1191"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_w</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtwdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtwdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtwdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-1192"></a>
<a name="ln-1193"></a>      <span class="n">Flux</span>    <span class="o">=</span> <span class="n">Flux</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-1194"></a>      <span class="n">SSTFlux</span> <span class="o">=</span> <span class="n">Flux</span>
<a name="ln-1195"></a>
<a name="ln-1196"></a>    <span class="k">end function </span><span class="n">SSTFlux</span> 
<a name="ln-1197"></a>
<a name="ln-1198"></a>    <span class="k">subroutine </span><span class="n">update_KKL_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-1199"></a>      <span class="c">!&lt; Update the RANS (k-kL) equation with LU-SGS</span>
<a name="ln-1200"></a>      <span class="k">implicit none</span>
<a name="ln-1201"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-1202"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-1203"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="kd">::</span> <span class="n">qp</span>
<a name="ln-1204"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-1205"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-1206"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-1207"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-1208"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-1209"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-1210"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-1211"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-1212"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-1213"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-1214"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-1215"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-1216"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-1217"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-1218"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">deltaU</span>
<a name="ln-1219"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">D</span>
<a name="ln-1220"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">conservativeQ</span>
<a name="ln-1221"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldIminusFlux</span>
<a name="ln-1222"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldJminusFlux</span>
<a name="ln-1223"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldKminusFlux</span>
<a name="ln-1224"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewIminusFlux</span>
<a name="ln-1225"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewJminusFlux</span>
<a name="ln-1226"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewKminusFlux</span>
<a name="ln-1227"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelIminusFlux</span>
<a name="ln-1228"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelJminusFlux</span>
<a name="ln-1229"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelKminusFlux</span>
<a name="ln-1230"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">LambdaTimesArea</span>
<a name="ln-1231"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q0</span> <span class="c">! state at cell</span>
<a name="ln-1232"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q1</span> <span class="c">! state at neighbours </span>
<a name="ln-1233"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q2</span>
<a name="ln-1234"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q3</span>
<a name="ln-1235"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q4</span>
<a name="ln-1236"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q5</span>
<a name="ln-1237"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q6</span>
<a name="ln-1238"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ0</span><span class="c">! change in state</span>
<a name="ln-1239"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ1</span>
<a name="ln-1240"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ2</span>
<a name="ln-1241"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ3</span>
<a name="ln-1242"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ4</span>
<a name="ln-1243"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ5</span>
<a name="ln-1244"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ6</span>
<a name="ln-1245"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist1</span>
<a name="ln-1246"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist2</span>
<a name="ln-1247"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist3</span>
<a name="ln-1248"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist4</span>
<a name="ln-1249"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist5</span>
<a name="ln-1250"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist6</span>
<a name="ln-1251"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C0</span>
<a name="ln-1252"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C1</span>
<a name="ln-1253"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C2</span>
<a name="ln-1254"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C3</span>
<a name="ln-1255"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C4</span>
<a name="ln-1256"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C5</span>
<a name="ln-1257"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C6</span>
<a name="ln-1258"></a>
<a name="ln-1259"></a>
<a name="ln-1260"></a>
<a name="ln-1261"></a>        <span class="c">!intialize delQ</span>
<a name="ln-1262"></a>        <span class="n">delQstar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1263"></a>
<a name="ln-1264"></a>        <span class="c">!forward sweep</span>
<a name="ln-1265"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1266"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1267"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1268"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1269"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1270"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1271"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1272"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1273"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1274"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1275"></a>
<a name="ln-1276"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1277"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1278"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1279"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1280"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1281"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1282"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1283"></a>
<a name="ln-1284"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1285"></a>              <span class="n">DQ1</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1286"></a>              <span class="n">DQ2</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1287"></a>              <span class="n">DQ3</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1288"></a>
<a name="ln-1289"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1290"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1291"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1292"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1293"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1294"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1295"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1296"></a>
<a name="ln-1297"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1298"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1299"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1300"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1301"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1302"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1303"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1304"></a>
<a name="ln-1305"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1306"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1307"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1308"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1309"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1310"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1311"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1312"></a>
<a name="ln-1313"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1314"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1315"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1316"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1317"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1318"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1319"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1320"></a>
<a name="ln-1321"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1322"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1323"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1324"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1325"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1326"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1327"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1328"></a>
<a name="ln-1329"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1330"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1331"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1332"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1333"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1334"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1335"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1336"></a>
<a name="ln-1337"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ1</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-1338"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ2</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-1339"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ3</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-1340"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-1341"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-1342"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-1343"></a>
<a name="ln-1344"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1345"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1346"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1347"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1348"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1349"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1350"></a>
<a name="ln-1351"></a>
<a name="ln-1352"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-1353"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-1354"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-1355"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-1356"></a>
<a name="ln-1357"></a>
<a name="ln-1358"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-1359"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="p">(</span><span class="n">cmu</span><span class="o">**</span><span class="p">(</span><span class="mf">0.75</span><span class="p">))</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">Q0</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-1360"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1361"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1362"></a>              <span class="c">!storing D in Iflux array for backward sweep</span>
<a name="ln-1363"></a>              <span class="c">!F_p(i,j,k,1) = D</span>
<a name="ln-1364"></a>
<a name="ln-1365"></a>              <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1366"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1367"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1368"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-1369"></a>
<a name="ln-1370"></a>              <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-1371"></a>            <span class="k">end do</span>
<a name="ln-1372"></a><span class="k">          end do</span>
<a name="ln-1373"></a><span class="k">        end do</span>
<a name="ln-1374"></a>
<a name="ln-1375"></a><span class="k">        </span><span class="n">delQ</span><span class="o">=</span><span class="mf">0.0</span>
<a name="ln-1376"></a>        <span class="c">!backward sweep</span>
<a name="ln-1377"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1378"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1379"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1380"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1381"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1382"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1383"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1384"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1385"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1386"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1387"></a>
<a name="ln-1388"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1389"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1390"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1391"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1392"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1393"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1394"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1395"></a>
<a name="ln-1396"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1397"></a>              <span class="n">DQ4</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1398"></a>              <span class="n">DQ5</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1399"></a>              <span class="n">DQ6</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1400"></a>
<a name="ln-1401"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1402"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1403"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1404"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1405"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1406"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1407"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1408"></a>
<a name="ln-1409"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1410"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1411"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1412"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1413"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1414"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1415"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1416"></a>
<a name="ln-1417"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1418"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1419"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1420"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1421"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1422"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1423"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1424"></a>
<a name="ln-1425"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1426"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1427"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1428"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1429"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1430"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1431"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1432"></a>
<a name="ln-1433"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1434"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1435"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1436"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1437"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1438"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1439"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1440"></a>
<a name="ln-1441"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1442"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1443"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1444"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1445"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1446"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1447"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1448"></a>
<a name="ln-1449"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ4</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-1450"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ5</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-1451"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ6</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-1452"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-1453"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-1454"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">KKLFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-1455"></a>
<a name="ln-1456"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1457"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1458"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1459"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1460"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1461"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1462"></a>
<a name="ln-1463"></a>
<a name="ln-1464"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-1465"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-1466"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-1467"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-1468"></a>
<a name="ln-1469"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-1470"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="p">(</span><span class="n">cmu</span><span class="o">**</span><span class="p">(</span><span class="mf">0.75</span><span class="p">))</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.5</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">Q0</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-1471"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1472"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1473"></a>
<a name="ln-1474"></a>
<a name="ln-1475"></a>              <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1476"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1477"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1478"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-1479"></a>
<a name="ln-1480"></a>            <span class="k">end do</span>
<a name="ln-1481"></a><span class="k">          end do</span>
<a name="ln-1482"></a><span class="k">        end do</span>
<a name="ln-1483"></a><span class="k">        </span>
<a name="ln-1484"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1485"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1486"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1487"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1488"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1489"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1490"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1491"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1492"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1493"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1494"></a>              
<a name="ln-1495"></a>              <span class="c">! add new change into conservative solution</span>
<a name="ln-1496"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1497"></a>
<a name="ln-1498"></a>              <span class="c">! convert back conservative to primitive</span>
<a name="ln-1499"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1500"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1501"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1502"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1503"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-1504"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1505"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1506"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="mf">1.e-8</span><span class="p">)</span>
<a name="ln-1507"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="mf">1.e-8</span><span class="p">)</span>
<a name="ln-1508"></a>            <span class="k">end do</span>
<a name="ln-1509"></a><span class="k">          end do</span>
<a name="ln-1510"></a><span class="k">        end do</span>
<a name="ln-1511"></a>
<a name="ln-1512"></a><span class="k">    end subroutine </span><span class="n">update_KKL_variables</span>
<a name="ln-1513"></a>
<a name="ln-1514"></a>
<a name="ln-1515"></a>    <span class="k">function </span><span class="n">KKLFlux</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a name="ln-1516"></a>      <span class="c">!&lt; calculate the total flux through face for turbulent flow (k-kL)</span>
<a name="ln-1517"></a>      <span class="k">implicit none</span>
<a name="ln-1518"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span> <span class="c">!left state</span>
<a name="ln-1519"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span> <span class="c">!right state</span>
<a name="ln-1520"></a>      <span class="c">!conservative form of updated neighbour</span>
<a name="ln-1521"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">du</span>
<a name="ln-1522"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-1523"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">Flux</span>
<a name="ln-1524"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">KKLFlux</span>
<a name="ln-1525"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">U</span> <span class="c">! conservative variables</span>
<a name="ln-1526"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">W</span> <span class="c">! new primitive variables</span>
<a name="ln-1527"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">P</span> <span class="c">! primitive variables of right cell</span>
<a name="ln-1528"></a>
<a name="ln-1529"></a>      <span class="c">!for extraction of the inputs</span>
<a name="ln-1530"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">area</span>
<a name="ln-1531"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-1532"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-1533"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-1534"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-1535"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-1536"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-1537"></a>
<a name="ln-1538"></a>
<a name="ln-1539"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudx</span>
<a name="ln-1540"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudy</span>
<a name="ln-1541"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudz</span>
<a name="ln-1542"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdx</span>
<a name="ln-1543"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-1544"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdz</span>
<a name="ln-1545"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdx</span>
<a name="ln-1546"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdy</span>
<a name="ln-1547"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdz</span>
<a name="ln-1548"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdx</span>
<a name="ln-1549"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdy</span>
<a name="ln-1550"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdz</span>
<a name="ln-1551"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdx</span>
<a name="ln-1552"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdy</span>
<a name="ln-1553"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdz</span>
<a name="ln-1554"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkldx</span>
<a name="ln-1555"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkldy</span>
<a name="ln-1556"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkldz</span>
<a name="ln-1557"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span>
<a name="ln-1558"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">uface</span>
<a name="ln-1559"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">vface</span>
<a name="ln-1560"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">wface</span>
<a name="ln-1561"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">trace</span>
<a name="ln-1562"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxx</span>
<a name="ln-1563"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyy</span>
<a name="ln-1564"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauzz</span>
<a name="ln-1565"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxy</span>
<a name="ln-1566"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxz</span>
<a name="ln-1567"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyz</span>
<a name="ln-1568"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qx</span>
<a name="ln-1569"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qy</span>
<a name="ln-1570"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qz</span>
<a name="ln-1571"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-1572"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">RhoHt</span>
<a name="ln-1573"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">K_heat</span>
<a name="ln-1574"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1575"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-1576"></a>
<a name="ln-1577"></a>      <span class="n">area</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1578"></a>      <span class="n">nx</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1579"></a>      <span class="n">ny</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1580"></a>      <span class="n">nz</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1581"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1582"></a>      <span class="n">mmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1583"></a>      <span class="n">tmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1584"></a>
<a name="ln-1585"></a>
<a name="ln-1586"></a>      <span class="c">!save the old stat in P</span>
<a name="ln-1587"></a>      <span class="n">P</span> <span class="o">=</span> <span class="n">qr</span>
<a name="ln-1588"></a>
<a name="ln-1589"></a>      <span class="c">! find conservative variable</span>
<a name="ln-1590"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1591"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1592"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1593"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1594"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1595"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1596"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1597"></a>
<a name="ln-1598"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">du</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>
<a name="ln-1599"></a>      
<a name="ln-1600"></a>
<a name="ln-1601"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1602"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1603"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1604"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1605"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-1606"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1607"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1608"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="err">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1609"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="err">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1610"></a>
<a name="ln-1611"></a>      <span class="n">FaceNormalVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span><span class="p">)</span>
<a name="ln-1612"></a>      <span class="n">uface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1613"></a>      <span class="n">vface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1614"></a>      <span class="n">wface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1615"></a>
<a name="ln-1616"></a>
<a name="ln-1617"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>   <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1618"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span>
<a name="ln-1619"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span>
<a name="ln-1620"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1621"></a>
<a name="ln-1622"></a>      <span class="n">HalfRhoUsquare</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1623"></a>      <span class="n">RhoHt</span>          <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">gm</span><span class="o">/</span><span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-1624"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>        <span class="o">=</span> <span class="n">RhoHt</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-1625"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-1626"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-1627"></a>
<a name="ln-1628"></a>
<a name="ln-1629"></a>      <span class="c">! viscous terms</span>
<a name="ln-1630"></a>      <span class="n">mu</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span>
<a name="ln-1631"></a>      <span class="n">T1</span>     <span class="o">=</span>    <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-1632"></a>      <span class="n">T2</span>     <span class="o">=</span>    <span class="n">P</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-1633"></a>      <span class="n">dTdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1634"></a>      <span class="n">dTdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1635"></a>      <span class="n">dTdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1636"></a>      <span class="n">dudx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1637"></a>      <span class="n">dudy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1638"></a>      <span class="n">dudz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1639"></a>      <span class="n">dvdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1640"></a>      <span class="n">dvdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1641"></a>      <span class="n">dvdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1642"></a>      <span class="n">dwdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1643"></a>      <span class="n">dwdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1644"></a>      <span class="n">dwdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1645"></a>      <span class="n">dtkdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1646"></a>      <span class="n">dtkdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1647"></a>      <span class="n">dtkdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1648"></a>      <span class="n">dtkldx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1649"></a>      <span class="n">dtkldy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1650"></a>      <span class="n">dtkldz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-1651"></a>
<a name="ln-1652"></a>      <span class="n">trace</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span> <span class="o">+</span> <span class="n">dwdz</span>
<a name="ln-1653"></a>      <span class="n">Tauxx</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dudx</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1654"></a>      <span class="n">Tauyy</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdy</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1655"></a>      <span class="n">Tauzz</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdz</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-1656"></a>      <span class="n">Tauxy</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdx</span> <span class="o">+</span> <span class="n">dudy</span><span class="p">)</span>
<a name="ln-1657"></a>      <span class="n">Tauxz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdx</span> <span class="o">+</span> <span class="n">dudz</span><span class="p">)</span>
<a name="ln-1658"></a>      <span class="n">Tauyz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdy</span> <span class="o">+</span> <span class="n">dvdz</span><span class="p">)</span>
<a name="ln-1659"></a>
<a name="ln-1660"></a>      <span class="n">K_heat</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mmu</span> <span class="o">/</span> <span class="n">Pr</span>  <span class="o">+</span> <span class="n">tmu</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">*</span> <span class="n">gm</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="o">/</span> <span class="p">(</span> <span class="n">gm</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>
<a name="ln-1661"></a>      <span class="n">Qx</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdx</span>
<a name="ln-1662"></a>      <span class="n">Qy</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdy</span>
<a name="ln-1663"></a>      <span class="n">Qz</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdz</span>
<a name="ln-1664"></a>
<a name="ln-1665"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1666"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1667"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-1668"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
<a name="ln-1669"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qy</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
<a name="ln-1670"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qz</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span>
<a name="ln-1671"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_k</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtkdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtkdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtkdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-1672"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_phi</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtkldx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtkldy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtkldz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-1673"></a>
<a name="ln-1674"></a>      <span class="n">Flux</span>    <span class="o">=</span> <span class="n">Flux</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-1675"></a>      <span class="n">KKLFlux</span> <span class="o">=</span> <span class="n">Flux</span>
<a name="ln-1676"></a>
<a name="ln-1677"></a>    <span class="k">end function </span><span class="n">KKLFlux</span> 
<a name="ln-1678"></a>
<a name="ln-1679"></a>
<a name="ln-1680"></a>    <span class="k">subroutine </span><span class="n">update_SA_variables</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-1681"></a>      <span class="c">!&lt; Update the RANS (SA) equation with LU-SGS</span>
<a name="ln-1682"></a>      <span class="k">implicit none</span>
<a name="ln-1683"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-1684"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-1685"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-1686"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-1687"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-1688"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-1689"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-1690"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-1691"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-1692"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-1693"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-1694"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-1695"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-1696"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-1697"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-1698"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-1699"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-1700"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">deltaU</span>
<a name="ln-1701"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">D</span>
<a name="ln-1702"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">conservativeQ</span>
<a name="ln-1703"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldIminusFlux</span>
<a name="ln-1704"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldJminusFlux</span>
<a name="ln-1705"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldKminusFlux</span>
<a name="ln-1706"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewIminusFlux</span>
<a name="ln-1707"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewJminusFlux</span>
<a name="ln-1708"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewKminusFlux</span>
<a name="ln-1709"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelIminusFlux</span>
<a name="ln-1710"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelJminusFlux</span>
<a name="ln-1711"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelKminusFlux</span>
<a name="ln-1712"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">LambdaTimesArea</span>
<a name="ln-1713"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q0</span> <span class="c">! state at cell</span>
<a name="ln-1714"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q1</span> <span class="c">! state at neighbours </span>
<a name="ln-1715"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q2</span>
<a name="ln-1716"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q3</span>
<a name="ln-1717"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q4</span>
<a name="ln-1718"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q5</span>
<a name="ln-1719"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q6</span>
<a name="ln-1720"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ0</span><span class="c">! change in state</span>
<a name="ln-1721"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ1</span>
<a name="ln-1722"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ2</span>
<a name="ln-1723"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ3</span>
<a name="ln-1724"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ4</span>
<a name="ln-1725"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ5</span>
<a name="ln-1726"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ6</span>
<a name="ln-1727"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist1</span>
<a name="ln-1728"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist2</span>
<a name="ln-1729"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist3</span>
<a name="ln-1730"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist4</span>
<a name="ln-1731"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist5</span>
<a name="ln-1732"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist6</span>
<a name="ln-1733"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C0</span>
<a name="ln-1734"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C1</span>
<a name="ln-1735"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C2</span>
<a name="ln-1736"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C3</span>
<a name="ln-1737"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C4</span>
<a name="ln-1738"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C5</span>
<a name="ln-1739"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C6</span>
<a name="ln-1740"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv1</span>
<a name="ln-1741"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv2</span>
<a name="ln-1742"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fw</span>
<a name="ln-1743"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g</span>
<a name="ln-1744"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">r</span>
<a name="ln-1745"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dist_i</span>
<a name="ln-1746"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dist_i_2</span>
<a name="ln-1747"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji</span>
<a name="ln-1748"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji_2</span>
<a name="ln-1749"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji_3</span>
<a name="ln-1750"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S</span>
<a name="ln-1751"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Omega</span>
<a name="ln-1752"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k2</span>
<a name="ln-1753"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inv_k2_d2</span>
<a name="ln-1754"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Shat</span>
<a name="ln-1755"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inv_Shat</span>
<a name="ln-1756"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu</span>
<a name="ln-1757"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">glim</span>
<a name="ln-1758"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g_6</span>
<a name="ln-1759"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dfv1</span>
<a name="ln-1760"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dfv2</span>
<a name="ln-1761"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dfw</span>
<a name="ln-1762"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dShat</span>
<a name="ln-1763"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dr</span>
<a name="ln-1764"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dg</span>
<a name="ln-1765"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-1766"></a>
<a name="ln-1767"></a>
<a name="ln-1768"></a>
<a name="ln-1769"></a>        <span class="c">!intialize delQ</span>
<a name="ln-1770"></a>        <span class="n">delQstar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1771"></a>
<a name="ln-1772"></a>        <span class="c">!forward sweep</span>
<a name="ln-1773"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1774"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1775"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1776"></a>
<a name="ln-1777"></a>              <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1778"></a>
<a name="ln-1779"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1780"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1781"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1782"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1783"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1784"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1785"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1786"></a>
<a name="ln-1787"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1788"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1789"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1790"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1791"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1792"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1793"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1794"></a>
<a name="ln-1795"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1796"></a>              <span class="n">DQ1</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1797"></a>              <span class="n">DQ2</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1798"></a>              <span class="n">DQ3</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1799"></a>
<a name="ln-1800"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1801"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1802"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1803"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1804"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1805"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1806"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1807"></a>
<a name="ln-1808"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1809"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1810"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1811"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1812"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1813"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1814"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1815"></a>
<a name="ln-1816"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1817"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1818"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1819"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1820"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1821"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1822"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1823"></a>
<a name="ln-1824"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1825"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1826"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1827"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1828"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1829"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1830"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1831"></a>
<a name="ln-1832"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1833"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1834"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1835"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1836"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1837"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1838"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1839"></a>
<a name="ln-1840"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1841"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1842"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1843"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1844"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1845"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1846"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1847"></a>
<a name="ln-1848"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ1</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-1849"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ2</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-1850"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ3</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-1851"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-1852"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-1853"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-1854"></a>
<a name="ln-1855"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1856"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1857"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1858"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1859"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1860"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-1861"></a>
<a name="ln-1862"></a>
<a name="ln-1863"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-1864"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-1865"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-1866"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-1867"></a>
<a name="ln-1868"></a>
<a name="ln-1869"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-1870"></a>              <span class="c">!storing D in Iflux array for backward sweep</span>
<a name="ln-1871"></a>              <span class="c">!F_p(i,j,k,1) = D</span>
<a name="ln-1872"></a>              <span class="c">! -- source term derivatives -- !</span>
<a name="ln-1873"></a>              <span class="n">Omega</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1874"></a>                           <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1875"></a>                           <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1876"></a>                            <span class="p">)&amp;</span>
<a name="ln-1877"></a>                       <span class="p">)</span>
<a name="ln-1878"></a>              <span class="n">dist_i</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1879"></a>              <span class="n">dist_i_2</span> <span class="o">=</span> <span class="n">dist_i</span><span class="o">*</span><span class="n">dist_i</span>
<a name="ln-1880"></a>              <span class="n">k2</span> <span class="o">=</span> <span class="n">kappa_sa</span><span class="o">*</span><span class="n">kappa_sa</span>
<a name="ln-1881"></a>              <span class="n">nu</span>   <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">density</span>
<a name="ln-1882"></a>              <span class="n">Ji</span>   <span class="o">=</span> <span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">nu</span>
<a name="ln-1883"></a>              <span class="n">Ji_2</span> <span class="o">=</span> <span class="n">Ji</span><span class="o">*</span><span class="n">Ji</span>
<a name="ln-1884"></a>              <span class="n">Ji_3</span> <span class="o">=</span> <span class="n">Ji_2</span><span class="o">*</span><span class="n">ji</span>
<a name="ln-1885"></a>
<a name="ln-1886"></a>
<a name="ln-1887"></a>              <span class="c">! ___ functions ___</span>
<a name="ln-1888"></a>              <span class="n">fv1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Ji_3</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">Ji_3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv1_3</span><span class="p">))</span>
<a name="ln-1889"></a>              <span class="n">fv2</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">Ji</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Ji</span><span class="o">*</span><span class="n">fv1</span><span class="p">))</span>
<a name="ln-1890"></a>
<a name="ln-1891"></a>              <span class="c">! ___ Shear stress for production ___</span>
<a name="ln-1892"></a>              <span class="n">S</span> <span class="o">=</span> <span class="n">Omega</span>
<a name="ln-1893"></a>              <span class="n">inv_k2_d2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span><span class="o">*</span><span class="n">dist_i_2</span><span class="p">)</span>
<a name="ln-1894"></a>              <span class="n">Shat</span>      <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fv2</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-1895"></a>              <span class="n">Shat</span>      <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Shat</span><span class="p">,</span> <span class="mf">1.0e-10</span><span class="p">)</span>
<a name="ln-1896"></a>              <span class="n">inv_Shat</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Shat</span>
<a name="ln-1897"></a>              <span class="n">dfv1</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">Ji_2</span><span class="o">*</span><span class="n">cv1_3</span><span class="o">/</span><span class="p">(</span><span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="n">Ji_3</span><span class="o">+</span><span class="n">cv1_3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1898"></a>              <span class="n">dfv2</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ji_2</span><span class="o">*</span><span class="n">dfv1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">Ji</span><span class="o">*</span><span class="n">fv1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1899"></a>              <span class="n">dShat</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv2</span><span class="o">+</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dfv2</span><span class="p">)</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-1900"></a>
<a name="ln-1901"></a>              <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">cb1</span><span class="o">*</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dShat</span><span class="o">+</span><span class="n">Shat</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-1902"></a>
<a name="ln-1903"></a>              <span class="c">! ___ Destruction term___ !</span>
<a name="ln-1904"></a>              <span class="n">r</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_k2_d2</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1905"></a>              <span class="n">g</span>    <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">cw2</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
<a name="ln-1906"></a>              <span class="n">g_6</span>  <span class="o">=</span> <span class="n">g</span><span class="o">**</span><span class="mi">6</span>
<a name="ln-1907"></a>              <span class="n">glim</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">g_6</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span>
<a name="ln-1908"></a>              <span class="n">fw</span>   <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">glim</span>
<a name="ln-1909"></a>              <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Shat</span><span class="o">-</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dShat</span><span class="p">)</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-1910"></a>              <span class="n">dg</span> <span class="o">=</span> <span class="n">dr</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cw2</span><span class="o">*</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
<a name="ln-1911"></a>              <span class="n">dfw</span><span class="o">=</span> <span class="n">dg</span><span class="o">*</span><span class="n">glim</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">g_6</span><span class="o">/</span><span class="p">(</span><span class="n">g_6</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">))</span>
<a name="ln-1912"></a>
<a name="ln-1913"></a>              <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">+</span><span class="n">cw1</span><span class="o">*</span><span class="p">(</span><span class="n">dfw</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">dist_i_2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-1914"></a>              <span class="c">! --  end of source term -- !</span>
<a name="ln-1915"></a>
<a name="ln-1916"></a>              <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1917"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1918"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1919"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-1920"></a>
<a name="ln-1921"></a>              <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-1922"></a>            <span class="k">end do</span>
<a name="ln-1923"></a><span class="k">          end do</span>
<a name="ln-1924"></a><span class="k">        end do</span>
<a name="ln-1925"></a>
<a name="ln-1926"></a>
<a name="ln-1927"></a><span class="k">        </span><span class="n">delQ</span><span class="o">=</span><span class="mf">0.0</span>
<a name="ln-1928"></a>        <span class="c">!backward sweep</span>
<a name="ln-1929"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1930"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1931"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1932"></a>              <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1933"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1934"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1935"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1936"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1937"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1938"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1939"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1940"></a>
<a name="ln-1941"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1942"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1943"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1944"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1945"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1946"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1947"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1948"></a>
<a name="ln-1949"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1950"></a>              <span class="n">DQ4</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1951"></a>              <span class="n">DQ5</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1952"></a>              <span class="n">DQ6</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1953"></a>
<a name="ln-1954"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1955"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1956"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1957"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1958"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1959"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1960"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1961"></a>
<a name="ln-1962"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1963"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1964"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1965"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1966"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1967"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1968"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1969"></a>
<a name="ln-1970"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1971"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1972"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1973"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1974"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1975"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1976"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1977"></a>
<a name="ln-1978"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1979"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1980"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1981"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1982"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1983"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1984"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1985"></a>
<a name="ln-1986"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1987"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1988"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1989"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1990"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1991"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1992"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1993"></a>
<a name="ln-1994"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1995"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-1996"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-1997"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-1998"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1999"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2000"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2001"></a>
<a name="ln-2002"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ4</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-2003"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ5</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-2004"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ6</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-2005"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-2006"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-2007"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">SAFlux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-2008"></a>
<a name="ln-2009"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2010"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2011"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2012"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2013"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2014"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2015"></a>
<a name="ln-2016"></a>
<a name="ln-2017"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-2018"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-2019"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-2020"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-2021"></a>
<a name="ln-2022"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-2023"></a>
<a name="ln-2024"></a>              <span class="c">! -- source term derivatives -- !</span>
<a name="ln-2025"></a>              <span class="n">Omega</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2026"></a>                           <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2027"></a>                           <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2028"></a>                            <span class="p">)&amp;</span>
<a name="ln-2029"></a>                       <span class="p">)</span>
<a name="ln-2030"></a>              <span class="n">dist_i</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2031"></a>              <span class="n">dist_i_2</span> <span class="o">=</span> <span class="n">dist_i</span><span class="o">*</span><span class="n">dist_i</span>
<a name="ln-2032"></a>              <span class="n">k2</span> <span class="o">=</span> <span class="n">kappa_sa</span><span class="o">*</span><span class="n">kappa_sa</span>
<a name="ln-2033"></a>              <span class="n">nu</span>   <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">density</span>
<a name="ln-2034"></a>              <span class="n">Ji</span>   <span class="o">=</span> <span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">nu</span>
<a name="ln-2035"></a>              <span class="n">Ji_2</span> <span class="o">=</span> <span class="n">Ji</span><span class="o">*</span><span class="n">Ji</span>
<a name="ln-2036"></a>              <span class="n">Ji_3</span> <span class="o">=</span> <span class="n">Ji_2</span><span class="o">*</span><span class="n">ji</span>
<a name="ln-2037"></a>
<a name="ln-2038"></a>
<a name="ln-2039"></a>              <span class="c">! ___ functions ___</span>
<a name="ln-2040"></a>              <span class="n">fv1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Ji_3</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">Ji_3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv1_3</span><span class="p">))</span>
<a name="ln-2041"></a>              <span class="n">fv2</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">Ji</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Ji</span><span class="o">*</span><span class="n">fv1</span><span class="p">))</span>
<a name="ln-2042"></a>              <span class="c">! ___ Shear stress for production ___</span>
<a name="ln-2043"></a>              <span class="n">S</span> <span class="o">=</span> <span class="n">Omega</span>
<a name="ln-2044"></a>              <span class="n">inv_k2_d2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span><span class="o">*</span><span class="n">dist_i_2</span><span class="p">)</span>
<a name="ln-2045"></a>              <span class="n">Shat</span>      <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fv2</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-2046"></a>              <span class="n">Shat</span>      <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Shat</span><span class="p">,</span> <span class="mf">1.0e-10</span><span class="p">)</span>
<a name="ln-2047"></a>              <span class="n">inv_Shat</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Shat</span>
<a name="ln-2048"></a>              <span class="n">dfv1</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">Ji_2</span><span class="o">*</span><span class="n">cv1_3</span><span class="o">/</span><span class="p">(</span><span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="n">Ji_3</span><span class="o">+</span><span class="n">cv1_3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2049"></a>              <span class="n">dfv2</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="mf">1.0</span><span class="o">/</span><span class="n">nu</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ji_2</span><span class="o">*</span><span class="n">dfv1</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">Ji</span><span class="o">*</span><span class="n">fv1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2050"></a>              <span class="n">dShat</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv2</span><span class="o">+</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dfv2</span><span class="p">)</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-2051"></a>
<a name="ln-2052"></a>              <span class="n">D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">cb1</span><span class="o">*</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dShat</span><span class="o">+</span><span class="n">Shat</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-2053"></a>
<a name="ln-2054"></a>              <span class="c">! ___ Destruction term___ !</span>
<a name="ln-2055"></a>              <span class="n">r</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_k2_d2</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2056"></a>              <span class="n">g</span>    <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">cw2</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
<a name="ln-2057"></a>              <span class="n">g_6</span>  <span class="o">=</span> <span class="n">g</span><span class="o">**</span><span class="mi">6</span>
<a name="ln-2058"></a>              <span class="n">glim</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">g_6</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span>
<a name="ln-2059"></a>              <span class="n">fw</span>   <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">glim</span>
<a name="ln-2060"></a>              <span class="n">dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">Shat</span><span class="o">-</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">dShat</span><span class="p">)</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-2061"></a>              <span class="n">dg</span> <span class="o">=</span> <span class="n">dr</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cw2</span><span class="o">*</span><span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span>
<a name="ln-2062"></a>              <span class="n">dfw</span><span class="o">=</span> <span class="n">dg</span><span class="o">*</span><span class="n">glim</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">g_6</span><span class="o">/</span><span class="p">(</span><span class="n">g_6</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">))</span>
<a name="ln-2063"></a>
<a name="ln-2064"></a>              <span class="n">D</span> <span class="o">=</span> <span class="n">D</span><span class="o">+</span><span class="n">cw1</span><span class="o">*</span><span class="p">(</span><span class="n">dfw</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="n">dist_i_2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-2065"></a>              <span class="c">! --  end of source term -- !</span>
<a name="ln-2066"></a>
<a name="ln-2067"></a>              <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-2068"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2069"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2070"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-2071"></a>
<a name="ln-2072"></a>            <span class="k">end do</span>
<a name="ln-2073"></a><span class="k">          end do</span>
<a name="ln-2074"></a><span class="k">        end do</span>
<a name="ln-2075"></a><span class="k">        </span>
<a name="ln-2076"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2077"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2078"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2079"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2080"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2081"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2082"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2083"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2084"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2085"></a>              
<a name="ln-2086"></a>              <span class="c">! add new change into conservative solution</span>
<a name="ln-2087"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2088"></a>
<a name="ln-2089"></a>              <span class="c">! convert back conservative to primitive</span>
<a name="ln-2090"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2091"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2092"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2093"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2094"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-2095"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2096"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="mf">1.e-8</span><span class="p">)</span>
<a name="ln-2097"></a>            <span class="k">end do</span>
<a name="ln-2098"></a><span class="k">          end do</span>
<a name="ln-2099"></a><span class="k">        end do</span>
<a name="ln-2100"></a>
<a name="ln-2101"></a><span class="k">    end subroutine </span><span class="n">update_SA_variables</span>
<a name="ln-2102"></a>
<a name="ln-2103"></a>
<a name="ln-2104"></a>    <span class="k">function </span><span class="n">SAFlux</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a name="ln-2105"></a>      <span class="c">!&lt; calculate the total flux through face for turbulent flow (SA)</span>
<a name="ln-2106"></a>      <span class="c">!---------------------------------------</span>
<a name="ln-2107"></a>      <span class="k">implicit none</span>
<a name="ln-2108"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span> <span class="c">!left state</span>
<a name="ln-2109"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span> <span class="c">!right state</span>
<a name="ln-2110"></a>      <span class="c">!conservative form of updated neighbour</span>
<a name="ln-2111"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">du</span>
<a name="ln-2112"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-2113"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">Flux</span>
<a name="ln-2114"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">SAFlux</span>
<a name="ln-2115"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">U</span> <span class="c">! conservative variables</span>
<a name="ln-2116"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">W</span> <span class="c">! new primitive variables</span>
<a name="ln-2117"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">P</span> <span class="c">! primitive variables of right cell</span>
<a name="ln-2118"></a>
<a name="ln-2119"></a>      <span class="c">!for extraction of the inputs</span>
<a name="ln-2120"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">area</span>
<a name="ln-2121"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-2122"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-2123"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-2124"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-2125"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-2126"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-2127"></a>
<a name="ln-2128"></a>
<a name="ln-2129"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudx</span>
<a name="ln-2130"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudy</span>
<a name="ln-2131"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudz</span>
<a name="ln-2132"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdx</span>
<a name="ln-2133"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-2134"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdz</span>
<a name="ln-2135"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdx</span>
<a name="ln-2136"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdy</span>
<a name="ln-2137"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdz</span>
<a name="ln-2138"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdx</span>
<a name="ln-2139"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdy</span>
<a name="ln-2140"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdz</span>
<a name="ln-2141"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtvdx</span>
<a name="ln-2142"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtvdy</span>
<a name="ln-2143"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtvdz</span>
<a name="ln-2144"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span>
<a name="ln-2145"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">uface</span>
<a name="ln-2146"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">vface</span>
<a name="ln-2147"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">wface</span>
<a name="ln-2148"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">trace</span>
<a name="ln-2149"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxx</span>
<a name="ln-2150"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyy</span>
<a name="ln-2151"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauzz</span>
<a name="ln-2152"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxy</span>
<a name="ln-2153"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxz</span>
<a name="ln-2154"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyz</span>
<a name="ln-2155"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qx</span>
<a name="ln-2156"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qy</span>
<a name="ln-2157"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qz</span>
<a name="ln-2158"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-2159"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">RhoHt</span>
<a name="ln-2160"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">K_heat</span>
<a name="ln-2161"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2162"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-2163"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">muCap</span>
<a name="ln-2164"></a>
<a name="ln-2165"></a>      <span class="n">area</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2166"></a>      <span class="n">nx</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2167"></a>      <span class="n">ny</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2168"></a>      <span class="n">nz</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2169"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2170"></a>      <span class="n">mmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2171"></a>      <span class="n">tmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2172"></a>
<a name="ln-2173"></a>
<a name="ln-2174"></a>      <span class="c">!save the old stat in P</span>
<a name="ln-2175"></a>      <span class="n">P</span> <span class="o">=</span> <span class="n">qr</span>
<a name="ln-2176"></a>
<a name="ln-2177"></a>      <span class="c">! find conservative variable</span>
<a name="ln-2178"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2179"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2180"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2181"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2182"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2183"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2184"></a>
<a name="ln-2185"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">du</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>
<a name="ln-2186"></a>      
<a name="ln-2187"></a>
<a name="ln-2188"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2189"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2190"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2191"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2192"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-2193"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2194"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="err">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2195"></a>
<a name="ln-2196"></a>      <span class="n">FaceNormalVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span><span class="p">)</span>
<a name="ln-2197"></a>      <span class="n">uface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2198"></a>      <span class="n">vface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2199"></a>      <span class="n">wface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2200"></a>
<a name="ln-2201"></a>
<a name="ln-2202"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>   <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2203"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span>
<a name="ln-2204"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span>
<a name="ln-2205"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2206"></a>
<a name="ln-2207"></a>      <span class="n">HalfRhoUsquare</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2208"></a>      <span class="n">RhoHt</span>          <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">gm</span><span class="o">/</span><span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-2209"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>        <span class="o">=</span> <span class="n">RhoHt</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2210"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-2211"></a>
<a name="ln-2212"></a>
<a name="ln-2213"></a>      <span class="c">! viscous terms</span>
<a name="ln-2214"></a>      <span class="n">muCap</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2215"></a>      <span class="n">mu</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span>
<a name="ln-2216"></a>      <span class="n">T1</span>     <span class="o">=</span>    <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-2217"></a>      <span class="n">T2</span>     <span class="o">=</span>    <span class="n">P</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-2218"></a>      <span class="n">dTdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2219"></a>      <span class="n">dTdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2220"></a>      <span class="n">dTdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2221"></a>      <span class="n">dudx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2222"></a>      <span class="n">dudy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2223"></a>      <span class="n">dudz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2224"></a>      <span class="n">dvdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2225"></a>      <span class="n">dvdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2226"></a>      <span class="n">dvdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2227"></a>      <span class="n">dwdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2228"></a>      <span class="n">dwdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2229"></a>      <span class="n">dwdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2230"></a>      <span class="n">dtvdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2231"></a>      <span class="n">dtvdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2232"></a>      <span class="n">dtvdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2233"></a>
<a name="ln-2234"></a>      <span class="n">trace</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span> <span class="o">+</span> <span class="n">dwdz</span>
<a name="ln-2235"></a>      <span class="n">Tauxx</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dudx</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2236"></a>      <span class="n">Tauyy</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdy</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2237"></a>      <span class="n">Tauzz</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdz</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2238"></a>      <span class="n">Tauxy</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdx</span> <span class="o">+</span> <span class="n">dudy</span><span class="p">)</span>
<a name="ln-2239"></a>      <span class="n">Tauxz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdx</span> <span class="o">+</span> <span class="n">dudz</span><span class="p">)</span>
<a name="ln-2240"></a>      <span class="n">Tauyz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdy</span> <span class="o">+</span> <span class="n">dvdz</span><span class="p">)</span>
<a name="ln-2241"></a>
<a name="ln-2242"></a>      <span class="n">K_heat</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mmu</span> <span class="o">/</span> <span class="n">Pr</span>  <span class="o">+</span> <span class="n">tmu</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">*</span> <span class="n">gm</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="o">/</span> <span class="p">(</span> <span class="n">gm</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>
<a name="ln-2243"></a>      <span class="n">Qx</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdx</span>
<a name="ln-2244"></a>      <span class="n">Qy</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdy</span>
<a name="ln-2245"></a>      <span class="n">Qz</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdz</span>
<a name="ln-2246"></a>      <span class="n">tmu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2247"></a>
<a name="ln-2248"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2249"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2250"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2251"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
<a name="ln-2252"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qy</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
<a name="ln-2253"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qz</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span>
<a name="ln-2254"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">muCap</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtvdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtvdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtvdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_sa</span>
<a name="ln-2255"></a>
<a name="ln-2256"></a>      <span class="n">Flux</span>    <span class="o">=</span> <span class="n">Flux</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-2257"></a>      <span class="n">SAFlux</span> <span class="o">=</span> <span class="n">Flux</span>
<a name="ln-2258"></a>
<a name="ln-2259"></a>    <span class="k">end function </span><span class="n">SAFlux</span> 
<a name="ln-2260"></a>
<a name="ln-2261"></a>
<a name="ln-2262"></a>    <span class="k">subroutine </span><span class="n">update_lctm2015</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-2263"></a>      <span class="c">!&lt; Update the RANS (LCTM2015 transition model with SST2003) equation with LU-SGS</span>
<a name="ln-2264"></a>      <span class="k">implicit none</span>
<a name="ln-2265"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-2266"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-2267"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-2268"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-2269"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delta_t</span>
<a name="ln-2270"></a>      <span class="c">!&lt; Local time increment value at each cell center</span>
<a name="ln-2271"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-2272"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-2273"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-2274"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-2275"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-2276"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-2277"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-2278"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-2279"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-2280"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-2281"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-2282"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">deltaU</span>
<a name="ln-2283"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">D</span>
<a name="ln-2284"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">conservativeQ</span>
<a name="ln-2285"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldIminusFlux</span>
<a name="ln-2286"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldJminusFlux</span>
<a name="ln-2287"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">OldKminusFlux</span>
<a name="ln-2288"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewIminusFlux</span>
<a name="ln-2289"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewJminusFlux</span>
<a name="ln-2290"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">NewKminusFlux</span>
<a name="ln-2291"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelIminusFlux</span>
<a name="ln-2292"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelJminusFlux</span>
<a name="ln-2293"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DelKminusFlux</span>
<a name="ln-2294"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">LambdaTimesArea</span>
<a name="ln-2295"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q0</span> <span class="c">! state at cell</span>
<a name="ln-2296"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q1</span> <span class="c">! state at neighbours </span>
<a name="ln-2297"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q2</span>
<a name="ln-2298"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q3</span>
<a name="ln-2299"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q4</span>
<a name="ln-2300"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q5</span>
<a name="ln-2301"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Q6</span>
<a name="ln-2302"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ0</span><span class="c">! change in state</span>
<a name="ln-2303"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ1</span>
<a name="ln-2304"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ2</span>
<a name="ln-2305"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ3</span>
<a name="ln-2306"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ4</span>
<a name="ln-2307"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ5</span>
<a name="ln-2308"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">DQ6</span>
<a name="ln-2309"></a>
<a name="ln-2310"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist1</span>
<a name="ln-2311"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist2</span>
<a name="ln-2312"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist3</span>
<a name="ln-2313"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist4</span>
<a name="ln-2314"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist5</span>
<a name="ln-2315"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">Flist6</span>
<a name="ln-2316"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C0</span>
<a name="ln-2317"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C1</span>
<a name="ln-2318"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C2</span>
<a name="ln-2319"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C3</span>
<a name="ln-2320"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C4</span>
<a name="ln-2321"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C5</span>
<a name="ln-2322"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">C6</span>
<a name="ln-2323"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">beta</span>
<a name="ln-2324"></a>
<a name="ln-2325"></a>        <span class="c">! intermittency</span>
<a name="ln-2326"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fonset1</span>
<a name="ln-2327"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fonset2</span>
<a name="ln-2328"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fonset3</span>
<a name="ln-2329"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fonset</span>
<a name="ln-2330"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Rev</span>
<a name="ln-2331"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RT</span>
<a name="ln-2332"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fturb</span>
<a name="ln-2333"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Re_theta</span>
<a name="ln-2334"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">TuL</span>
<a name="ln-2335"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">strain</span>
<a name="ln-2336"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vort</span>
<a name="ln-2337"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Dp</span><span class="p">,</span> <span class="n">De</span>
<a name="ln-2338"></a>        <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-2339"></a>        <span class="n">Dp</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2340"></a>        <span class="n">De</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2341"></a>
<a name="ln-2342"></a>
<a name="ln-2343"></a>        <span class="c">!intialize delQ</span>
<a name="ln-2344"></a>        <span class="n">delQstar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2345"></a>
<a name="ln-2346"></a>        <span class="c">!forward sweep</span>
<a name="ln-2347"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2348"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2349"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2350"></a>              <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2351"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2352"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2353"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2354"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2355"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2356"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2357"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2358"></a>
<a name="ln-2359"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2360"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2361"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2362"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2363"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2364"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2365"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2366"></a>
<a name="ln-2367"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2368"></a>              <span class="n">DQ1</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2369"></a>              <span class="n">DQ2</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2370"></a>              <span class="n">DQ3</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2371"></a>
<a name="ln-2372"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2373"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2374"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2375"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2376"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2377"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2378"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2379"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2380"></a>
<a name="ln-2381"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2382"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2383"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2384"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2385"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2386"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2387"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2388"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2389"></a>
<a name="ln-2390"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2391"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2392"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2393"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2394"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2395"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2396"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2397"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2398"></a>
<a name="ln-2399"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2400"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2401"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2402"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2403"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2404"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2405"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2406"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2407"></a>
<a name="ln-2408"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2409"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2410"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2411"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2412"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2413"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2414"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2415"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2416"></a>
<a name="ln-2417"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2418"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2419"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2420"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2421"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2422"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2423"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2424"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2425"></a>
<a name="ln-2426"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ1</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-2427"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ2</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-2428"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ3</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-2429"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">)</span>
<a name="ln-2430"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">)</span>
<a name="ln-2431"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">)</span>
<a name="ln-2432"></a>
<a name="ln-2433"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2434"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2435"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2436"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2437"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2438"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2439"></a>
<a name="ln-2440"></a>
<a name="ln-2441"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-2442"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-2443"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-2444"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-2445"></a>
<a name="ln-2446"></a>
<a name="ln-2447"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-2448"></a>              <span class="n">beta</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">beta1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">beta2</span>
<a name="ln-2449"></a>              <span class="c">!D(6) = (D(6) + bstar*qp(i,j,k,7)*cells(i,j,k)%volume)</span>
<a name="ln-2450"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bstar</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2451"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2452"></a>              <span class="c">!gamma</span>
<a name="ln-2453"></a>              <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2454"></a>                              <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2455"></a>                              <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2456"></a>                               <span class="p">)&amp;</span>
<a name="ln-2457"></a>                         <span class="p">)</span>
<a name="ln-2458"></a>
<a name="ln-2459"></a>              <span class="n">strain</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2460"></a>                                <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2461"></a>                                <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2462"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2463"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2464"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2465"></a>                                 <span class="p">)&amp;</span>
<a name="ln-2466"></a>                           <span class="p">)</span>
<a name="ln-2467"></a>              <span class="n">TuL</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)),</span><span class="mi">10</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2468"></a>              <span class="n">Re_theta</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span> <span class="o">+</span> <span class="mi">100</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">TuL</span><span class="p">)</span>
<a name="ln-2469"></a>              <span class="n">Rev</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">strain</span><span class="o">/</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2470"></a>              <span class="n">RT</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2471"></a>              <span class="n">Fturb</span> <span class="o">=</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Rt</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2472"></a>              <span class="n">Fonset1</span> <span class="o">=</span> <span class="n">Rev</span><span class="o">/</span><span class="p">(</span><span class="mf">2.2</span><span class="o">*</span><span class="n">Re_theta</span><span class="p">)</span>
<a name="ln-2473"></a>              <span class="n">Fonset2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Fonset1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a name="ln-2474"></a>              <span class="n">Fonset3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">RT</span><span class="o">/</span><span class="mf">3.5</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2475"></a>              <span class="n">Fonset</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Fonset2</span> <span class="o">-</span> <span class="n">Fonset3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2476"></a>              <span class="n">Dp</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">strain</span><span class="o">*</span><span class="n">Fonset</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2477"></a>              <span class="n">De</span> <span class="o">=</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">vort</span><span class="o">*</span><span class="n">Fturb</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="mi">5</span><span class="mf">0.0</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
<a name="ln-2478"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">Dp</span> <span class="o">+</span> <span class="n">DE</span> <span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2479"></a>              <span class="c">!storing D in Iflux array for backward sweep</span>
<a name="ln-2480"></a>
<a name="ln-2481"></a>              <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-2482"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2483"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2484"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-2485"></a>
<a name="ln-2486"></a>              <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">deltaU</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-2487"></a>            <span class="k">end do</span>
<a name="ln-2488"></a><span class="k">          end do</span>
<a name="ln-2489"></a><span class="k">        end do</span>
<a name="ln-2490"></a>
<a name="ln-2491"></a><span class="k">        </span><span class="n">delQ</span><span class="o">=</span><span class="mf">0.0</span>
<a name="ln-2492"></a>        <span class="c">!backward sweep</span>
<a name="ln-2493"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2494"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2495"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2496"></a>              <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2497"></a>              <span class="n">C0</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2498"></a>              <span class="n">C1</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2499"></a>              <span class="n">C2</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2500"></a>              <span class="n">C3</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2501"></a>              <span class="n">C4</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2502"></a>              <span class="n">C5</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2503"></a>              <span class="n">C6</span>  <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerx</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centery</span><span class="p">,</span><span class="n">Cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">Centerz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2504"></a>
<a name="ln-2505"></a>              <span class="n">Q0</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2506"></a>              <span class="n">Q1</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2507"></a>              <span class="n">Q2</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2508"></a>              <span class="n">Q3</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2509"></a>              <span class="n">Q4</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2510"></a>              <span class="n">Q5</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2511"></a>              <span class="n">Q6</span>  <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2512"></a>
<a name="ln-2513"></a>              <span class="n">DQ0</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2514"></a>              <span class="n">DQ4</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2515"></a>              <span class="n">DQ5</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2516"></a>              <span class="n">DQ6</span> <span class="o">=</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2517"></a>
<a name="ln-2518"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2519"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2520"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2521"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2522"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2523"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2524"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2525"></a>              <span class="n">Flist1</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2526"></a>
<a name="ln-2527"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2528"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2529"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2530"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2531"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2532"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2533"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2534"></a>              <span class="n">Flist2</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2535"></a>
<a name="ln-2536"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2537"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2538"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2539"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2540"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2541"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2542"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2543"></a>              <span class="n">Flist3</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2544"></a>
<a name="ln-2545"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2546"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2547"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2548"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2549"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2550"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2551"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2552"></a>              <span class="n">Flist4</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2553"></a>
<a name="ln-2554"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2555"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2556"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2557"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2558"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2559"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2560"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2561"></a>              <span class="n">Flist5</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span>  <span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2562"></a>
<a name="ln-2563"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-2564"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span>
<a name="ln-2565"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span>
<a name="ln-2566"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span>
<a name="ln-2567"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">volume</span> <span class="o">+</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2568"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">mmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">mmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2569"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>   <span class="n">tmu</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span>    <span class="n">tmu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2570"></a>              <span class="n">Flist6</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span> <span class="n">j</span>  <span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2571"></a>
<a name="ln-2572"></a>              <span class="n">NewIminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ4</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-2573"></a>              <span class="n">NewJminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ5</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-2574"></a>              <span class="n">NewKminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ6</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-2575"></a>              <span class="n">OldIminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">)</span>
<a name="ln-2576"></a>              <span class="n">OldJminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">)</span>
<a name="ln-2577"></a>              <span class="n">OldKminusFlux</span>     <span class="o">=</span> <span class="n">lctm2015Flux</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">DQ0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">)</span>
<a name="ln-2578"></a>
<a name="ln-2579"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q1</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2580"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q2</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist2</span><span class="p">,</span> <span class="n">C2</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2581"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q3</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist3</span><span class="p">,</span> <span class="n">C3</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2582"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q4</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist4</span><span class="p">,</span> <span class="n">C4</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2583"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q5</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist5</span><span class="p">,</span> <span class="n">C5</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2584"></a>              <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">=</span> <span class="n">SpectralRadius</span><span class="p">(</span><span class="n">Q6</span><span class="p">,</span> <span class="n">Q0</span><span class="p">,</span> <span class="n">Flist6</span><span class="p">,</span> <span class="n">C6</span><span class="p">,</span> <span class="n">C0</span><span class="p">)</span>
<a name="ln-2585"></a>
<a name="ln-2586"></a>
<a name="ln-2587"></a>              <span class="c">! multiply above flux with area to get correct values</span>
<a name="ln-2588"></a>              <span class="n">DelIminusFlux</span> <span class="o">=</span>  <span class="n">NewIminusFlux</span> <span class="o">-</span> <span class="n">OldIminusFlux</span>
<a name="ln-2589"></a>              <span class="n">DelJminusFlux</span> <span class="o">=</span>  <span class="n">NewJminusFlux</span> <span class="o">-</span> <span class="n">OldJminusFlux</span>
<a name="ln-2590"></a>              <span class="n">DelKminusFlux</span> <span class="o">=</span>  <span class="n">NewKminusFlux</span> <span class="o">-</span> <span class="n">OldKminusFlux</span>
<a name="ln-2591"></a>
<a name="ln-2592"></a>              <span class="n">D</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="o">/</span><span class="n">delta_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">SUM</span><span class="p">(</span><span class="n">LambdaTimesArea</span><span class="p">)</span>
<a name="ln-2593"></a>              <span class="n">beta</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">beta1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">beta2</span>
<a name="ln-2594"></a>              <span class="c">!D(6) = (D(6) + bstar*qp(i,j,k,7)*cells(i,j,k)%volume)</span>
<a name="ln-2595"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bstar</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2596"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">beta</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2597"></a>              <span class="c">!gamma</span>
<a name="ln-2598"></a>              <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2599"></a>                              <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2600"></a>                              <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2601"></a>                               <span class="p">)&amp;</span>
<a name="ln-2602"></a>                         <span class="p">)</span>
<a name="ln-2603"></a>
<a name="ln-2604"></a>              <span class="n">strain</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2605"></a>                                <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2606"></a>                                <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2607"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2608"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2609"></a>                                <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-2610"></a>                                 <span class="p">)&amp;</span>
<a name="ln-2611"></a>                           <span class="p">)</span>
<a name="ln-2612"></a>              <span class="n">TuL</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)),</span><span class="mi">10</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2613"></a>              <span class="n">Re_theta</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span> <span class="o">+</span> <span class="mi">100</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">TuL</span><span class="p">)</span>
<a name="ln-2614"></a>              <span class="n">Rev</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">strain</span><span class="o">/</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2615"></a>              <span class="n">RT</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2616"></a>              <span class="n">Fturb</span> <span class="o">=</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Rt</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2617"></a>              <span class="n">Fonset1</span> <span class="o">=</span> <span class="n">Rev</span><span class="o">/</span><span class="p">(</span><span class="mf">2.2</span><span class="o">*</span><span class="n">Re_theta</span><span class="p">)</span>
<a name="ln-2618"></a>              <span class="n">Fonset2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Fonset1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a name="ln-2619"></a>              <span class="n">Fonset3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">RT</span><span class="o">/</span><span class="mf">3.5</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2620"></a>              <span class="n">Fonset</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Fonset2</span> <span class="o">-</span> <span class="n">Fonset3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2621"></a>              <span class="n">Dp</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">strain</span><span class="o">*</span><span class="n">Fonset</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2622"></a>              <span class="n">De</span> <span class="o">=</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">vort</span><span class="o">*</span><span class="n">Fturb</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="mi">5</span><span class="mf">0.0</span><span class="o">*</span><span class="n">Q0</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
<a name="ln-2623"></a>              <span class="n">D</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">Dp</span> <span class="o">+</span> <span class="n">DE</span> <span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-2624"></a>
<a name="ln-2625"></a>              <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">delQstar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-2626"></a>                <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">DelIminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2627"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelJminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-2628"></a>                     <span class="o">+</span> <span class="p">(</span><span class="n">DelKminusFlux</span> <span class="o">-</span> <span class="n">LambdaTimesArea</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">))</span> <span class="p">)</span><span class="o">/</span><span class="n">D</span>
<a name="ln-2629"></a>
<a name="ln-2630"></a>            <span class="k">end do</span>
<a name="ln-2631"></a><span class="k">          end do</span>
<a name="ln-2632"></a><span class="k">        end do</span>
<a name="ln-2633"></a><span class="k">        </span>
<a name="ln-2634"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2635"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2636"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2637"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2638"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2639"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2640"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2641"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2642"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2643"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2644"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2645"></a>              
<a name="ln-2646"></a>              <span class="c">! add new change into conservative solution</span>
<a name="ln-2647"></a>              <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">delQ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>
<a name="ln-2648"></a>
<a name="ln-2649"></a>              <span class="c">! convert back conservative to primitive</span>
<a name="ln-2650"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2651"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2652"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2653"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2654"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-2655"></a><span class="c">!              qp(i,j,k,6) = conservativeQ(6) / conservativeQ(1)</span>
<a name="ln-2656"></a><span class="c">!              qp(i,j,k,7) = conservativeQ(7) / conservativeQ(1)</span>
<a name="ln-2657"></a>              <span class="k">if</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-2658"></a><span class="k">              </span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2659"></a>              <span class="k">end if</span>
<a name="ln-2660"></a><span class="k">              if</span><span class="p">(</span><span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-2661"></a><span class="k">              </span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2662"></a>              <span class="k">end if</span>
<a name="ln-2663"></a><span class="k">              </span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">conservativeQ</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2664"></a>              <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2665"></a>              <span class="c">!qp(i,j,k,8) = min(qp(i,j,k,8), 1.0)</span>
<a name="ln-2666"></a>            <span class="k">end do</span>
<a name="ln-2667"></a><span class="k">          end do</span>
<a name="ln-2668"></a><span class="k">        end do</span>
<a name="ln-2669"></a><span class="k">    end subroutine </span><span class="n">update_lctm2015</span>
<a name="ln-2670"></a>
<a name="ln-2671"></a>    <span class="k">function </span><span class="n">lctm2015flux</span><span class="p">(</span><span class="n">ql</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<a name="ln-2672"></a>      <span class="c">!&lt; calculate the total flux through face for turbulent/transition flow (LCTM2015)</span>
<a name="ln-2673"></a>      <span class="c">!---------------------------------------</span>
<a name="ln-2674"></a>      <span class="k">implicit none</span>
<a name="ln-2675"></a><span class="k">      </span><span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span> <span class="c">!left state</span>
<a name="ln-2676"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qr</span> <span class="c">!right state</span>
<a name="ln-2677"></a>      <span class="c">!conservative form of updated neighbour</span>
<a name="ln-2678"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">du</span>
<a name="ln-2679"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span>    <span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inputs</span>
<a name="ln-2680"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">Flux</span>
<a name="ln-2681"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">lctm2015flux</span>
<a name="ln-2682"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">U</span> <span class="c">! conservative variables</span>
<a name="ln-2683"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">W</span> <span class="c">! new primitive variables</span>
<a name="ln-2684"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">P</span> <span class="c">! primitive variables of right cell</span>
<a name="ln-2685"></a>
<a name="ln-2686"></a>      <span class="c">!for extraction of the inputs</span>
<a name="ln-2687"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">area</span>
<a name="ln-2688"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nx</span>
<a name="ln-2689"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ny</span>
<a name="ln-2690"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nz</span>
<a name="ln-2691"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-2692"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">mmu</span>
<a name="ln-2693"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tmu</span>
<a name="ln-2694"></a>
<a name="ln-2695"></a>
<a name="ln-2696"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudx</span>
<a name="ln-2697"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudy</span>
<a name="ln-2698"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dudz</span>
<a name="ln-2699"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdx</span>
<a name="ln-2700"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-2701"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dvdz</span>
<a name="ln-2702"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdx</span>
<a name="ln-2703"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdy</span>
<a name="ln-2704"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dwdz</span>
<a name="ln-2705"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdx</span>
<a name="ln-2706"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdy</span>
<a name="ln-2707"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dTdz</span>
<a name="ln-2708"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdx</span>
<a name="ln-2709"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdy</span>
<a name="ln-2710"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtkdz</span>
<a name="ln-2711"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdx</span>
<a name="ln-2712"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdy</span>
<a name="ln-2713"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtwdz</span>
<a name="ln-2714"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtgmdx</span>
<a name="ln-2715"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtgmdy</span>
<a name="ln-2716"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dtgmdz</span>
<a name="ln-2717"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">T1</span><span class="p">,</span> <span class="n">T2</span>
<a name="ln-2718"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">uface</span>
<a name="ln-2719"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">vface</span>
<a name="ln-2720"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">wface</span>
<a name="ln-2721"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">trace</span>
<a name="ln-2722"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxx</span>
<a name="ln-2723"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyy</span>
<a name="ln-2724"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauzz</span>
<a name="ln-2725"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxy</span>
<a name="ln-2726"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauxz</span>
<a name="ln-2727"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Tauyz</span>
<a name="ln-2728"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qx</span>
<a name="ln-2729"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qy</span>
<a name="ln-2730"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">Qz</span>
<a name="ln-2731"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-2732"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">RhoHt</span>
<a name="ln-2733"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">K_heat</span>
<a name="ln-2734"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2735"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">mu</span>
<a name="ln-2736"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">sigma_k</span>
<a name="ln-2737"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">sigma_w</span>
<a name="ln-2738"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">F1</span>
<a name="ln-2739"></a>
<a name="ln-2740"></a>      <span class="n">area</span>   <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2741"></a>      <span class="n">nx</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2742"></a>      <span class="n">ny</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2743"></a>      <span class="n">nz</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2744"></a>      <span class="n">volume</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2745"></a>      <span class="n">mmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2746"></a>      <span class="n">tmu</span>    <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2747"></a>      <span class="n">F1</span>     <span class="o">=</span> <span class="n">inputs</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2748"></a>
<a name="ln-2749"></a>
<a name="ln-2750"></a>      <span class="c">!save the old stat in P</span>
<a name="ln-2751"></a>      <span class="n">P</span> <span class="o">=</span> <span class="n">qr</span>
<a name="ln-2752"></a>
<a name="ln-2753"></a>      <span class="c">! find conservative variable</span>
<a name="ln-2754"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2755"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2756"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2757"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2758"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span> <span class="n">ql</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2759"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2760"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2761"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">ql</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ql</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2762"></a>
<a name="ln-2763"></a>      <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">=</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">du</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_var</span><span class="p">)</span>
<a name="ln-2764"></a>      
<a name="ln-2765"></a>
<a name="ln-2766"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2767"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2768"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2769"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2770"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="o">=</span> <span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">U</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">SUM</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-2771"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2772"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2773"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>   <span class="o">=</span>   <span class="n">U</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="n">U</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2774"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>   <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2775"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>   <span class="o">=</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="n">ql</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">-</span><span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2776"></a>      <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2777"></a>      <span class="c">!W(8) = min(W(8), 1.0)</span>
<a name="ln-2778"></a>
<a name="ln-2779"></a>      <span class="n">FaceNormalVelocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span><span class="p">)</span>
<a name="ln-2780"></a>      <span class="n">uface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2781"></a>      <span class="n">vface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2782"></a>      <span class="n">wface</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2783"></a>
<a name="ln-2784"></a>
<a name="ln-2785"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>   <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2786"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="p">)</span>
<a name="ln-2787"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="p">)</span>
<a name="ln-2788"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2789"></a>
<a name="ln-2790"></a>      <span class="n">HalfRhoUsquare</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2791"></a>      <span class="n">RhoHt</span>          <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">gm</span><span class="o">/</span><span class="p">(</span><span class="n">gm</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span> <span class="o">*</span> <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">)</span> <span class="o">+</span> <span class="n">HalfRhoUsquare</span>
<a name="ln-2792"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>        <span class="o">=</span> <span class="n">RhoHt</span> <span class="o">*</span> <span class="n">FaceNormalVelocity</span>
<a name="ln-2793"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-2794"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-2795"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span>   
<a name="ln-2796"></a>
<a name="ln-2797"></a>
<a name="ln-2798"></a>      <span class="c">! viscous terms</span>
<a name="ln-2799"></a>      <span class="n">mu</span> <span class="o">=</span> <span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span>
<a name="ln-2800"></a>      <span class="n">T1</span>     <span class="o">=</span>    <span class="n">W</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">W</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-2801"></a>      <span class="n">T2</span>     <span class="o">=</span>    <span class="n">P</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="p">)</span>
<a name="ln-2802"></a>      <span class="n">dTdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2803"></a>      <span class="n">dTdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2804"></a>      <span class="n">dTdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">T2</span>   <span class="o">-</span> <span class="n">T1</span>   <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2805"></a>      <span class="n">dudx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2806"></a>      <span class="n">dudy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2807"></a>      <span class="n">dudz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2808"></a>      <span class="n">dvdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2809"></a>      <span class="n">dvdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2810"></a>      <span class="n">dvdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2811"></a>      <span class="n">dwdx</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2812"></a>      <span class="n">dwdy</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2813"></a>      <span class="n">dwdz</span>   <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2814"></a>      <span class="n">dtkdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2815"></a>      <span class="n">dtkdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2816"></a>      <span class="n">dtkdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2817"></a>      <span class="n">dtwdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2818"></a>      <span class="n">dtwdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2819"></a>      <span class="n">dtwdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2820"></a>      <span class="n">dtgmdx</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2821"></a>      <span class="n">dtgmdy</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2822"></a>      <span class="n">dtgmdz</span>  <span class="o">=</span>  <span class="p">(</span> <span class="n">P</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">W</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span> <span class="o">*</span> <span class="n">Area</span> <span class="o">/</span> <span class="n">Volume</span>
<a name="ln-2823"></a>
<a name="ln-2824"></a>      <span class="n">trace</span> <span class="o">=</span> <span class="n">dudx</span> <span class="o">+</span> <span class="n">dvdy</span> <span class="o">+</span> <span class="n">dwdz</span>
<a name="ln-2825"></a>      <span class="n">Tauxx</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dudx</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2826"></a>      <span class="n">Tauyy</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdy</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2827"></a>      <span class="n">Tauzz</span> <span class="o">=</span>  <span class="mf">2.</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdz</span> <span class="o">-</span> <span class="n">trace</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
<a name="ln-2828"></a>      <span class="n">Tauxy</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dvdx</span> <span class="o">+</span> <span class="n">dudy</span><span class="p">)</span>
<a name="ln-2829"></a>      <span class="n">Tauxz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdx</span> <span class="o">+</span> <span class="n">dudz</span><span class="p">)</span>
<a name="ln-2830"></a>      <span class="n">Tauyz</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="p">(</span><span class="n">dwdy</span> <span class="o">+</span> <span class="n">dvdz</span><span class="p">)</span>
<a name="ln-2831"></a>
<a name="ln-2832"></a>      <span class="n">K_heat</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mmu</span> <span class="o">/</span> <span class="n">Pr</span>  <span class="o">+</span> <span class="n">tmu</span><span class="o">/</span><span class="n">tpr</span><span class="p">)</span> <span class="o">*</span> <span class="n">gm</span> <span class="o">*</span> <span class="n">R_gas</span> <span class="o">/</span> <span class="p">(</span> <span class="n">gm</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="p">)</span>
<a name="ln-2833"></a>      <span class="n">Qx</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdx</span>
<a name="ln-2834"></a>      <span class="n">Qy</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdy</span>
<a name="ln-2835"></a>      <span class="n">Qz</span> <span class="o">=</span> <span class="n">K_heat</span><span class="o">*</span><span class="n">dTdz</span>
<a name="ln-2836"></a>
<a name="ln-2837"></a>      <span class="n">sigma_k</span> <span class="o">=</span> <span class="n">sigma_k1</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">sigma_k2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-2838"></a>      <span class="n">sigma_w</span> <span class="o">=</span> <span class="n">sigma_w1</span><span class="o">*</span><span class="n">F1</span> <span class="o">+</span> <span class="n">sigma_w2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-2839"></a>
<a name="ln-2840"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2841"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2842"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">nx</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">nz</span> <span class="p">)</span>
<a name="ln-2843"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxx</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qx</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nx</span>
<a name="ln-2844"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxy</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyy</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qy</span> <span class="p">)</span> <span class="o">*</span> <span class="n">ny</span>
<a name="ln-2845"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">Tauxz</span> <span class="o">*</span> <span class="n">uface</span> <span class="o">+</span> <span class="n">Tauyz</span> <span class="o">*</span> <span class="n">vface</span> <span class="o">+</span> <span class="n">Tauzz</span> <span class="o">*</span> <span class="n">wface</span> <span class="o">+</span> <span class="n">Qz</span> <span class="p">)</span> <span class="o">*</span> <span class="n">nz</span>
<a name="ln-2846"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_k</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtkdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtkdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtkdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-2847"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">sigma_w</span><span class="o">*</span><span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtwdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtwdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtwdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-2848"></a>      <span class="n">Flux</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">Flux</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">mmu</span> <span class="o">+</span> <span class="n">tmu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dtgmdx</span><span class="o">*</span><span class="n">nx</span> <span class="o">+</span> <span class="n">dtgmdy</span><span class="o">*</span><span class="n">ny</span> <span class="o">+</span> <span class="n">dtgmdz</span><span class="o">*</span><span class="n">nz</span><span class="p">)</span>
<a name="ln-2849"></a>
<a name="ln-2850"></a>      <span class="n">Flux</span>    <span class="o">=</span> <span class="n">Flux</span> <span class="o">*</span> <span class="n">Area</span>
<a name="ln-2851"></a>      <span class="n">lctm2015flux</span> <span class="o">=</span> <span class="n">Flux</span>
<a name="ln-2852"></a>    <span class="k">end function </span><span class="n">lctm2015flux</span>
<a name="ln-2853"></a>
<a name="ln-2854"></a>
<a name="ln-2855"></a><span class="k">end module </span><span class="n">lusgs</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2019 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2020-02-10T20:32:54.471560 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> FEST-3D was developed by FEST-3D Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>