<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
   <meta name="description" content="">
    
    <meta name="author" content="FEST-3D Team" >
    <link rel="icon" href="../favicon.png">

    <title>source.f90 &ndash; FEST-3D</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

   <!-- Global site tag (gtag.js) - Google Analytics -->
   <script async src="https://www.googletagmanager.com/gtag/js?id=UA-140495700-1"></script>
   <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
   
     gtag('config', 'UA-140495700-1');
   </script>


  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">FEST-3D </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li><a href='../page/index.html'>Documentation</a></li>
      
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/main.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/main.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>source.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 4.4% of total for source files.">693 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/source.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">source.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/source.html">source</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/source.f90.html#src">source.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      <p>Add source's contribution to the residual</p>
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~source.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilesourcef90EfferentGraph" width="399pt" height="394pt"
 viewBox="0.00 0.00 399.00 394.08" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~source.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 390.082)">
<title>sourcefile~~source.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-390.082 395,-390.082 395,4 -4,4"/>
<!-- sourcefile~source.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~source.f90</title>
<polygon fill="none" stroke="#000000" points="391,-296.8981 328,-296.8981 328,-272.8981 391,-272.8981 391,-296.8981"/>
<text text-anchor="middle" x="359.5" y="-282.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">source.f90</text>
</g>
<!-- sourcefile~global_sa.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~global_sa.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/global_sa.f90.html" xlink:title="global_sa.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="184.5,-296.8981 108.5,-296.8981 108.5,-272.8981 184.5,-272.8981 184.5,-296.8981"/>
<text text-anchor="middle" x="146.5" y="-282.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_sa.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~global_sa.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~global_sa.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-284.8981C236.5919,-284.8981 214.0636,-284.8981 194.7013,-284.8981"/>
<polygon fill="#ff0000" stroke="#ff0000" points="194.5993,-281.3982 184.5992,-284.8981 194.5992,-288.3982 194.5993,-281.3982"/>
</g>
<!-- sourcefile~gradients.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~gradients.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/gradients.f90.html" xlink:title="gradients.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="184,-254.8981 109,-254.8981 109,-230.8981 184,-230.8981 184,-254.8981"/>
<text text-anchor="middle" x="146.5" y="-240.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">gradients.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~gradients.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~gradients.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M327.6424,-284.8981C307.4091,-284.8981 280.6675,-284.8981 257,-284.8981"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-284.8981C241.9204,-284.8981 207.7416,-271.0584 181.3599,-259.2679"/>
<polygon fill="#ff0000" stroke="#ff0000" points="182.596,-255.9855 172.0429,-255.0462 179.7069,-262.3615 182.596,-255.9855"/>
</g>
<!-- sourcefile~viscosity.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~viscosity.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/viscosity.f90.html" xlink:title="viscosity.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="292,-214.8981 222,-214.8981 222,-190.8981 292,-190.8981 292,-214.8981"/>
<text text-anchor="middle" x="257" y="-200.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">viscosity.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~viscosity.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~viscosity.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M344.3758,-272.7987C327.4189,-259.2332 299.7266,-237.0794 280.0659,-221.3508"/>
<polygon fill="#ff0000" stroke="#ff0000" points="282.1814,-218.5611 272.1863,-215.0471 277.8085,-224.0272 282.1814,-218.5611"/>
</g>
<!-- sourcefile~wall_dist.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~wall_dist.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/wall_dist.f90.html" xlink:title="wall_dist.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="182,-338.8981 111,-338.8981 111,-314.8981 182,-314.8981 182,-338.8981"/>
<text text-anchor="middle" x="146.5" y="-324.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">wall_dist.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~wall_dist.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~wall_dist.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-284.8981C241.9204,-284.8981 207.7416,-298.7378 181.3599,-310.5283"/>
<polygon fill="#ff0000" stroke="#ff0000" points="179.7069,-307.4346 172.0429,-314.75 182.596,-313.8106 179.7069,-307.4346"/>
</g>
<!-- sourcefile~cc.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~cc.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/cc.f90.html" xlink:title="CC.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="284,-338.8981 230,-338.8981 230,-314.8981 284,-314.8981 284,-338.8981"/>
<text text-anchor="middle" x="257" y="-324.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">CC.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~cc.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~cc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M330.1276,-296.9336C318.738,-301.6006 305.5736,-306.9947 293.5799,-311.9093"/>
<polygon fill="#ff0000" stroke="#ff0000" points="292.1946,-308.6944 284.2683,-315.7247 294.8487,-315.1717 292.1946,-308.6944"/>
</g>
<!-- sourcefile~global_kkl.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~global_kkl.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/global_kkl.f90.html" xlink:title="global_kkl.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185.5,-94.8981 107.5,-94.8981 107.5,-70.8981 185.5,-70.8981 185.5,-94.8981"/>
<text text-anchor="middle" x="146.5" y="-80.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_kkl.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~global_kkl.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~global_kkl.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-40.8981C250.3353,-36.4979 210.924,-52.9757 181.0515,-66.5695"/>
<polygon fill="#ff0000" stroke="#ff0000" points="179.364,-63.4932 171.7414,-70.8517 182.2891,-69.8528 179.364,-63.4932"/>
</g>
<!-- sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~utils.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/utils.f90.html" xlink:title="utils.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="62.5,-358.8981 8.5,-358.8981 8.5,-334.8981 62.5,-334.8981 62.5,-358.8981"/>
<text text-anchor="middle" x="35.5" y="-344.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">utils.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M349.3096,-297.317C337.0782,-311.4646 315.2849,-334.3684 292,-347.8981 249.3377,-372.6871 234.7806,-373.4805 186,-380.8981 151.2879,-386.1765 141.2499,-388.6268 107,-380.8981 91.895,-377.4896 76.2379,-370.4967 63.4398,-363.7342"/>
<polygon fill="#ff0000" stroke="#ff0000" points="65.1226,-360.6653 54.6749,-358.9053 61.7447,-366.7964 65.1226,-360.6653"/>
</g>
<!-- sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~vartypes.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/vartypes.f90.html" xlink:title="vartypes.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="71,-214.8981 0,-214.8981 0,-190.8981 71,-190.8981 71,-214.8981"/>
<text text-anchor="middle" x="35.5" y="-200.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">vartypes.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M358.8408,-272.8936C355.8532,-231.6932 339.8226,-95.58 257,-40.8981"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-40.8981C200.8227,-3.8082 162.5908,18.0653 107,-19.8981 79.2861,-38.8241 51.9327,-136.7767 40.7598,-181.0856"/>
<polygon fill="#ff0000" stroke="#ff0000" points="37.3415,-180.3292 38.335,-190.8773 44.1362,-182.0119 37.3415,-180.3292"/>
</g>
<!-- sourcefile~global_sst.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~global_sst.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/global_sst.f90.html" xlink:title="global_sst.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="186,-52.8981 107,-52.8981 107,-28.8981 186,-28.8981 186,-52.8981"/>
<text text-anchor="middle" x="146.5" y="-38.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">global_sst.f90</text>
</a>
</g>
</g>
<!-- sourcefile~source.f90&#45;&gt;sourcefile~global_sst.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~source.f90&#45;&gt;sourcefile~global_sst.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M257,-40.8981C239.4011,-29.2788 216.5414,-27.6383 196.1839,-29.5491"/>
<polygon fill="#ff0000" stroke="#ff0000" points="195.6137,-26.0928 186.1174,-30.7908 196.4707,-33.0402 195.6137,-26.0928"/>
</g>
<!-- sourcefile~gradients.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~gradients.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#ffaa00" stroke-dasharray="5,2" d="M120.5557,-254.9062C115.8468,-257.5742 111.1259,-260.6013 107,-263.8981 84.1438,-282.1616 62.9393,-308.4452 49.6542,-326.516"/>
<polygon fill="#ffaa00" stroke="#ffaa00" points="46.7964,-324.4952 43.796,-334.6563 52.4781,-328.584 46.7964,-324.4952"/>
</g>
<!-- sourcefile~gradients.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~gradients.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ffaa00" stroke-dasharray="5,2" d="M113.1963,-230.8968C102.3204,-226.9775 90.0829,-222.5676 78.5931,-218.4271"/>
<polygon fill="#ffaa00" stroke="#ffaa00" points="79.7582,-215.1267 69.1638,-215.0292 77.385,-221.7122 79.7582,-215.1267"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sa.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sa.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M244.6088,-215.0463C230.9569,-228.0599 208.0083,-248.8668 186,-263.8981 184.1241,-265.1793 182.1611,-266.4419 180.1556,-267.6734"/>
<polygon fill="#aaff00" stroke="#aaff00" points="178.1331,-264.7998 171.2275,-272.8349 181.6366,-270.86 178.1331,-264.7998"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~gradients.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~gradients.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M223.8464,-214.8994C213.1277,-218.7795 201.0805,-223.1404 189.7423,-227.2448"/>
<polygon fill="#aaff00" stroke="#aaff00" points="188.2237,-224.0722 180.0122,-230.767 190.6064,-230.6542 188.2237,-224.0722"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~wall_dist.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~wall_dist.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M251.0849,-215.0889C240.4843,-235.9171 216.4819,-278.7312 186,-305.8981 184.7244,-307.0349 183.3764,-308.1315 181.9778,-309.1862"/>
<polygon fill="#aaff00" stroke="#aaff00" points="179.9688,-306.3187 173.5663,-314.7602 183.8356,-312.1538 179.9688,-306.3187"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_kkl.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_kkl.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M249.826,-190.8807C238.123,-171.9338 213.4565,-134.6317 186,-108.8981 183.0517,-106.1348 179.777,-103.473 176.4104,-100.9758"/>
<polygon fill="#aaff00" stroke="#aaff00" points="178.2002,-97.958 167.9861,-95.1433 174.2156,-103.7133 178.2002,-97.958"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M221.8075,-198.9232C189.3088,-197.0807 141.0584,-199.1627 107,-221.8981 70.4928,-246.2681 50.4303,-296.0051 41.4275,-324.8521"/>
<polygon fill="#aaff00" stroke="#aaff00" points="37.969,-324.2076 38.5074,-334.7887 44.685,-326.1813 37.969,-324.2076"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M247.5494,-190.6425C235.2507,-175.8086 212.2098,-151.611 186,-141.8981 153.0769,-129.6974 139.9442,-129.7544 107,-141.8981 84.7815,-150.0881 64.7762,-168.5959 51.6151,-183.0913"/>
<polygon fill="#aaff00" stroke="#aaff00" points="48.9678,-180.8018 45.037,-190.6405 54.2453,-185.4005 48.9678,-180.8018"/>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sst.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~global_sst.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M253.6797,-190.8394C245.8854,-164.4625 224.1365,-100.8893 186,-61.8981 185.0836,-60.9611 184.1164,-60.0565 183.109,-59.1839"/>
<polygon fill="#aaff00" stroke="#aaff00" points="184.9225,-56.1749 174.7777,-53.1198 180.8031,-61.8345 184.9225,-56.1749"/>
</g>
<!-- sourcefile~copy_bc.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~copy_bc.f90</title>
<g id="a_sourcefile~~source.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/copy_bc.f90.html" xlink:title="copy_bc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="181.5,-174.8981 111.5,-174.8981 111.5,-150.8981 181.5,-150.8981 181.5,-174.8981"/>
<text text-anchor="middle" x="146.5" y="-160.4981" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">copy_bc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~viscosity.f90&#45;&gt;sourcefile~copy_bc.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~viscosity.f90&#45;&gt;sourcefile~copy_bc.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M223.8464,-190.8968C213.1277,-187.0167 201.0805,-182.6557 189.7423,-178.5514"/>
<polygon fill="#aaff00" stroke="#aaff00" points="190.6064,-175.142 180.0122,-175.0292 188.2237,-181.724 190.6064,-175.142"/>
</g>
<!-- sourcefile~wall_dist.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~wall_dist.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M110.7679,-333.3363C98.5877,-335.5309 84.9464,-337.9888 72.657,-340.2031"/>
<polygon fill="#00ff00" stroke="#00ff00" points="71.9345,-336.7769 62.7136,-341.9947 73.1758,-343.6659 71.9345,-336.7769"/>
</g>
<!-- sourcefile~wall_dist.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~wall_dist.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M119.4429,-314.7499C115.043,-312.1622 110.7161,-309.1992 107,-305.8981 80.3481,-282.2231 58.5353,-246.6878 46.2771,-224.155"/>
<polygon fill="#00ff00" stroke="#00ff00" points="49.2491,-222.2881 41.4781,-215.0865 43.062,-225.5622 49.2491,-222.2881"/>
</g>
<!-- sourcefile~cc.f90&#45;&gt;sourcefile~wall_dist.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~cc.f90&#45;&gt;sourcefile~wall_dist.f90</title>
<path fill="none" stroke="#00ffa9" stroke-dasharray="5,2" d="M229.9687,-326.8981C218.5747,-326.8981 204.992,-326.8981 192.1275,-326.8981"/>
<polygon fill="#00ffa9" stroke="#00ffa9" points="192.02,-323.3982 182.02,-326.8981 192.0199,-330.3982 192.02,-323.3982"/>
</g>
<!-- sourcefile~cc.f90&#45;&gt;sourcefile~utils.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~cc.f90&#45;&gt;sourcefile~utils.f90</title>
<path fill="none" stroke="#00ffa9" stroke-dasharray="5,2" d="M146.5,-366.8981C121.9643,-362.6263 94.4098,-357.6624 72.8923,-353.7486"/>
<polygon fill="#00ffa9" stroke="#00ffa9" points="73.3194,-350.2689 62.8539,-351.9193 72.0643,-357.1555 73.3194,-350.2689"/>
</g>
<!-- sourcefile~cc.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge24" class="edge">
<title>sourcefile~cc.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#00ffa9" stroke-dasharray="5,2" d="M240.2828,-338.936C219.0692,-352.7915 181.0718,-372.9173 146.5,-366.8981"/>
<path fill="none" stroke="#00ffa9" stroke-dasharray="5,2" d="M146.5,-366.8981C80.5991,-355.4243 50.7535,-266.6612 40.2238,-224.7181"/>
<polygon fill="#00ffa9" stroke="#00ffa9" points="43.6118,-223.8358 37.9021,-214.9111 36.8,-225.4484 43.6118,-223.8358"/>
</g>
<!-- sourcefile~copy_bc.f90&#45;&gt;sourcefile~vartypes.f90 -->
<g id="sourcefile~~source.f90~~EfferentGraph_edge25" class="edge">
<title>sourcefile~copy_bc.f90&#45;&gt;sourcefile~vartypes.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M113.1963,-174.8994C102.3204,-178.8187 90.0829,-183.2286 78.5931,-187.3691"/>
<polygon fill="#ff0000" stroke="#ff0000" points="77.385,-184.084 69.1638,-190.767 79.7582,-190.6695 77.385,-184.084"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~source.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilesourcef90AfferentGraph" width="356pt" height="32pt"
 viewBox="0.00 0.00 356.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~source.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~source.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 352,-28 352,4 -4,4"/>
<!-- sourcefile~source.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~source.f90</title>
<polygon fill="none" stroke="#000000" points="63,-24 0,-24 0,0 63,0 63,-24"/>
<text text-anchor="middle" x="31.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">source.f90</text>
</g>
<!-- sourcefile~update.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~update.f90</title>
<g id="a_sourcefile~~source.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/update.f90.html" xlink:title="update.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="163,-24 99,-24 99,0 163,0 163,-24"/>
<text text-anchor="middle" x="131" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">update.f90</text>
</a>
</g>
</g>
<!-- sourcefile~update.f90&#45;&gt;sourcefile~source.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~update.f90&#45;&gt;sourcefile~source.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M98.9699,-12C90.8113,-12 81.9215,-12 73.3524,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="73.1299,-8.5001 63.1298,-12 73.1298,-15.5001 73.1299,-8.5001"/>
</g>
<!-- sourcefile~solver.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~solver.f90</title>
<g id="a_sourcefile~~source.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/solver.f90.html" xlink:title="solver.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="258,-24 199,-24 199,0 258,0 258,-24"/>
<text text-anchor="middle" x="228.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">solver.f90</text>
</a>
</g>
</g>
<!-- sourcefile~solver.f90&#45;&gt;sourcefile~update.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~solver.f90&#45;&gt;sourcefile~update.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M198.9822,-12C190.8447,-12 181.8557,-12 173.1525,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="173.1352,-8.5001 163.1352,-12 173.1351,-15.5001 173.1352,-8.5001"/>
</g>
<!-- sourcefile~main.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~main.f90</title>
<g id="a_sourcefile~~source.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/main.f90.html" xlink:title="main.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="348,-24 294,-24 294,0 348,0 348,-24"/>
<text text-anchor="middle" x="321" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">main.f90</text>
</a>
</g>
</g>
<!-- sourcefile~main.f90&#45;&gt;sourcefile~solver.f90 -->
<g id="sourcefile~~source.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~main.f90&#45;&gt;sourcefile~solver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M293.7472,-12C285.791,-12 276.9269,-12 268.361,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="268.1413,-8.5001 258.1413,-12 268.1413,-15.5001 268.1413,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/source.html">source</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/source.f90.html#src">source.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a>  <span class="c">!&lt; Add source&#39;s contribution to the residual</span>
<a name="ln-2"></a><span class="k">module </span><span class="n">source</span>
<a name="ln-3"></a>  <span class="c">!&lt; Add source&#39;s contribution to the residual</span>
<a name="ln-4"></a>  <span class="c">!-----------------------------------------------------------------</span>
<a name="ln-5"></a><span class="cp">#include &quot;debug.h&quot;</span>
<a name="ln-6"></a><span class="cp">#include &quot;error.h&quot;</span>
<a name="ln-7"></a>  <span class="k">use </span><span class="n">vartypes</span>
<a name="ln-8"></a>  <span class="c">!--- variable required for sst source calculation ---!</span>
<a name="ln-9"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k1</span>
<a name="ln-10"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k2</span>
<a name="ln-11"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_w1</span>
<a name="ln-12"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_w2</span>
<a name="ln-13"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">beta1</span>
<a name="ln-14"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">beta2</span>
<a name="ln-15"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">bstar</span>
<a name="ln-16"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">a1</span>
<a name="ln-17"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gama1</span>
<a name="ln-18"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gama2</span>
<a name="ln-19"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">beta</span>
<a name="ln-20"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_w</span>
<a name="ln-21"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sigma_k</span>
<a name="ln-22"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gama</span>
<a name="ln-23"></a>  <span class="k">use </span><span class="n">global_sst</span>   <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">sst_F1</span>
<a name="ln-24"></a>  <span class="k">use </span><span class="n">viscosity</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">mu</span>
<a name="ln-25"></a>  <span class="k">use </span><span class="n">wall_dist</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">dist</span>
<a name="ln-26"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradu_x</span>
<a name="ln-27"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradu_y</span>
<a name="ln-28"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradu_z</span>
<a name="ln-29"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradv_x</span>
<a name="ln-30"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradv_y</span>
<a name="ln-31"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradv_z</span>
<a name="ln-32"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradw_x</span>
<a name="ln-33"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradw_y</span>
<a name="ln-34"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradw_z</span>
<a name="ln-35"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtk_x</span>
<a name="ln-36"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtk_y</span>
<a name="ln-37"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtk_z</span>
<a name="ln-38"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtw_x</span>
<a name="ln-39"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtw_y</span>
<a name="ln-40"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtw_z</span>
<a name="ln-41"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtgm_x</span>
<a name="ln-42"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtgm_y</span>
<a name="ln-43"></a>  <span class="k">use </span><span class="n">gradients</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span>   <span class="n">gradtgm_z</span>
<a name="ln-44"></a>
<a name="ln-45"></a>  <span class="c">!--- variables required for kkl source calculation ---!</span>
<a name="ln-46"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">zeta1</span>
<a name="ln-47"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">zeta2</span>
<a name="ln-48"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">zeta3</span>
<a name="ln-49"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_phi</span>
<a name="ln-50"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cmu</span>
<a name="ln-51"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kappa</span>
<a name="ln-52"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">c11</span>
<a name="ln-53"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">c12</span>
<a name="ln-54"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cd1</span>
<a name="ln-55"></a>
<a name="ln-56"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cphi1</span>
<a name="ln-57"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cphi2</span>
<a name="ln-58"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">fphi</span>
<a name="ln-59"></a>  <span class="k">use </span><span class="n">global_kkl</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">eta</span>
<a name="ln-60"></a>
<a name="ln-61"></a>  <span class="c">!variables required by sa source term calculation</span>
<a name="ln-62"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cb1</span>
<a name="ln-63"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cb2</span>
<a name="ln-64"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw1</span>
<a name="ln-65"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw2</span>
<a name="ln-66"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw3</span>
<a name="ln-67"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cv1</span>
<a name="ln-68"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">sigma_sa</span>
<a name="ln-69"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kappa_sa</span>
<a name="ln-70"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cv1_3</span>
<a name="ln-71"></a>  <span class="k">use </span><span class="n">global_sa</span> <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">cw3_6</span>
<a name="ln-72"></a>  <span class="k">use </span><span class="n">gradients</span> <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gradtv_x</span>
<a name="ln-73"></a>  <span class="k">use </span><span class="n">gradients</span> <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gradtv_y</span>
<a name="ln-74"></a>  <span class="k">use </span><span class="n">gradients</span> <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">gradtv_z</span>
<a name="ln-75"></a>  <span class="k">use </span><span class="n">viscosity</span>  <span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">mu_t</span>
<a name="ln-76"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">DCCVnX</span>
<a name="ln-77"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">DCCVnY</span>
<a name="ln-78"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">DCCVnZ</span>
<a name="ln-79"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">CCnormalX</span>
<a name="ln-80"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">CCnormalY</span>
<a name="ln-81"></a>  <span class="k">use </span><span class="n">CC</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">CCnormalZ</span>
<a name="ln-82"></a>
<a name="ln-83"></a>  <span class="k">use </span><span class="n">CC</span>         <span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">find_DCCVn</span>
<a name="ln-84"></a>  <span class="k">use </span><span class="n">utils</span><span class="p">,</span>       <span class="n">only</span><span class="p">:</span> <span class="n">alloc</span>
<a name="ln-85"></a>
<a name="ln-86"></a>  <span class="k">implicit none</span>
<a name="ln-87"></a><span class="k">  private</span>
<a name="ln-88"></a>
<a name="ln-89"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">add_source_term_residue</span>
<a name="ln-90"></a>
<a name="ln-91"></a>  <span class="k">contains</span>
<a name="ln-92"></a>
<a name="ln-93"></a><span class="k">    </span>
<a name="ln-94"></a><span class="k">    subroutine </span><span class="n">add_source_term_residue</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span><span class="n">scheme</span><span class="p">,</span><span class="n">flow</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-95"></a>      <span class="c">!&lt; Call to add different source terms to the residual of different equations.</span>
<a name="ln-96"></a>
<a name="ln-97"></a>      <span class="k">implicit none</span>
<a name="ln-98"></a><span class="k">      type</span><span class="p">(</span><span class="n">schemetype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">scheme</span>
<a name="ln-99"></a>      <span class="c">!&lt; finite-volume Schemes</span>
<a name="ln-100"></a>      <span class="k">type</span><span class="p">(</span><span class="n">flowtype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flow</span>
<a name="ln-101"></a>      <span class="c">!&lt; Information about fluid flow: freestream-speed, ref-viscosity,etc.</span>
<a name="ln-102"></a>      <span class="k">type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-103"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-104"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-105"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-106"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-107"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-108"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-109"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-110"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-111"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-112"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-113"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-114"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-115"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-116"></a>
<a name="ln-117"></a>      <span class="n">DebugCall</span><span class="p">(</span><span class="s1">&#39;add_source_term_residue&#39;</span><span class="p">)</span>
<a name="ln-118"></a>
<a name="ln-119"></a>      <span class="k">select case</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="p">))</span>
<a name="ln-120"></a>
<a name="ln-121"></a>        <span class="k">case</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a name="ln-122"></a>          <span class="c">!do nothing</span>
<a name="ln-123"></a>          <span class="k">continue</span>
<a name="ln-124"></a>
<a name="ln-125"></a><span class="k">        case</span> <span class="p">(</span><span class="s1">&#39;sa&#39;</span><span class="p">)</span>
<a name="ln-126"></a>          <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">transition</span><span class="p">))</span>
<a name="ln-127"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a name="ln-128"></a>              <span class="k">call </span><span class="n">add_sa_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
<a name="ln-129"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;bc&#39;</span><span class="p">)</span>
<a name="ln-130"></a>              <span class="k">call </span><span class="n">add_saBC_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span><span class="n">flow</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-131"></a>            <span class="k">case </span><span class="n">DEFAULT</span>
<a name="ln-132"></a>              <span class="n">Fatal_error</span>
<a name="ln-133"></a>          <span class="k">end select</span>
<a name="ln-134"></a>
<a name="ln-135"></a><span class="k">        case</span> <span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;sst2003&#39;</span><span class="p">)</span>
<a name="ln-136"></a>          <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">transition</span><span class="p">))</span>
<a name="ln-137"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<a name="ln-138"></a>              <span class="k">call </span><span class="n">add_sst_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span><span class="n">scheme</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-139"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;lctm2015&#39;</span><span class="p">)</span>
<a name="ln-140"></a>              <span class="k">call </span><span class="n">add_sst_source_lctm2015</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span><span class="n">scheme</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-141"></a>            <span class="k">case</span><span class="p">(</span><span class="s1">&#39;bc&#39;</span><span class="p">)</span>
<a name="ln-142"></a>              <span class="k">call </span><span class="n">add_sst_bc_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span><span class="n">flow</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
<a name="ln-143"></a>            <span class="k">case </span><span class="n">DEFAULT</span>
<a name="ln-144"></a>              <span class="n">Fatal_error</span>
<a name="ln-145"></a>          <span class="k">end select</span>
<a name="ln-146"></a>
<a name="ln-147"></a><span class="k">        case</span> <span class="p">(</span><span class="s1">&#39;kkl&#39;</span><span class="p">)</span>
<a name="ln-148"></a>          <span class="k">call </span><span class="n">add_kkl_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-149"></a>
<a name="ln-150"></a>        <span class="k">case </span><span class="n">DEFAULT</span>
<a name="ln-151"></a>          <span class="n">Fatal_error</span>
<a name="ln-152"></a>
<a name="ln-153"></a>      <span class="k">end select</span>
<a name="ln-154"></a>
<a name="ln-155"></a><span class="k">    end subroutine </span><span class="n">add_source_term_residue</span>
<a name="ln-156"></a>
<a name="ln-157"></a>
<a name="ln-158"></a>    <span class="k">subroutine </span><span class="n">add_sst_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span><span class="n">scheme</span><span class="p">,</span><span class="n">dims</span><span class="p">)</span>
<a name="ln-159"></a>      <span class="c">!&lt; Add residual due to source terms of the SST turbulence model</span>
<a name="ln-160"></a>      <span class="k">implicit none</span>
<a name="ln-161"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-162"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-163"></a>      <span class="k">type</span><span class="p">(</span><span class="n">schemetype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">scheme</span>
<a name="ln-164"></a>      <span class="c">!&lt; finite-volume Schemes</span>
<a name="ln-165"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-166"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-167"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-168"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-169"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-170"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-171"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-172"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-173"></a>
<a name="ln-174"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD</span>
<a name="ln-175"></a>      <span class="c">!&lt; cross diffusion term</span>
<a name="ln-176"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">F1</span>
<a name="ln-177"></a>      <span class="c">!&lt; single cell belding fuction </span>
<a name="ln-178"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vort</span>
<a name="ln-179"></a>      <span class="c">!&lt; vorticity magnitude</span>
<a name="ln-180"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_k</span>
<a name="ln-181"></a>      <span class="c">!&lt; Total source term of TKE equation</span>
<a name="ln-182"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_w</span>
<a name="ln-183"></a>      <span class="c">!&lt; Total source term of omega equation</span>
<a name="ln-184"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_k</span>
<a name="ln-185"></a>      <span class="c">!&lt; destruction term of TKE equation</span>
<a name="ln-186"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_w</span>
<a name="ln-187"></a>      <span class="c">!&lt; destruction term of omega equation</span>
<a name="ln-188"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_k</span>
<a name="ln-189"></a>      <span class="c">!&lt; production term of TKE equation</span>
<a name="ln-190"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_w</span>
<a name="ln-191"></a>      <span class="c">!&lt; production term of Omega equation</span>
<a name="ln-192"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamda</span>
<a name="ln-193"></a>      <span class="c">!&lt; additional source term in Omega equation</span>
<a name="ln-194"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">limiter</span>
<a name="ln-195"></a>      <span class="c">!&lt; production term limiter</span>
<a name="ln-196"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divergence</span>
<a name="ln-197"></a>      <span class="c">!&lt; del.V</span>
<a name="ln-198"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-199"></a>      <span class="c">!&lt; single cell density</span>
<a name="ln-200"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk</span>
<a name="ln-201"></a>      <span class="c">!&lt; single cell TKE</span>
<a name="ln-202"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tw</span>
<a name="ln-203"></a>      <span class="c">!&lt; single cell Omega</span>
<a name="ln-204"></a>      
<a name="ln-205"></a>      <span class="k">if</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;sst2003&#39;</span><span class="p">)</span><span class="k">then</span>
<a name="ln-206"></a><span class="k">        </span><span class="n">limiter</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-207"></a>        <span class="n">gama1</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">9.0</span>
<a name="ln-208"></a>        <span class="n">gama2</span> <span class="o">=</span> <span class="mf">0.44</span>
<a name="ln-209"></a>      <span class="k">else </span>
<a name="ln-210"></a><span class="k">        </span><span class="n">limiter</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-211"></a>      <span class="k">end if</span>
<a name="ln-212"></a>
<a name="ln-213"></a>
<a name="ln-214"></a><span class="k">      do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-215"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-216"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-217"></a>
<a name="ln-218"></a>            <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-219"></a>            <span class="n">tk</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-220"></a>            <span class="n">tw</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-221"></a>
<a name="ln-222"></a>            <span class="c">! __ vorticity __</span>
<a name="ln-223"></a>            <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-224"></a>                            <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-225"></a>                            <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-226"></a>                             <span class="p">)&amp;</span>
<a name="ln-227"></a>                       <span class="p">)</span>
<a name="ln-228"></a>
<a name="ln-229"></a>            <span class="n">CD</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">sigma_w2</span><span class="o">*</span><span class="p">(</span><span class="n">gradtk_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-230"></a>                                   <span class="o">+</span> <span class="n">gradtk_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-231"></a>                                   <span class="o">+</span> <span class="n">gradtk_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-232"></a>                                    <span class="p">)</span><span class="o">/</span><span class="n">tw</span>
<a name="ln-233"></a>            <span class="n">CD</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CD</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">limiter</span><span class="p">))</span>
<a name="ln-234"></a>            <span class="n">F1</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-235"></a>
<a name="ln-236"></a>
<a name="ln-237"></a>            <span class="n">sigma_k</span>     <span class="o">=</span>    <span class="n">sigma_k1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_k2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-238"></a>            <span class="n">sigma_w</span>     <span class="o">=</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-239"></a>            <span class="n">gama</span>        <span class="o">=</span>       <span class="n">gama1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">gama2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-240"></a>            <span class="n">beta</span>        <span class="o">=</span>       <span class="n">beta1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">beta2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-241"></a>
<a name="ln-242"></a>
<a name="ln-243"></a>
<a name="ln-244"></a>            <span class="c">! ____ Dissipation term ___</span>
<a name="ln-245"></a>            <span class="n">D_k</span> <span class="o">=</span> <span class="n">bstar</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-246"></a>            <span class="n">D_w</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-247"></a>
<a name="ln-248"></a>            <span class="c">! ____ PRODUCTION term____ </span>
<a name="ln-249"></a>            <span class="n">divergence</span> <span class="o">=</span> <span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-250"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vort</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span><span class="p">((</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tk</span><span class="o">*</span><span class="n">divergence</span><span class="p">)</span>
<a name="ln-251"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P_k</span><span class="p">,</span><span class="n">limiter</span><span class="o">*</span><span class="n">D_k</span><span class="p">)</span>
<a name="ln-252"></a>            <span class="n">P_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span><span class="o">*</span><span class="n">gama</span><span class="o">/</span><span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">P_k</span>
<a name="ln-253"></a>
<a name="ln-254"></a>            <span class="c">! ____ cross diffusion term ___</span>
<a name="ln-255"></a>            <span class="n">lamda</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span><span class="o">*</span><span class="n">CD</span>
<a name="ln-256"></a>
<a name="ln-257"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">P_k</span> <span class="o">-</span> <span class="n">D_k</span>           <span class="c">!Source term TKE</span>
<a name="ln-258"></a>            <span class="n">S_w</span> <span class="o">=</span> <span class="n">P_w</span> <span class="o">-</span> <span class="n">D_w</span>  <span class="o">+</span><span class="n">lamda</span>   <span class="c">!source term omega</span>
<a name="ln-259"></a>
<a name="ln-260"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">S_k</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-261"></a>            <span class="n">S_w</span> <span class="o">=</span> <span class="n">S_w</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-262"></a>
<a name="ln-263"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_k</span>
<a name="ln-264"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_w</span>
<a name="ln-265"></a>
<a name="ln-266"></a>          <span class="k">end do</span>
<a name="ln-267"></a><span class="k">        end do</span>
<a name="ln-268"></a><span class="k">      end do</span>
<a name="ln-269"></a>
<a name="ln-270"></a><span class="k">    end subroutine </span><span class="n">add_sst_source</span>
<a name="ln-271"></a>
<a name="ln-272"></a>
<a name="ln-273"></a>    <span class="k">subroutine </span><span class="n">add_sst_source_lctm2015</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-274"></a>      <span class="c">!&lt; Add residual due to source terms of the LCTM2015 transition model</span>
<a name="ln-275"></a>      <span class="k">implicit none</span>
<a name="ln-276"></a><span class="k">      type</span><span class="p">(</span><span class="n">schemetype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">scheme</span>
<a name="ln-277"></a>      <span class="c">!&lt; finite-volume Schemes</span>
<a name="ln-278"></a>      <span class="k">type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-279"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-280"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-281"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-282"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-283"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-284"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-285"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-286"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-287"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-288"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-289"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-290"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-291"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-292"></a>
<a name="ln-293"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD</span>
<a name="ln-294"></a>      <span class="c">!&lt; Cross-diffustion term</span>
<a name="ln-295"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">F1</span>
<a name="ln-296"></a>      <span class="c">!&lt; single cell blending function</span>
<a name="ln-297"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vort</span>
<a name="ln-298"></a>      <span class="c">!&lt; vorticity magnitude</span>
<a name="ln-299"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_K</span>
<a name="ln-300"></a>      <span class="c">!&lt; Total source term in TKE equation</span>
<a name="ln-301"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_w</span>
<a name="ln-302"></a>      <span class="c">!&lt; Total source term in Omega equation</span>
<a name="ln-303"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_gm</span>
<a name="ln-304"></a>      <span class="c">!&lt; Total source term in Gamma equation</span>
<a name="ln-305"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_k</span>
<a name="ln-306"></a>      <span class="c">!&lt; Destruction term in TKE equation</span>
<a name="ln-307"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_w</span>
<a name="ln-308"></a>      <span class="c">!&lt; Destruction term in Omega equation</span>
<a name="ln-309"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_gm</span>
<a name="ln-310"></a>      <span class="c">!&lt; Destruction term in Gamma equation</span>
<a name="ln-311"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_k</span>
<a name="ln-312"></a>      <span class="c">!&lt; production term in TKE equation</span>
<a name="ln-313"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_w</span>
<a name="ln-314"></a>      <span class="c">!&lt; production term in Omega equation</span>
<a name="ln-315"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_gm</span>
<a name="ln-316"></a>      <span class="c">!&lt; production term in Gamma equation</span>
<a name="ln-317"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamda</span>
<a name="ln-318"></a>      <span class="c">!&lt; additional source term in Omega equation</span>
<a name="ln-319"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fonset1</span><span class="p">,</span><span class="n">Fonset2</span><span class="p">,</span> <span class="n">Fonset3</span><span class="p">,</span><span class="n">Fonset</span>
<a name="ln-320"></a>      <span class="c">!&lt; Transition onset term </span>
<a name="ln-321"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Rev</span>
<a name="ln-322"></a>      <span class="c">!&lt; Reynodlds number based on vorticity</span>
<a name="ln-323"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RT</span>
<a name="ln-324"></a>      <span class="c">!&lt; Turbulent reynolds number</span>
<a name="ln-325"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fturb</span>
<a name="ln-326"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Re_theta</span>
<a name="ln-327"></a>      <span class="c">!&lt; Cutt-off reynolds number based on momentum thickness</span>
<a name="ln-328"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">TuL</span>
<a name="ln-329"></a>      <span class="c">!&lt; local turbulence intensity</span>
<a name="ln-330"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">strain</span>
<a name="ln-331"></a>      <span class="c">!&lt; Strain rate magnitude</span>
<a name="ln-332"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">intermittency</span>
<a name="ln-333"></a>      <span class="c">!&lt; intermittency</span>
<a name="ln-334"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Pk_lim</span>
<a name="ln-335"></a>      <span class="c">!&lt; production lim term</span>
<a name="ln-336"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fon_lim</span>
<a name="ln-337"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamd</span>
<a name="ln-338"></a>      <span class="c">!&lt; pressure gradient </span>
<a name="ln-339"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Fpg</span>
<a name="ln-340"></a>      <span class="c">!&lt; pressure gradient functin</span>
<a name="ln-341"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">divergence</span>
<a name="ln-342"></a>      <span class="c">!&lt; del.V</span>
<a name="ln-343"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dvdy</span>
<a name="ln-344"></a>      <span class="c">!&lt; pressure gradient sensor</span>
<a name="ln-345"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">limiter</span>
<a name="ln-346"></a>      <span class="c">!&lt; production limiter</span>
<a name="ln-347"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-348"></a>      <span class="c">!&lt; single cell Density</span>
<a name="ln-349"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk</span>
<a name="ln-350"></a>      <span class="c">!&lt; single cell TKE</span>
<a name="ln-351"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tw</span>
<a name="ln-352"></a>      <span class="c">!&lt; single cell Omega</span>
<a name="ln-353"></a>
<a name="ln-354"></a>      <span class="k">if</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">scheme</span><span class="p">%</span><span class="n">turbulence</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;sst2003&#39;</span><span class="p">)</span><span class="k">then</span>
<a name="ln-355"></a><span class="k">        </span><span class="n">limiter</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-356"></a>        <span class="n">gama1</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">9.0</span>
<a name="ln-357"></a>        <span class="n">gama2</span> <span class="o">=</span> <span class="mf">0.44</span>
<a name="ln-358"></a>      <span class="k">else </span>
<a name="ln-359"></a><span class="k">        </span><span class="n">limiter</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-360"></a>      <span class="k">end if</span>
<a name="ln-361"></a>
<a name="ln-362"></a>      <span class="c">!for pressure gradient calculation</span>
<a name="ln-363"></a>      <span class="k">call </span><span class="n">find_DCCVn</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span> <span class="n">Jfaces</span><span class="p">,</span> <span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-364"></a>
<a name="ln-365"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-366"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-367"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-368"></a>
<a name="ln-369"></a>            <span class="n">density</span>       <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-370"></a>            <span class="n">tk</span>            <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-371"></a>            <span class="n">tw</span>            <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-372"></a>            <span class="n">intermittency</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-373"></a>
<a name="ln-374"></a>            <span class="c">! __ vorticity __</span>
<a name="ln-375"></a>            <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-376"></a>                            <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-377"></a>                            <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-378"></a>                             <span class="p">)&amp;</span>
<a name="ln-379"></a>                       <span class="p">)</span>
<a name="ln-380"></a>
<a name="ln-381"></a>            <span class="n">strain</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>     <span class="p">(((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-382"></a>                              <span class="o">+</span> <span class="p">((</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-383"></a>                              <span class="o">+</span> <span class="p">((</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-384"></a>                              <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-385"></a>                              <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-386"></a>                              <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-387"></a>                               <span class="p">)&amp;</span>
<a name="ln-388"></a>                         <span class="p">)</span>
<a name="ln-389"></a>
<a name="ln-390"></a>            <span class="n">CD</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">sigma_w2</span><span class="o">*</span><span class="p">(</span><span class="n">gradtk_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-391"></a>                                   <span class="o">+</span> <span class="n">gradtk_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-392"></a>                                   <span class="o">+</span> <span class="n">gradtk_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-393"></a>                                    <span class="p">)</span><span class="o">/</span><span class="n">tw</span>
<a name="ln-394"></a>            <span class="n">CD</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CD</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">limiter</span><span class="p">))</span>
<a name="ln-395"></a>            <span class="n">F1</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-396"></a>
<a name="ln-397"></a>
<a name="ln-398"></a>            <span class="n">sigma_k</span>     <span class="o">=</span>    <span class="n">sigma_k1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_k2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-399"></a>            <span class="n">sigma_w</span>     <span class="o">=</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-400"></a>            <span class="n">gama</span>        <span class="o">=</span>       <span class="n">gama1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">gama2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-401"></a>            <span class="n">beta</span>        <span class="o">=</span>       <span class="n">beta1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">beta2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-402"></a>
<a name="ln-403"></a>
<a name="ln-404"></a>
<a name="ln-405"></a>            <span class="c">! ____ Dissipation term ___</span>
<a name="ln-406"></a>            <span class="n">D_k</span> <span class="o">=</span> <span class="n">bstar</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-407"></a>            <span class="n">D_w</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-408"></a>
<a name="ln-409"></a>            <span class="c">! ____ PRODUCTION term____ </span>
<a name="ln-410"></a>            <span class="n">divergence</span> <span class="o">=</span> <span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-411"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vort</span><span class="o">*</span><span class="n">strain</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tk</span><span class="o">*</span><span class="n">divergence</span><span class="p">)</span>
<a name="ln-412"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P_k</span><span class="p">,</span> <span class="n">limiter</span><span class="o">*</span><span class="n">D_k</span><span class="p">)</span>
<a name="ln-413"></a>            <span class="n">P_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span><span class="o">*</span><span class="n">gama</span><span class="o">/</span><span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">P_k</span>
<a name="ln-414"></a>
<a name="ln-415"></a>            <span class="c">! ____ cross diffusion term ___</span>
<a name="ln-416"></a>            <span class="n">lamda</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span><span class="o">*</span><span class="n">CD</span>
<a name="ln-417"></a>
<a name="ln-418"></a>            <span class="c">! ____Transition modeling  ____</span>
<a name="ln-419"></a>              <span class="c">! --pressure gradient </span>
<a name="ln-420"></a>            <span class="n">dvdy</span> <span class="o">=</span> <span class="n">DCCVnX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">CCnormalX</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-421"></a>                 <span class="o">+</span> <span class="n">DCCVnY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">CCnormalY</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-422"></a>                 <span class="o">+</span> <span class="n">DCCVnZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">CCnormalZ</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-423"></a>            <span class="n">lamd</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">7.57e-3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">dvdy</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">/</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.0128</span>
<a name="ln-424"></a>            <span class="n">lamd</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">lamd</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
<a name="ln-425"></a>            <span class="k">if</span><span class="p">(</span><span class="n">lamd</span><span class="o">&gt;=</span><span class="mf">0.0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-426"></a><span class="k">                </span><span class="n">Fpg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mi">1</span><span class="mf">4.68</span><span class="o">*</span><span class="n">lamd</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
<a name="ln-427"></a>            <span class="k">else</span>
<a name="ln-428"></a><span class="k">                </span><span class="n">Fpg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">7.34</span><span class="o">*</span><span class="n">lamd</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<a name="ln-429"></a>            <span class="k">end if</span>
<a name="ln-430"></a><span class="k">            </span><span class="n">Fpg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Fpg</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-431"></a>              <span class="c">! --gradient</span>
<a name="ln-432"></a>            <span class="n">TuL</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">tk</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tw</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)),</span><span class="mi">10</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-433"></a>            <span class="n">Re_theta</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span> <span class="o">+</span> <span class="mi">100</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">TuL</span><span class="o">*</span><span class="n">Fpg</span><span class="p">)</span>
<a name="ln-434"></a>            <span class="c">!Re_theta = 100.0 + 1000.0*exp(-TuL)</span>
<a name="ln-435"></a>            <span class="n">Rev</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">strain</span><span class="o">/</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-436"></a>            <span class="n">RT</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">tk</span><span class="o">/</span><span class="p">(</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tw</span><span class="p">)</span>
<a name="ln-437"></a>            <span class="n">Fturb</span> <span class="o">=</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">Rt</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-438"></a>            <span class="n">Fonset1</span> <span class="o">=</span> <span class="n">Rev</span><span class="o">/</span><span class="p">(</span><span class="mf">2.2</span><span class="o">*</span><span class="n">Re_theta</span><span class="p">)</span>
<a name="ln-439"></a>            <span class="n">Fonset2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Fonset1</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
<a name="ln-440"></a>            <span class="n">Fonset3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">RT</span><span class="o">/</span><span class="mf">3.5</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-441"></a>            <span class="n">Fonset</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Fonset2</span> <span class="o">-</span> <span class="n">Fonset3</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-442"></a>            <span class="n">P_gm</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">strain</span><span class="o">*</span><span class="n">intermittency</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">intermittency</span><span class="p">)</span><span class="o">*</span><span class="n">Fonset</span>
<a name="ln-443"></a>            <span class="n">D_gm</span> <span class="o">=</span> <span class="mf">0.06</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">vort</span><span class="o">*</span><span class="n">intermittency</span><span class="o">*</span><span class="n">Fturb</span><span class="o">*</span><span class="p">((</span><span class="mi">5</span><span class="mf">0.0</span><span class="o">*</span><span class="n">intermittency</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
<a name="ln-444"></a>
<a name="ln-445"></a>            <span class="n">Fon_lim</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">Rev</span><span class="o">/</span><span class="p">(</span><span class="mf">2.2</span><span class="o">*</span><span class="mi">110</span><span class="mf">0.0</span><span class="p">))</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="mf">3.0</span><span class="p">)</span>
<a name="ln-446"></a>            <span class="n">Pk_lim</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">intermittency</span> <span class="o">-</span> <span class="mf">0.2</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">intermittency</span><span class="p">)</span><span class="o">*</span><span class="n">Fon_lim</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="n">strain</span><span class="o">*</span><span class="n">vort</span>
<a name="ln-447"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">intermittency</span><span class="o">*</span><span class="n">P_k</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">intermittency</span><span class="p">,</span><span class="mf">0.1</span><span class="p">)</span><span class="o">*</span><span class="n">D_k</span>  <span class="o">+</span>  <span class="n">Pk_lim</span>      <span class="c">!Source term gm</span>
<a name="ln-448"></a>            <span class="n">S_W</span> <span class="o">=</span> <span class="n">P_w</span> <span class="o">-</span> <span class="n">D_w</span>  <span class="o">+</span> <span class="n">lamda</span>        <span class="c">!Source term gm</span>
<a name="ln-449"></a>            <span class="n">S_gm</span> <span class="o">=</span> <span class="n">P_gm</span> <span class="o">-</span> <span class="n">D_gm</span>           <span class="c">!Source term gm</span>
<a name="ln-450"></a>
<a name="ln-451"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">S_k</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-452"></a>            <span class="n">S_w</span> <span class="o">=</span> <span class="n">S_w</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-453"></a>            <span class="n">S_gm</span><span class="o">=</span> <span class="n">S_gm</span><span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">Volume</span>
<a name="ln-454"></a>
<a name="ln-455"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_k</span>
<a name="ln-456"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_w</span>
<a name="ln-457"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_gm</span>
<a name="ln-458"></a>
<a name="ln-459"></a>          <span class="k">end do</span>
<a name="ln-460"></a><span class="k">        end do</span>
<a name="ln-461"></a><span class="k">      end do</span>
<a name="ln-462"></a>
<a name="ln-463"></a><span class="k">    end subroutine </span><span class="n">add_sst_source_lctm2015</span>
<a name="ln-464"></a>
<a name="ln-465"></a>
<a name="ln-466"></a>    <span class="c">! SST-BC model</span>
<a name="ln-467"></a>    <span class="k">subroutine </span><span class="n">add_sst_bc_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-468"></a>      <span class="c">!&lt; Add residual due to source terms of the SST-BC transition model</span>
<a name="ln-469"></a>      <span class="k">implicit none</span>
<a name="ln-470"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-471"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-472"></a>      <span class="k">type</span><span class="p">(</span><span class="n">flowtype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flow</span>
<a name="ln-473"></a>      <span class="c">!&lt; Information about fluid flow: freestream-speed, ref-viscosity,etc.</span>
<a name="ln-474"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-475"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-476"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-477"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-478"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-479"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-480"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-481"></a>
<a name="ln-482"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD</span>
<a name="ln-483"></a>      <span class="c">!&lt; cross-diffusion term</span>
<a name="ln-484"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">F1</span>
<a name="ln-485"></a>      <span class="c">!&lt; single cell blending function </span>
<a name="ln-486"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vort</span>
<a name="ln-487"></a>      <span class="c">!&lt; vorticity magnitude</span>
<a name="ln-488"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_k</span>
<a name="ln-489"></a>      <span class="c">!&lt; Total source term in TKE equation</span>
<a name="ln-490"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_w</span>
<a name="ln-491"></a>      <span class="c">!&lt; Total source term in Omega equation</span>
<a name="ln-492"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_k</span>
<a name="ln-493"></a>      <span class="c">!&lt; Destruction term in TKE equation</span>
<a name="ln-494"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_w</span>
<a name="ln-495"></a>      <span class="c">!&lt; Destruction term in Omega equation</span>
<a name="ln-496"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_k</span>
<a name="ln-497"></a>      <span class="c">!&lt; Production term in TKE equation</span>
<a name="ln-498"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_w</span>
<a name="ln-499"></a>      <span class="c">!&lt; production term in Omega equation</span>
<a name="ln-500"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamda</span>
<a name="ln-501"></a>      <span class="c">!&lt; addtion source term in Omega equation</span>
<a name="ln-502"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">TuL</span>
<a name="ln-503"></a>      <span class="c">!&lt; local turbulence intensity</span>
<a name="ln-504"></a>      <span class="c">!--------BC model -----</span>
<a name="ln-505"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chi_1</span><span class="o">=</span><span class="mf">0.002</span>
<a name="ln-506"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chi_2</span><span class="o">=</span><span class="mf">5.0</span>
<a name="ln-507"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_BC</span>
<a name="ln-508"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_cr</span>
<a name="ln-509"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_t</span>
<a name="ln-510"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_v</span>
<a name="ln-511"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_theta</span>
<a name="ln-512"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_theta_t</span>
<a name="ln-513"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term1</span>
<a name="ln-514"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term2</span>
<a name="ln-515"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term_exponential</span>
<a name="ln-516"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gamma_BC</span>
<a name="ln-517"></a>      <span class="c">!&lt; intermittency function</span>
<a name="ln-518"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vmag</span>
<a name="ln-519"></a>      <span class="c">!&lt; velocity magnitude</span>
<a name="ln-520"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-521"></a>      <span class="c">!&lt; single cell Density</span>
<a name="ln-522"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk</span>
<a name="ln-523"></a>      <span class="c">!&lt; single cell TKE</span>
<a name="ln-524"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tw</span>
<a name="ln-525"></a>      <span class="c">!&lt; single cell omega</span>
<a name="ln-526"></a>
<a name="ln-527"></a>
<a name="ln-528"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-529"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-530"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-531"></a>
<a name="ln-532"></a>            <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-533"></a>            <span class="n">tk</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-534"></a>            <span class="n">tw</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-535"></a>            <span class="c">! __ vorticity __</span>
<a name="ln-536"></a>            <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-537"></a>                        <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-538"></a>                        <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-539"></a>                         <span class="p">)&amp;</span>
<a name="ln-540"></a>                       <span class="p">)</span>
<a name="ln-541"></a>
<a name="ln-542"></a>            <span class="n">CD</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">sigma_w2</span><span class="o">*</span><span class="p">(</span><span class="n">gradtk_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-543"></a>                                   <span class="o">+</span> <span class="n">gradtk_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-544"></a>                                   <span class="o">+</span> <span class="n">gradtk_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)&amp;</span>
<a name="ln-545"></a>                                    <span class="p">)</span><span class="o">/</span><span class="n">tw</span>
<a name="ln-546"></a>            <span class="c">!CD = max(CD, 1e-20)</span>
<a name="ln-547"></a>            <span class="n">F1</span> <span class="o">=</span> <span class="n">sst_F1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-548"></a>
<a name="ln-549"></a>
<a name="ln-550"></a>            <span class="n">sigma_k</span>     <span class="o">=</span>    <span class="n">sigma_k1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_k2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-551"></a>            <span class="n">sigma_w</span>     <span class="o">=</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>    <span class="n">sigma_w1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-552"></a>            <span class="n">gama</span>        <span class="o">=</span>       <span class="n">gama1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">gama2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-553"></a>            <span class="n">beta</span>        <span class="o">=</span>       <span class="n">beta1</span><span class="o">*</span><span class="n">F1</span>  <span class="o">+</span>       <span class="n">beta2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span>
<a name="ln-554"></a>
<a name="ln-555"></a>
<a name="ln-556"></a>
<a name="ln-557"></a>            <span class="c">! ____ Dissipation term ___</span>
<a name="ln-558"></a>            <span class="n">D_k</span> <span class="o">=</span> <span class="n">bstar</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-559"></a>            <span class="n">D_w</span> <span class="o">=</span> <span class="n">beta</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tw</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-560"></a>
<a name="ln-561"></a>            <span class="c">! ____ PRODUCTION term____ </span>
<a name="ln-562"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vort</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-563"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P_k</span><span class="p">,</span><span class="mi">2</span><span class="mf">0.0</span><span class="o">*</span><span class="n">D_k</span><span class="p">)</span>
<a name="ln-564"></a>            <span class="n">P_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span><span class="o">*</span><span class="n">gama</span><span class="o">/</span><span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">P_k</span>
<a name="ln-565"></a>
<a name="ln-566"></a>            <span class="c">! ____ cross diffusion term ___</span>
<a name="ln-567"></a>            <span class="n">lamda</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">F1</span><span class="p">)</span><span class="o">*</span><span class="n">CD</span>
<a name="ln-568"></a>
<a name="ln-569"></a>            <span class="c">! ____Transition modeling  ____</span>
<a name="ln-570"></a>            <span class="c">!------ BC model ---</span>
<a name="ln-571"></a>            <span class="n">vmag</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-572"></a>            <span class="n">chi_1</span> <span class="o">=</span> <span class="mf">0.002</span>
<a name="ln-573"></a>            <span class="n">chi_2</span> <span class="o">=</span> <span class="mf">5.0</span>
<a name="ln-574"></a>
<a name="ln-575"></a>            <span class="n">nu_t</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">density</span>
<a name="ln-576"></a>            <span class="n">nu_cr</span> <span class="o">=</span> <span class="n">chi_2</span><span class="o">/</span><span class="n">flow</span><span class="p">%</span><span class="n">Reynolds_number</span>
<a name="ln-577"></a>            <span class="n">nu_bc</span> <span class="o">=</span> <span class="n">nu_t</span><span class="o">/</span><span class="p">(</span><span class="n">vmag</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-578"></a>
<a name="ln-579"></a>            <span class="n">TuL</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tu_inf</span> <span class="c">!local turbulence intensity might not work for BC model</span>
<a name="ln-580"></a>            <span class="n">re_v</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">vort</span><span class="o">/</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-581"></a>            <span class="n">re_theta</span> <span class="o">=</span> <span class="n">re_v</span><span class="o">/</span><span class="mf">2.193</span>
<a name="ln-582"></a>            <span class="n">re_theta_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80</span><span class="mf">3.73</span><span class="o">*</span><span class="p">((</span><span class="n">TuL</span> <span class="o">+</span> <span class="mf">0.6067</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.027</span><span class="p">)))</span>
<a name="ln-583"></a>
<a name="ln-584"></a>            <span class="n">term1</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">re_theta</span><span class="o">-</span><span class="n">re_theta_t</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">chi_1</span><span class="o">*</span><span class="n">re_theta_t</span><span class="p">))</span>
<a name="ln-585"></a>            <span class="n">term2</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nu_BC</span><span class="o">-</span><span class="n">nu_cr</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span><span class="o">/</span><span class="n">nu_cr</span><span class="p">)</span>
<a name="ln-586"></a>            <span class="n">term_exponential</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
<a name="ln-587"></a>            <span class="n">gamma_BC</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">term_exponential</span><span class="p">)</span>
<a name="ln-588"></a>
<a name="ln-589"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">gamma_BC</span><span class="o">*</span><span class="n">P_k</span>
<a name="ln-590"></a>
<a name="ln-591"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">P_k</span> <span class="o">-</span> <span class="n">D_k</span>           <span class="c">!Source term TKE</span>
<a name="ln-592"></a>            <span class="n">S_w</span> <span class="o">=</span> <span class="n">P_w</span> <span class="o">-</span> <span class="n">D_w</span>  <span class="o">+</span><span class="n">lamda</span>   <span class="c">!source term omega</span>
<a name="ln-593"></a>
<a name="ln-594"></a>            <span class="n">S_k</span> <span class="o">=</span> <span class="n">S_k</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-595"></a>            <span class="n">S_w</span> <span class="o">=</span> <span class="n">S_w</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-596"></a>
<a name="ln-597"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_k</span>
<a name="ln-598"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_w</span>
<a name="ln-599"></a>
<a name="ln-600"></a>          <span class="k">end do</span>
<a name="ln-601"></a><span class="k">        end do</span>
<a name="ln-602"></a><span class="k">      end do</span>
<a name="ln-603"></a>
<a name="ln-604"></a><span class="k">    end subroutine </span><span class="n">add_sst_bc_source</span>
<a name="ln-605"></a>
<a name="ln-606"></a>
<a name="ln-607"></a>    <span class="k">subroutine </span><span class="n">add_kkl_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-608"></a>      <span class="c">!&lt; Add residual due to source terms of the k-kL turbulence model</span>
<a name="ln-609"></a>      <span class="k">implicit none</span>
<a name="ln-610"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-611"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-612"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-613"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-614"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-615"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-616"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-617"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-618"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-619"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-620"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-621"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-622"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-623"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-624"></a>
<a name="ln-625"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau11</span>
<a name="ln-626"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau12</span>
<a name="ln-627"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau13</span>
<a name="ln-628"></a>
<a name="ln-629"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau21</span>
<a name="ln-630"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau22</span>
<a name="ln-631"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau23</span>
<a name="ln-632"></a>
<a name="ln-633"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau31</span>
<a name="ln-634"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau32</span>
<a name="ln-635"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tau33</span>
<a name="ln-636"></a>
<a name="ln-637"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S11</span>
<a name="ln-638"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S12</span>
<a name="ln-639"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S13</span>
<a name="ln-640"></a>
<a name="ln-641"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S21</span>
<a name="ln-642"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S22</span>
<a name="ln-643"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S23</span>
<a name="ln-644"></a>
<a name="ln-645"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S31</span>
<a name="ln-646"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S32</span>
<a name="ln-647"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S33</span>
<a name="ln-648"></a>
<a name="ln-649"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">delv</span>
<a name="ln-650"></a>
<a name="ln-651"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2udx2</span>
<a name="ln-652"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2udy2</span>
<a name="ln-653"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2udz2</span>
<a name="ln-654"></a>
<a name="ln-655"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2vdx2</span>
<a name="ln-656"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2vdy2</span>
<a name="ln-657"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2vdz2</span>
<a name="ln-658"></a>
<a name="ln-659"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2wdx2</span>
<a name="ln-660"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2wdy2</span>
<a name="ln-661"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d2wdz2</span>
<a name="ln-662"></a>
<a name="ln-663"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Lvk</span>
<a name="ln-664"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fp</span>
<a name="ln-665"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ud</span>
<a name="ln-666"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">udd</span>
<a name="ln-667"></a>
<a name="ln-668"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_k</span>
<a name="ln-669"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_kl</span>
<a name="ln-670"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_k</span>
<a name="ln-671"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_kl</span>
<a name="ln-672"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_k</span>
<a name="ln-673"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_kl</span>
<a name="ln-674"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-675"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tk</span>
<a name="ln-676"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tkl</span>
<a name="ln-677"></a>
<a name="ln-678"></a>
<a name="ln-679"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-680"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-681"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-682"></a>
<a name="ln-683"></a>            <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-684"></a>            <span class="n">tk</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-685"></a>            <span class="n">tkl</span>     <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-686"></a>
<a name="ln-687"></a>            <span class="n">S11</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-688"></a>            <span class="n">S12</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-689"></a>            <span class="n">S13</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-690"></a>
<a name="ln-691"></a>            <span class="n">S21</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-692"></a>            <span class="n">S22</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-693"></a>            <span class="n">S23</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-694"></a>
<a name="ln-695"></a>            <span class="n">S31</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-696"></a>            <span class="n">S32</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-697"></a>            <span class="n">S33</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-698"></a>
<a name="ln-699"></a>            <span class="n">delv</span> <span class="o">=</span> <span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-700"></a>
<a name="ln-701"></a>            <span class="n">Tau11</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S11</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">delv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-702"></a>            <span class="n">Tau12</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S12</span><span class="p">)</span>
<a name="ln-703"></a>            <span class="n">Tau13</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S13</span><span class="p">)</span>
<a name="ln-704"></a>            <span class="n">Tau21</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S21</span><span class="p">)</span>
<a name="ln-705"></a>            <span class="n">Tau22</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S22</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">delv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-706"></a>            <span class="n">Tau23</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S23</span><span class="p">)</span>
<a name="ln-707"></a>            <span class="n">Tau31</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S31</span><span class="p">)</span>
<a name="ln-708"></a>            <span class="n">Tau32</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S32</span><span class="p">)</span>
<a name="ln-709"></a>            <span class="n">Tau33</span> <span class="o">=</span> <span class="n">mu_t</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">S33</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">delv</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="n">tk</span>
<a name="ln-710"></a>
<a name="ln-711"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-712"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">P_k</span> <span class="o">+</span> <span class="n">Tau11</span><span class="o">*</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau12</span><span class="o">*</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau13</span><span class="o">*</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-713"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">P_k</span> <span class="o">+</span> <span class="n">Tau21</span><span class="o">*</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau22</span><span class="o">*</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau23</span><span class="o">*</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-714"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="n">P_k</span> <span class="o">+</span> <span class="n">Tau31</span><span class="o">*</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau32</span><span class="o">*</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">Tau33</span><span class="o">*</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-715"></a>            <span class="n">D_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmu</span><span class="o">**</span><span class="mf">0.75</span><span class="p">)</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="p">(</span><span class="n">tk</span><span class="o">**</span><span class="mf">2.5</span><span class="p">)</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">tkl</span><span class="p">,</span><span class="mf">1.e-20</span><span class="p">)</span>
<a name="ln-716"></a>            <span class="n">P_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">P_k</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">D_k</span><span class="p">)</span>
<a name="ln-717"></a>
<a name="ln-718"></a>            <span class="c">! calculation of Lvk</span>
<a name="ln-719"></a>            <span class="c">! first get second order gradients </span>
<a name="ln-720"></a>            <span class="n">d2udx2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-721"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-722"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-723"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-724"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-725"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-726"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-727"></a>
<a name="ln-728"></a>            <span class="n">d2udy2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-729"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-730"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-731"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-732"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-733"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-734"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-735"></a>
<a name="ln-736"></a>            <span class="n">d2udz2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-737"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-738"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-739"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-740"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-741"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-742"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-743"></a>
<a name="ln-744"></a>            <span class="c">! gradient of v component</span>
<a name="ln-745"></a>            <span class="n">d2vdx2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-746"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-747"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-748"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-749"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-750"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-751"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-752"></a>
<a name="ln-753"></a>            <span class="n">d2vdy2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-754"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-755"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-756"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-757"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-758"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-759"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-760"></a>
<a name="ln-761"></a>            <span class="n">d2vdz2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-762"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-763"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-764"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-765"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-766"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-767"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-768"></a>
<a name="ln-769"></a>
<a name="ln-770"></a>            <span class="c">!gradients of w components</span>
<a name="ln-771"></a>            <span class="n">d2wdx2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-772"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-773"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-774"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-775"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-776"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-777"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-778"></a>
<a name="ln-779"></a>            <span class="n">d2wdy2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-780"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-781"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-782"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-783"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-784"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-785"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-786"></a>
<a name="ln-787"></a>            <span class="n">d2wdz2</span> <span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-788"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-789"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-790"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-791"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-792"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">gradw_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span><span class="o">*</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span> <span class="p">&amp;</span>
<a name="ln-793"></a>                    <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-794"></a>
<a name="ln-795"></a>            <span class="n">udd</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">d2udx2</span><span class="o">+</span><span class="n">d2udy2</span><span class="o">+</span><span class="n">d2udz2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-796"></a>                      <span class="o">+</span> <span class="p">(</span><span class="n">d2vdx2</span><span class="o">+</span><span class="n">d2vdy2</span><span class="o">+</span><span class="n">d2vdz2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-797"></a>                      <span class="o">+</span> <span class="p">(</span><span class="n">d2wdx2</span><span class="o">+</span><span class="n">d2wdy2</span><span class="o">+</span><span class="n">d2wdz2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
<a name="ln-798"></a>
<a name="ln-799"></a>            <span class="n">ud</span>  <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">s11</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s12</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s13</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-800"></a>                         <span class="o">+</span><span class="n">s21</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s22</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s23</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-801"></a>                         <span class="o">+</span><span class="n">s31</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s32</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">s33</span><span class="o">**</span><span class="mi">2</span> <span class="p">))</span>
<a name="ln-802"></a>
<a name="ln-803"></a>            <span class="n">Lvk</span> <span class="o">=</span> <span class="n">kappa</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">ud</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">udd</span><span class="p">,</span><span class="mf">1.e-20</span><span class="p">))</span>
<a name="ln-804"></a>
<a name="ln-805"></a>            <span class="n">fp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">P_k</span><span class="o">/</span><span class="n">D_k</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span><span class="mf">1.0</span><span class="p">)</span>
<a name="ln-806"></a>            <span class="c">! Lvk limiter</span>
<a name="ln-807"></a>            <span class="n">Lvk</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Lvk</span><span class="p">,</span> <span class="n">tkl</span><span class="o">/</span><span class="nb">max</span><span class="p">((</span><span class="n">tk</span><span class="o">*</span><span class="n">c11</span><span class="p">),</span><span class="mf">1.e-20</span><span class="p">))</span>
<a name="ln-808"></a>            <span class="n">Lvk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Lvk</span><span class="p">,</span> <span class="n">c12</span><span class="o">*</span><span class="n">kappa</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<a name="ln-809"></a>
<a name="ln-810"></a>            <span class="n">eta</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">0.3</span><span class="o">*</span><span class="n">tk</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">20</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-811"></a>            <span class="n">fphi</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cd1</span><span class="o">*</span><span class="n">eta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">eta</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-812"></a>            <span class="n">cphi2</span> <span class="o">=</span> <span class="n">zeta3</span>
<a name="ln-813"></a>            <span class="n">cphi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">zeta1</span> <span class="o">-</span> <span class="n">zeta2</span><span class="o">*</span><span class="p">((</span><span class="n">tkl</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">tk</span><span class="o">*</span><span class="n">Lvk</span><span class="p">,</span><span class="mf">1.e-20</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-814"></a>
<a name="ln-815"></a>            <span class="n">P_kl</span> <span class="o">=</span> <span class="n">cphi1</span><span class="o">*</span><span class="n">tkl</span><span class="o">*</span><span class="n">P_k</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">tk</span><span class="p">,</span><span class="mf">1.e-20</span><span class="p">)</span>
<a name="ln-816"></a>            <span class="n">D_kl</span> <span class="o">=</span> <span class="n">cphi2</span><span class="o">*</span><span class="n">density</span><span class="o">*</span><span class="p">(</span><span class="n">tk</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>
<a name="ln-817"></a>
<a name="ln-818"></a>
<a name="ln-819"></a>            <span class="n">S_k</span>  <span class="o">=</span> <span class="n">P_k</span>  <span class="o">-</span> <span class="n">D_k</span>  <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tk</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>       <span class="c">!Source term TKE</span>
<a name="ln-820"></a>            <span class="n">S_kl</span> <span class="o">=</span> <span class="n">P_kl</span> <span class="o">-</span> <span class="n">D_kl</span> <span class="o">-</span> <span class="mi">6</span><span class="o">*</span><span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tkl</span><span class="o">*</span><span class="n">fphi</span><span class="o">/</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c">!source term KL</span>
<a name="ln-821"></a>
<a name="ln-822"></a>            <span class="n">S_k</span>  <span class="o">=</span> <span class="n">S_k</span>  <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-823"></a>            <span class="n">S_kl</span> <span class="o">=</span> <span class="n">S_kl</span> <span class="o">*</span> <span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-824"></a>
<a name="ln-825"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_k</span>
<a name="ln-826"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_kl</span>
<a name="ln-827"></a>
<a name="ln-828"></a>          <span class="k">end do</span>
<a name="ln-829"></a><span class="k">        end do</span>
<a name="ln-830"></a><span class="k">      end do</span>
<a name="ln-831"></a>
<a name="ln-832"></a><span class="k">    end subroutine </span><span class="n">add_kkl_source</span>
<a name="ln-833"></a>
<a name="ln-834"></a>
<a name="ln-835"></a>    <span class="k">subroutine </span><span class="n">add_sa_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-836"></a>      <span class="c">!&lt; Add residual due to source terms of SA turbulence model</span>
<a name="ln-837"></a>      <span class="k">implicit none</span>
<a name="ln-838"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-839"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-840"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-841"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-842"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-843"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-844"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-845"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-846"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-847"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-848"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-849"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-850"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-851"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-852"></a>
<a name="ln-853"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD1</span>
<a name="ln-854"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD2</span>
<a name="ln-855"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv1</span>
<a name="ln-856"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv2</span>
<a name="ln-857"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fw</span>
<a name="ln-858"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g</span>
<a name="ln-859"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Scap</span>
<a name="ln-860"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">r</span>
<a name="ln-861"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vort</span>
<a name="ln-862"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_v</span>
<a name="ln-863"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">D_v</span>
<a name="ln-864"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">P_v</span>
<a name="ln-865"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamda</span>
<a name="ln-866"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">kd2</span>
<a name="ln-867"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xi</span>
<a name="ln-868"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu</span>
<a name="ln-869"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_x</span>
<a name="ln-870"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_y</span>
<a name="ln-871"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_z</span>
<a name="ln-872"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RhoFace</span>
<a name="ln-873"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Area</span>
<a name="ln-874"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Normal</span>
<a name="ln-875"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-876"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tv</span>
<a name="ln-877"></a>
<a name="ln-878"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-879"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-880"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-881"></a>
<a name="ln-882"></a>            <span class="n">density</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-883"></a>            <span class="n">tv</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-884"></a>
<a name="ln-885"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-886"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-887"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-888"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-889"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-890"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-891"></a>
<a name="ln-892"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-893"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-894"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-895"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span>
<a name="ln-896"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span>
<a name="ln-897"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-898"></a>
<a name="ln-899"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-900"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-901"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">/</span><span class="p">)</span>
<a name="ln-902"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-903"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-904"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-905"></a>
<a name="ln-906"></a>            <span class="n">gradrho_x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-907"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-908"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-909"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-910"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-911"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-912"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-913"></a>
<a name="ln-914"></a>            <span class="n">gradrho_y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-915"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-916"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-917"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-918"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-919"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-920"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-921"></a>
<a name="ln-922"></a>            <span class="n">gradrho_z</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-923"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-924"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-925"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-926"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-927"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-928"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-929"></a>
<a name="ln-930"></a>
<a name="ln-931"></a>            <span class="c">! __ vorticity __</span>
<a name="ln-932"></a>            <span class="n">vort</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>  <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-933"></a>                         <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-934"></a>                         <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-935"></a>                          <span class="p">)&amp;</span>
<a name="ln-936"></a>                       <span class="p">)</span>
<a name="ln-937"></a>
<a name="ln-938"></a>            <span class="c">! ___ cross diffusion ___</span>
<a name="ln-939"></a>            <span class="n">CD1</span> <span class="o">=</span> <span class="n">cb2</span><span class="o">*</span><span class="p">((</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-940"></a>                    <span class="o">+</span>  <span class="p">(</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-941"></a>                    <span class="o">+</span>  <span class="p">(</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-942"></a>                     <span class="p">)</span>
<a name="ln-943"></a>
<a name="ln-944"></a>            <span class="c">! ___ addition cross diffusion result conservative form of tv ___</span>
<a name="ln-945"></a>            <span class="n">CD2</span> <span class="o">=</span>    <span class="p">((</span><span class="n">gradrho_x</span><span class="o">*</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-946"></a>                    <span class="o">+</span> <span class="p">(</span><span class="n">gradrho_y</span><span class="o">*</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-947"></a>                    <span class="o">+</span> <span class="p">(</span><span class="n">gradrho_z</span><span class="o">*</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-948"></a>                     <span class="p">)</span>
<a name="ln-949"></a>
<a name="ln-950"></a>            <span class="n">kd2</span>  <span class="o">=</span> <span class="p">(</span><span class="n">kappa_sa</span><span class="o">*</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-951"></a>            <span class="n">nu</span>   <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">density</span>
<a name="ln-952"></a>            <span class="n">xi</span>   <span class="o">=</span> <span class="n">tv</span><span class="o">/</span><span class="n">nu</span>
<a name="ln-953"></a>
<a name="ln-954"></a>            <span class="c">! ___ functions ___</span>
<a name="ln-955"></a>            <span class="n">fv1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">xi</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv1</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-956"></a>            <span class="n">fv2</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">xi</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">xi</span><span class="o">*</span><span class="n">fv1</span><span class="p">))</span>
<a name="ln-957"></a>
<a name="ln-958"></a>            <span class="c">! ___ Shear stress for production ___</span>
<a name="ln-959"></a>            <span class="n">scap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">vort</span> <span class="o">+</span> <span class="p">(</span><span class="n">tv</span><span class="o">*</span><span class="n">fv2</span><span class="o">/</span><span class="p">(</span><span class="n">kd2</span><span class="p">)),</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">vort</span><span class="p">)</span>
<a name="ln-960"></a>
<a name="ln-961"></a>            <span class="c">! ___ wall function ___</span>
<a name="ln-962"></a>            <span class="n">r</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tv</span><span class="o">/</span><span class="p">(</span><span class="n">Scap</span><span class="o">*</span><span class="n">kd2</span><span class="p">),</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-963"></a>            <span class="n">g</span>    <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">cw2</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
<a name="ln-964"></a>            <span class="n">fw</span>   <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="p">(</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="p">(</span><span class="n">cw3</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="n">g</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">cw3</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span>
<a name="ln-965"></a>
<a name="ln-966"></a>            <span class="c">! ____ Dissipation term ___</span>
<a name="ln-967"></a>            <span class="n">D_v</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">cw1</span><span class="o">*</span><span class="n">fw</span><span class="o">*</span><span class="p">((</span><span class="n">tv</span><span class="o">/</span><span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-968"></a>
<a name="ln-969"></a>            <span class="c">! ____ PRODUCTION term____</span>
<a name="ln-970"></a>            <span class="n">P_v</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">cb1</span><span class="o">*</span><span class="n">Scap</span><span class="o">*</span><span class="n">tv</span>
<a name="ln-971"></a>
<a name="ln-972"></a>            <span class="c">! ____ cross diffusion term ___</span>
<a name="ln-973"></a>            <span class="n">lamda</span> <span class="o">=</span> <span class="n">density</span><span class="o">*</span><span class="n">CD1</span><span class="o">/</span><span class="n">sigma_sa</span> <span class="o">-</span> <span class="n">CD2</span><span class="o">*</span><span class="p">(</span><span class="n">nu</span><span class="o">+</span><span class="n">tv</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_sa</span>
<a name="ln-974"></a>
<a name="ln-975"></a>            <span class="n">S_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">P_v</span> <span class="o">-</span> <span class="n">D_v</span>  <span class="o">+</span> <span class="n">lamda</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-976"></a>
<a name="ln-977"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>   <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_v</span>
<a name="ln-978"></a>
<a name="ln-979"></a>          <span class="k">end do</span>
<a name="ln-980"></a><span class="k">        end do</span>
<a name="ln-981"></a><span class="k">      end do</span>
<a name="ln-982"></a>
<a name="ln-983"></a><span class="k">    end subroutine </span><span class="n">add_sa_source</span>
<a name="ln-984"></a>
<a name="ln-985"></a>    <span class="k">subroutine </span><span class="n">add_saBC_source</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">Ifaces</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
<a name="ln-986"></a>      <span class="c">!&lt; Add residual due to source terms of SABC transition model</span>
<a name="ln-987"></a>      <span class="k">implicit none</span>
<a name="ln-988"></a><span class="k">      type</span><span class="p">(</span><span class="n">extent</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dims</span>
<a name="ln-989"></a>      <span class="c">!&lt; Extent of the domain:imx,jmx,kmx</span>
<a name="ln-990"></a>      <span class="k">type</span><span class="p">(</span><span class="n">flowtype</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">flow</span>
<a name="ln-991"></a>      <span class="c">!&lt; Information about fluid flow: freestream-speed, ref-viscosity,etc.</span>
<a name="ln-992"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">n_var</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">qp</span>
<a name="ln-993"></a>      <span class="c">!&lt; Store primitive variable at cell center</span>
<a name="ln-994"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">residue</span>
<a name="ln-995"></a>      <span class="c">!&lt; Store residue at each cell-center</span>
<a name="ln-996"></a>      <span class="k">type</span><span class="p">(</span><span class="n">celltype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">cells</span>
<a name="ln-997"></a>      <span class="c">!&lt; Input cell quantities: volume</span>
<a name="ln-998"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ifaces</span>
<a name="ln-999"></a>      <span class="c">!&lt; Input varaible which stores I faces&#39; area and unit normal</span>
<a name="ln-1000"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Jfaces</span>
<a name="ln-1001"></a>      <span class="c">!&lt; Input varaible which stores J faces&#39; area and unit normal</span>
<a name="ln-1002"></a>      <span class="k">type</span><span class="p">(</span><span class="n">facetype</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Kfaces</span>
<a name="ln-1003"></a>      <span class="c">!&lt; Input varaible which stores K faces&#39; area and unit normal</span>
<a name="ln-1004"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-1005"></a>
<a name="ln-1006"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD1</span>
<a name="ln-1007"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">CD2</span>
<a name="ln-1008"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv1</span>
<a name="ln-1009"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fv2</span>
<a name="ln-1010"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">fw</span>
<a name="ln-1011"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g</span>
<a name="ln-1012"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">r</span>
<a name="ln-1013"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S_v</span>
<a name="ln-1014"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">lamda</span>
<a name="ln-1015"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dist_i</span>
<a name="ln-1016"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dist_i_2</span>
<a name="ln-1017"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji</span>
<a name="ln-1018"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji_2</span>
<a name="ln-1019"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Ji_3</span>
<a name="ln-1020"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">S</span>
<a name="ln-1021"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Omega</span>
<a name="ln-1022"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k2</span>
<a name="ln-1023"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inv_k2_d2</span>
<a name="ln-1024"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Shat</span>
<a name="ln-1025"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">inv_Shat</span>
<a name="ln-1026"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu</span>
<a name="ln-1027"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_x</span>
<a name="ln-1028"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_y</span>
<a name="ln-1029"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gradrho_z</span>
<a name="ln-1030"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">RhoFace</span>
<a name="ln-1031"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Area</span>
<a name="ln-1032"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Normal</span>
<a name="ln-1033"></a>      <span class="c">! transition modeling variables</span>
<a name="ln-1034"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chi_1</span><span class="o">=</span><span class="mf">0.002</span>
<a name="ln-1035"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">chi_2</span><span class="o">=</span><span class="mf">5.0</span>
<a name="ln-1036"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_BC</span>
<a name="ln-1037"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_cr</span>
<a name="ln-1038"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nu_t</span>
<a name="ln-1039"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span>
<a name="ln-1040"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">glim</span>
<a name="ln-1041"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g_6</span>
<a name="ln-1042"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vmag</span>
<a name="ln-1043"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Production</span>
<a name="ln-1044"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Destruction</span>
<a name="ln-1045"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_v</span>
<a name="ln-1046"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_theta</span>
<a name="ln-1047"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">re_theta_t</span>
<a name="ln-1048"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term1</span>
<a name="ln-1049"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term2</span>
<a name="ln-1050"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">term_exponential</span>
<a name="ln-1051"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">gamma_BC</span>
<a name="ln-1052"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tu</span>
<a name="ln-1053"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tv</span>
<a name="ln-1054"></a>      <span class="kt">real</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="kd">::</span> <span class="n">density</span>
<a name="ln-1055"></a>
<a name="ln-1056"></a>      <span class="n">tu</span> <span class="o">=</span> <span class="n">flow</span><span class="p">%</span><span class="n">tu_inf</span>
<a name="ln-1057"></a>
<a name="ln-1058"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">kmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1059"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">jmx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1060"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">dims</span><span class="p">%</span><span class="n">imx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1061"></a>
<a name="ln-1062"></a>            <span class="c">!Local_vel_mag</span>
<a name="ln-1063"></a>            <span class="n">density</span><span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1064"></a>            <span class="n">u</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1065"></a>            <span class="n">v</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1066"></a>            <span class="n">w</span>      <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1067"></a>            <span class="n">tv</span>     <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1068"></a>            <span class="n">vmag</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">u</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">v</span> <span class="o">+</span> <span class="n">w</span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
<a name="ln-1069"></a>
<a name="ln-1070"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1071"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1072"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1073"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1074"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1075"></a>            <span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">qp</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">density</span>
<a name="ln-1076"></a>
<a name="ln-1077"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1078"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1079"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1080"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span>
<a name="ln-1081"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span>  <span class="p">)%</span><span class="n">A</span>
<a name="ln-1082"></a>            <span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">A</span>
<a name="ln-1083"></a>
<a name="ln-1084"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1085"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1086"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1087"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Ifaces</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span>  <span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1088"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Jfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1089"></a>            <span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nx</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">ny</span><span class="p">,</span><span class="n">Kfaces</span><span class="p">(</span><span class="n">i</span>  <span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">nz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1090"></a>
<a name="ln-1091"></a>            <span class="n">gradrho_x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1092"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1093"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1094"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1095"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1096"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1097"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1098"></a>
<a name="ln-1099"></a>            <span class="n">gradrho_y</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1100"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1101"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1102"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1103"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1104"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1105"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1106"></a>
<a name="ln-1107"></a>            <span class="n">gradrho_z</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1108"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1109"></a>                         <span class="o">-</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1110"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1111"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1112"></a>                         <span class="o">+</span><span class="p">(</span><span class="n">RhoFace</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="n">Normal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">Area</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1113"></a>                        <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1114"></a>
<a name="ln-1115"></a>
<a name="ln-1116"></a>            <span class="c">! __ vorticity __</span>
<a name="ln-1117"></a>            <span class="n">Omega</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span>  <span class="p">((</span><span class="n">gradw_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1118"></a>                         <span class="o">+</span> <span class="p">(</span><span class="n">gradu_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradw_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1119"></a>                         <span class="o">+</span> <span class="p">(</span><span class="n">gradv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span> <span class="n">gradu_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-1120"></a>                          <span class="p">)&amp;</span>
<a name="ln-1121"></a>                       <span class="p">)</span>
<a name="ln-1122"></a>
<a name="ln-1123"></a>            <span class="c">! ___ cross diffusion ___</span>
<a name="ln-1124"></a>            <span class="n">CD1</span> <span class="o">=</span> <span class="n">cb2</span><span class="o">*</span><span class="p">((</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1125"></a>                    <span class="o">+</span>  <span class="p">(</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1126"></a>                    <span class="o">+</span>  <span class="p">(</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1127"></a>                     <span class="p">)</span>
<a name="ln-1128"></a>
<a name="ln-1129"></a>            <span class="c">! ___ addition cross diffusion result conservative form of tv ___</span>
<a name="ln-1130"></a>            <span class="n">CD2</span> <span class="o">=</span>    <span class="p">((</span><span class="n">gradrho_x</span><span class="o">*</span><span class="n">gradtv_x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1131"></a>                    <span class="o">+</span> <span class="p">(</span><span class="n">gradrho_y</span><span class="o">*</span><span class="n">gradtv_y</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1132"></a>                    <span class="o">+</span> <span class="p">(</span><span class="n">gradrho_z</span><span class="o">*</span><span class="n">gradtv_z</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))&amp;</span>
<a name="ln-1133"></a>                     <span class="p">)</span>
<a name="ln-1134"></a>
<a name="ln-1135"></a>            <span class="n">dist_i</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1136"></a>            <span class="n">dist_i_2</span> <span class="o">=</span> <span class="n">dist_i</span><span class="o">*</span><span class="n">dist_i</span>
<a name="ln-1137"></a>            <span class="n">k2</span> <span class="o">=</span> <span class="n">kappa_sa</span><span class="o">*</span><span class="n">kappa_sa</span>
<a name="ln-1138"></a>            <span class="n">nu</span>   <span class="o">=</span> <span class="n">mu</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">density</span>
<a name="ln-1139"></a>            <span class="n">Ji</span>   <span class="o">=</span> <span class="n">tv</span><span class="o">/</span><span class="n">nu</span>
<a name="ln-1140"></a>            <span class="n">Ji_2</span> <span class="o">=</span> <span class="n">Ji</span><span class="o">*</span><span class="n">Ji</span>
<a name="ln-1141"></a>            <span class="n">Ji_3</span> <span class="o">=</span> <span class="n">Ji_2</span><span class="o">*</span><span class="n">ji</span>
<a name="ln-1142"></a>
<a name="ln-1143"></a>
<a name="ln-1144"></a>            <span class="c">! ___ functions ___</span>
<a name="ln-1145"></a>            <span class="n">fv1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">Ji_3</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">Ji_3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cv1_3</span><span class="p">))</span>
<a name="ln-1146"></a>            <span class="n">fv2</span>  <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">Ji</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Ji</span><span class="o">*</span><span class="n">fv1</span><span class="p">))</span>
<a name="ln-1147"></a>
<a name="ln-1148"></a>            <span class="c">! ___ Shear stress for production ___</span>
<a name="ln-1149"></a>            <span class="n">S</span> <span class="o">=</span> <span class="n">Omega</span>
<a name="ln-1150"></a>            <span class="n">inv_k2_d2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">k2</span><span class="o">*</span><span class="n">dist_i_2</span><span class="p">)</span>
<a name="ln-1151"></a>            <span class="n">Shat</span>      <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">tv</span><span class="o">*</span><span class="n">fv2</span><span class="o">*</span><span class="n">inv_k2_d2</span>
<a name="ln-1152"></a>            <span class="n">Shat</span>      <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Shat</span><span class="p">,</span> <span class="mf">1.0e-10</span><span class="p">)</span>
<a name="ln-1153"></a>            <span class="n">inv_Shat</span>  <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Shat</span>
<a name="ln-1154"></a>
<a name="ln-1155"></a>            <span class="c">! ____ PRODUCTION term____</span>
<a name="ln-1156"></a>            <span class="n">chi_1</span> <span class="o">=</span> <span class="mf">0.002</span>
<a name="ln-1157"></a>            <span class="n">chi_2</span> <span class="o">=</span> <span class="mf">5.0</span>
<a name="ln-1158"></a>
<a name="ln-1159"></a>            <span class="n">nu_t</span> <span class="o">=</span> <span class="n">tv</span><span class="o">*</span><span class="n">fv1</span>
<a name="ln-1160"></a>            <span class="n">nu_cr</span> <span class="o">=</span> <span class="n">chi_2</span><span class="o">/</span><span class="n">flow</span><span class="p">%</span><span class="n">Reynolds_number</span>
<a name="ln-1161"></a>            <span class="n">nu_bc</span> <span class="o">=</span> <span class="n">nu_t</span><span class="o">/</span><span class="p">(</span><span class="n">vmag</span><span class="o">*</span><span class="n">dist_i</span><span class="p">)</span>
<a name="ln-1162"></a>
<a name="ln-1163"></a>            <span class="n">re_v</span> <span class="o">=</span> <span class="n">dist_i_2</span><span class="o">*</span><span class="n">Omega</span><span class="o">/</span><span class="n">nu</span>
<a name="ln-1164"></a>            <span class="n">re_theta</span> <span class="o">=</span> <span class="n">re_v</span><span class="o">/</span><span class="mf">2.193</span>
<a name="ln-1165"></a>            <span class="n">re_theta_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80</span><span class="mf">3.73</span><span class="o">*</span><span class="p">((</span><span class="n">tu</span><span class="o">+</span><span class="mf">0.6067</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.027</span><span class="p">)))</span>
<a name="ln-1166"></a>            <span class="c">!re_theta_t = 163.0 + exp(6.91-0.18)</span>
<a name="ln-1167"></a>
<a name="ln-1168"></a>
<a name="ln-1169"></a>            <span class="n">term1</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">re_theta</span><span class="o">-</span><span class="n">re_theta_t</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">chi_1</span><span class="o">*</span><span class="n">re_theta_t</span><span class="p">))</span>
<a name="ln-1170"></a>            <span class="n">term2</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nu_BC</span><span class="o">-</span><span class="n">nu_cr</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span><span class="o">/</span><span class="n">nu_cr</span><span class="p">)</span>
<a name="ln-1171"></a>            <span class="n">term_exponential</span> <span class="o">=</span> <span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>
<a name="ln-1172"></a>            <span class="n">gamma_BC</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">exp</span><span class="p">(</span><span class="o">-</span><span class="n">term_exponential</span><span class="p">)</span>
<a name="ln-1173"></a>
<a name="ln-1174"></a>            <span class="n">Production</span> <span class="o">=</span> <span class="n">gamma_BC</span><span class="o">*</span><span class="n">cb1</span><span class="o">*</span><span class="n">Shat</span><span class="o">*</span><span class="n">tv</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-1175"></a>
<a name="ln-1176"></a>            <span class="c">! ___ Destruction term___ !</span>
<a name="ln-1177"></a>            <span class="n">r</span>    <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">tv</span><span class="o">*</span><span class="n">inv_Shat</span><span class="o">*</span><span class="n">inv_k2_d2</span><span class="p">,</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1178"></a>            <span class="n">g</span>    <span class="o">=</span> <span class="n">r</span> <span class="o">+</span> <span class="n">cw2</span><span class="o">*</span><span class="p">((</span><span class="n">r</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
<a name="ln-1179"></a>            <span class="n">g_6</span>  <span class="o">=</span> <span class="n">g</span><span class="o">**</span><span class="mi">6</span>
<a name="ln-1180"></a>            <span class="n">glim</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.0</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">g_6</span><span class="o">+</span><span class="n">cw3_6</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span>
<a name="ln-1181"></a>            <span class="n">fw</span>   <span class="o">=</span> <span class="n">g</span><span class="o">*</span><span class="n">glim</span>
<a name="ln-1182"></a>            <span class="n">Destruction</span> <span class="o">=</span> <span class="p">(</span><span class="n">cw1</span><span class="o">*</span><span class="n">fw</span><span class="o">*</span><span class="n">tv</span><span class="o">*</span><span class="n">tv</span><span class="o">/</span><span class="n">dist_i_2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-1183"></a>
<a name="ln-1184"></a>            <span class="c">! ____ cross diffusion term ___</span>
<a name="ln-1185"></a>            <span class="n">lamda</span> <span class="o">=</span> <span class="p">(</span><span class="n">density</span><span class="o">*</span><span class="n">CD1</span><span class="o">/</span><span class="n">sigma_sa</span> <span class="o">-</span> <span class="n">CD2</span><span class="o">*</span><span class="p">(</span><span class="n">nu</span><span class="o">+</span><span class="n">tv</span><span class="p">)</span><span class="o">/</span><span class="n">sigma_sa</span><span class="p">)</span><span class="o">*</span><span class="n">cells</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)%</span><span class="n">volume</span>
<a name="ln-1186"></a>
<a name="ln-1187"></a>            <span class="n">S_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">Production</span> <span class="o">-</span> <span class="n">Destruction</span>  <span class="o">+</span> <span class="n">lamda</span><span class="p">)</span>
<a name="ln-1188"></a>            <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>   <span class="o">=</span> <span class="n">residue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_v</span>
<a name="ln-1189"></a>
<a name="ln-1190"></a>          <span class="k">end do</span>
<a name="ln-1191"></a><span class="k">        end do</span>
<a name="ln-1192"></a><span class="k">      end do</span>
<a name="ln-1193"></a>
<a name="ln-1194"></a><span class="k">    end subroutine </span><span class="n">add_saBC_source</span>
<a name="ln-1195"></a>
<a name="ln-1196"></a>
<a name="ln-1197"></a><span class="k">end module </span><span class="n">source</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2019 <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
             on 2019-12-28T21:23:55.181614 
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> FEST-3D was developed by FEST-3D Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>